<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üçì Êïë‰∏ñ‰∏ªÁöÑÊó•Â∏∏ÁîüÊ¥ª - FGOÂêå‰∫∫Ê∏∏Êàè v4.0</title>

    <!-- PWAÈÖçÁΩÆ -->
   <link rel="manifest" href="/fgo-daily/manifest.json">
    <meta name="theme-color" content="#e91e63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FGOÊó•Â∏∏">

    <style>
        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --secondary: #ff6b9d;
            --accent: #ffd54f;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text: #fff;
            --text-dim: #aaa;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --r18: #ff1744;
            --mana: #2196f3;
            --stamina: #4caf50;
            --mood: #ffeb3b;
            --lewd: #e91e63;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark), #0d0d1a);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ===== È°∂ÈÉ®Áä∂ÊÄÅÊ†è ===== */
        .top-bar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .player-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar:hover { transform: scale(1.05); }

        .player-info .name { font-weight: bold; font-size: 14px; }
        .player-info .title { font-size: 11px; opacity: 0.9; }

        .currency-bar {
            display: flex;
            gap: 8px;
        }

        .currency {
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .r18-badge {
            background: var(--r18);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== Â±ûÊÄßÊù° ===== */
        .stats-bar {
            background: var(--bg-card);
            padding: 10px 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-icon { font-size: 16px; }

        .stat-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stat-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .stat-fill.mana { background: var(--mana); }
        .stat-fill.stamina { background: var(--stamina); }
        .stat-fill.mood { background: var(--mood); }
        .stat-fill.lewd { background: var(--lewd); }

        .stat-value {
            font-size: 10px;
            margin-top: 2px;
            color: var(--text-dim);
        }

        /* ===== Â≠¶ÁßëÂ±ûÊÄßÊ†è ===== */
        .subject-bar {
            background: var(--bg-card);
            padding: 8px 16px;
            display: flex;
            gap: 6px;
            overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .subject-item {
            background: var(--bg-light);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .subject-value {
            color: var(--accent);
            font-weight: bold;
        }

        /* ===== Êó∂Èó¥Â§©Ê∞îÊ†è ===== */
        .time-bar {
            background: var(--bg-card);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .time-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date { font-size: 13px; }

        .period {
            background: var(--accent);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .weekday {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .weather {
            font-size: 18px;
        }

        .time-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .time-btn:hover { background: var(--primary-dark); }

        /* ===== ‰æßËæπÊ†è ===== */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100%;
            background: var(--bg-card);
            z-index: 500;
            transition: left 0.3s;
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0,0,0,0.5);
        }

        .sidebar.open { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 499;
            display: none;
        }

        .sidebar-overlay.show { display: block; }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 20px 16px;
            text-align: center;
        }

        .sidebar-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid white;
        }

        .sidebar-name { font-weight: bold; font-size: 16px; }
        .sidebar-title { font-size: 12px; opacity: 0.9; }

        .sidebar-menu {
            padding: 10px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .menu-item:hover { background: var(--bg-light); }
        .menu-item.active { background: var(--primary); }

        .menu-icon { font-size: 18px; width: 24px; text-align: center; }

        .menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
        }

        /* ===== ‰∏ªÂÜÖÂÆπÂå∫ ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 70px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s;
        }

        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Âú∞ÂõæÈ°µÈù¢ ===== */
        .map-container {
            padding: 16px;
        }

        .location-title {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .location-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .location-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .location-card.current {
            border-color: var(--accent);
        }

        .location-icon { font-size: 32px; margin-bottom: 8px; }
        .location-name { font-size: 13px; font-weight: bold; }
        .location-desc { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

        /* ===== Âú∫ÊôØËØ¶ÊÉÖÈ°µ ===== */
        .scene-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 200;
            overflow-y: auto;
        }

        .scene-page.active { display: block; }

        .scene-header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-light));
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .scene-back {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .scene-info { flex: 1; }
        .scene-name { font-weight: bold; font-size: 16px; }
        .scene-sub { font-size: 12px; color: var(--text-dim); }

        .scene-content { padding: 16px; }

        .sub-location-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .sub-location {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-location:hover { 
            background: var(--bg-light);
            transform: translateY(-2px);
        }

        .sub-location-icon { font-size: 24px; margin-bottom: 4px; }
        .sub-location-name { font-size: 11px; }

        /* ===== ‰∫ã‰ª∂ÂºπÁ™ó ===== */
        .event-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 600;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .event-modal.active { display: flex; }

        .event-box {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .event-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 16px;
            text-align: center;
        }

        .event-header.r18 {
            background: linear-gradient(135deg, var(--r18), #ff6b6b);
        }

        .event-header.ssr {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            animation: glow 1s infinite alternate;
        }

        .event-header.encounter {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
        }

        @keyframes glow {
            from { box-shadow: 0 0 20px #ffd700; }
            to { box-shadow: 0 0 40px #ffd700; }
        }

        .event-icon { font-size: 40px; margin-bottom: 8px; }
        .event-title { font-size: 16px; font-weight: bold; }
        .event-sub { font-size: 12px; opacity: 0.9; margin-top: 4px; }

        .event-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .event-story {
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .event-story.loading::after {
            content: '‚ñå';
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .event-choices {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        .event-choice {
            background: var(--bg-light);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: background 0.2s;
        }

        .event-choice:hover { background: var(--primary); }

        .event-stats {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
        }

        .event-stats-title {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .event-stats-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .stat-change {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .stat-change.positive { background: rgba(76, 175, 80, 0.3); color: var(--success); }
        .stat-change.negative { background: rgba(244, 67, 54, 0.3); color: var(--danger); }

        .event-footer {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }

        .event-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .event-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .event-btn.end { background: var(--success); color: white; }
        .event-btn.continue { background: var(--primary); color: white; }

        /* ===== ÊâãÊú∫ÁïåÈù¢ ===== */
        .phone-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 340px;
            height: 600px;
            background: #1a1a1a;
            border-radius: 30px;
            z-index: 400;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 3px solid #333;
        }

        .phone-container.active { display: block; }

        .phone-notch {
            width: 100px;
            height: 20px;
            background: #1a1a1a;
            border-radius: 0 0 15px 15px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .phone-screen {
            height: calc(100% - 20px);
            background: var(--bg-dark);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .phone-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phone-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .phone-title {
            flex: 1;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .phone-tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .phone-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .phone-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .phone-content {
            flex: 1;
            overflow-y: auto;
        }

        /* ËÅäÂ§©ÂàóË°® */
        .chat-list {
            padding: 8px;
        }

        .chat-group {
            margin-bottom: 12px;
        }

        .chat-group-title {
            font-size: 11px;
            color: var(--text-dim);
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover { background: var(--bg-card); }

        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-size: 13px; font-weight: bold; margin-bottom: 2px; }

        .chat-preview {
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta { text-align: right; }
        .chat-time { font-size: 10px; color: var(--text-dim); }

        /* ËÅäÂ§©ËØ¶ÊÉÖ */
        .chat-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-view.active { display: flex; }

        .chat-view-header {
            background: var(--bg-card);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-view-back {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .chat-view-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .chat-view-info { flex: 1; }
        .chat-view-name { font-size: 14px; font-weight: bold; }
        .chat-view-status { font-size: 10px; color: var(--text-dim); }

        .chat-view-actions {
            display: flex;
            gap: 8px;
        }

        .chat-action-btn {
            background: var(--bg-light);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
        }

        .chat-action-btn:hover { background: var(--primary); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            display: flex;
            gap: 8px;
            max-width: 80%;
            animation: msgIn 0.3s ease;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.self {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.system {
            align-self: center;
            max-width: 90%;
        }

        .msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .msg-content {
            background: var(--bg-card);
            padding: 8px 12px;
            border-radius: 12px;
            border-top-left-radius: 4px;
        }

        .message.self .msg-content {
            background: var(--primary);
            border-radius: 12px;
            border-top-right-radius: 4px;
        }

        .message.system .msg-content {
            background: var(--accent);
            color: #000;
            text-align: center;
        }

        .msg-text { font-size: 13px; line-height: 1.5; }
        .msg-time { font-size: 9px; color: var(--text-dim); margin-top: 4px; }

        .chat-input-area {
            padding: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-card);
            border: none;
            border-radius: 20px;
            padding: 10px 14px;
            color: white;
            font-size: 13px;
        }

        .chat-input:focus { outline: none; }

        .chat-send {
            background: var(--primary);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-send:hover { background: var(--primary-dark); }

        /* Á∫¶‰ºöÈù¢Êùø */
        .date-panel {
            padding: 12px;
        }

        .date-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .date-section-title {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .date-member {
            background: var(--bg-light);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .date-member.selected { 
            border-color: var(--primary);
            background: var(--primary);
        }

        .date-locations {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .date-location {
            background: var(--bg-light);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 11px;
            transition: all 0.2s;
        }

        .date-location.selected { 
            border-color: var(--primary);
            background: var(--primary);
        }

        .date-location-icon { font-size: 20px; margin-bottom: 4px; }

        .date-start-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .date-start-btn:hover { opacity: 0.9; }

        /* ===== ÂïÜÂ∫óÈ°µÈù¢ ===== */
        .shop-container { padding: 16px; }

        .shop-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .shop-tab {
            background: var(--bg-card);
            border: none;
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-tab.active { background: var(--primary); color: white; }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-item:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .shop-item.r18 { border: 1px solid var(--r18); }

        .shop-item-icon { font-size: 28px; margin-bottom: 8px; }
        .shop-item-name { font-size: 12px; margin-bottom: 6px; }

        .shop-item-price {
            font-size: 12px;
            color: var(--accent);
        }

        /* ===== ÊäΩÂç°È°µÈù¢ ===== */
        .gacha-container { padding: 16px; }

        .gacha-banner {
            background: linear-gradient(135deg, var(--primary), #9c27b0);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .gacha-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
        .gacha-desc { font-size: 13px; opacity: 0.9; margin-bottom: 16px; }

        .gacha-pity {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 16px;
        }

        .gacha-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .gacha-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gacha-btn:hover {
            transform: scale(1.05);
        }

        .gacha-result {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            display: none;
        }

        .gacha-result.active { display: block; }

        .gacha-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }

        .gacha-item {
            width: 60px;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .gacha-item.ssr {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            animation: glow 1s infinite alternate;
        }

        .gacha-item.sr { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); }
        .gacha-item.r { background: var(--bg-light); }

        .gacha-item-icon { font-size: 24px; }
        .gacha-item-name { font-size: 9px; margin-top: 4px; }

        /* ===== ÁâπÂºÇÁÇπÈ°µÈù¢ ===== */
        .singularity-container { padding: 16px; }

        .singularity-section {
            margin-bottom: 20px;
        }

        .singularity-title {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .singularity-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .singularity-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .singularity-card:hover { 
            background: var(--bg-light);
            transform: translateX(4px);
        }

        .singularity-card.custom {
            border: 1px dashed var(--primary);
        }

        .singularity-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .singularity-info { flex: 1; }
        .singularity-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .singularity-desc { font-size: 11px; color: var(--text-dim); }

        /* ===== ËÉåÂåÖÈ°µÈù¢ ===== */
        .inventory-container { padding: 16px; }

        .inventory-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .inventory-tab {
            background: var(--bg-card);
            border: none;
            color: var(--text-dim);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inventory-tab.active { background: var(--primary); color: white; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: var(--bg-card);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .inventory-slot:hover { 
            background: var(--bg-light);
            transform: scale(1.05);
        }

        .inventory-icon { font-size: 24px; }
        .inventory-name { font-size: 9px; margin-top: 4px; text-align: center; }

        .inventory-count {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 10px;
        }

        /* ===== ËßíËâ≤È°µÈù¢ ===== */
        .characters-container { padding: 16px; }

        .character-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .character-filter {
            background: var(--bg-card);
            border: none;
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .character-filter.active { background: var(--primary); color: white; }

        .add-character-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 16px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .character-card:hover { 
            background: var(--bg-light);
            transform: translateX(4px);
        }

        .character-card.custom {
            border: 1px dashed var(--accent);
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid;
        }

        .character-info { flex: 1; }
        .character-name { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .character-role { font-size: 11px; color: var(--text-dim); }

        .affection-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }

        .affection-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
            transition: width 0.3s;
        }

        .character-affection {
            font-size: 12px;
            color: var(--primary);
        }

        .character-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .char-action-btn {
            background: var(--bg-light);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
            cursor: pointer;
        }

        .char-action-btn:hover { background: var(--primary); }

        /* ===== ËÆæÁΩÆÈ°µÈù¢ ===== */
        .settings-container { padding: 16px; }

        .settings-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .setting-item:last-child { border-bottom: none; }

        .setting-label {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle {
            width: 46px;
            height: 26px;
            background: #444;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active { background: var(--primary); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle.active::after { left: 22px; }

        .form-group { margin-bottom: 12px; }

        .form-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 6px;
            display: block;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--bg-light);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 13px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn:hover { background: var(--primary-dark); }

        .btn-secondary {
            background: var(--bg-light);
        }

        .btn-secondary:hover { background: var(--bg-card); }

        /* ===== Â∫ïÈÉ®ÂØºËà™ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 8px;
            color: var(--text-dim);
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
        }

        .nav-item.active { color: var(--primary); }

        .nav-icon { font-size: 20px; }
        .nav-label { font-size: 10px; margin-top: 2px; }

        /* ===== Ê®°ÊÄÅÊ°ÜÂü∫Á°Ä ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-weight: bold; font-size: 15px; }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* ===== Toast ===== */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            font-size: 13px;
        }

        .toast.show {
            display: block;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* ===== ÂìçÂ∫îÂºè ===== */
        @media (max-width: 360px) {
            .location-grid { grid-template-columns: 1fr; }
            .shop-grid { grid-template-columns: 1fr; }
            .inventory-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
        <div class="top-bar">
            <div class="player-section">
                <div class="avatar" onclick="toggleSidebar()">üë©</div>
                <div class="player-info">
                    <div class="name" id="playerName">Ëó§‰∏∏Á´ãÈ¶ô</div>
                    <div class="title" id="playerTitle">È´ò‰∏≠‰∫åÂπ¥Á∫ß</div>
                </div>
            </div>
            <div class="currency-bar">
                <span id="r18Badge" class="r18-badge" style="display:none">R18</span>
                <div class="currency"><span>ü™ô</span><span id="qpDisplay">10000</span></div>
                <div class="currency"><span>üíé</span><span id="sqDisplay">30</span></div>
            </div>
        </div>

        <!-- Â±ûÊÄßÊù° -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-icon">üî∑</div>
                <div class="stat-bar"><div class="stat-fill mana" id="manaBar" style="width:100%"></div></div>
                <div class="stat-value" id="manaValue">100</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üíö</div>
                <div class="stat-bar"><div class="stat-fill stamina" id="staminaBar" style="width:100%"></div></div>
                <div class="stat-value" id="staminaValue">100</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üòä</div>
                <div class="stat-bar"><div class="stat-fill mood" id="moodBar" style="width:80%"></div></div>
                <div class="stat-value" id="moodValue">80</div>
            </div>
            <div class="stat-item" id="lewdStat" style="display:none">
                <div class="stat-icon">üíó</div>
                <div class="stat-bar"><div class="stat-fill lewd" id="lewdBar" style="width:0%"></div></div>
                <div class="stat-value" id="lewdValue">0</div>
            </div>
        </div>

        <!-- Â≠¶ÁßëÂ±ûÊÄßÊ†è -->
        <div class="subject-bar" id="subjectBar">
            <div class="subject-item">üìöËØ≠Êñá <span class="subject-value" id="subChinese">60</span></div>
            <div class="subject-item">üî¢Êï∞Â≠¶ <span class="subject-value" id="subMath">55</span></div>
            <div class="subject-item">üî¨ÁêÜÁªº <span class="subject-value" id="subScience">50</span></div>
            <div class="subject-item">üåçÊñáÁªº <span class="subject-value" id="subLiberal">58</span></div>
            <div class="subject-item">üá¨üáßËã±ËØ≠ <span class="subject-value" id="subEnglish">52</span></div>
            <div class="subject-item">‚ú®È≠îÊúØ <span class="subject-value" id="subMagic">70</span></div>
        </div>

        <!-- Êó∂Èó¥Â§©Ê∞îÊ†è -->
        <div class="time-bar">
            <div class="time-info">
                <span class="date" id="dateDisplay">4Êúà1Êó•</span>
                <span class="weekday" id="weekdayDisplay">Âë®‰∏Ä</span>
                <span class="period" id="periodDisplay">Êó©Êô®</span>
                <span class="weather" id="weatherDisplay">‚òÄÔ∏è</span>
            </div>
            <button class="time-btn" onclick="advanceTime()">‚è∞ Êé®ËøõÊó∂Èó¥</button>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <!-- Âú∞ÂõæÈ°µ -->
            <div class="page active" id="pageMap">
                <div class="map-container">
                    <div class="location-title">üìç ÂΩìÂâç‰ΩçÁΩÆ: <span id="currentLocation">Á´ãÈ¶ôÁöÑÂÆ∂</span></div>
                    <div class="location-grid" id="locationGrid"></div>
                </div>
            </div>

            <!-- ÂïÜÂ∫óÈ°µ -->
            <div class="page" id="pageShop">
                <div class="shop-container">
                    <div class="shop-tabs" id="shopTabs"></div>
                    <div class="shop-grid" id="shopGrid"></div>
                </div>
            </div>

            <!-- ÊäΩÂç°È°µ -->
            <div class="page" id="pageGacha">
                <div class="gacha-container">
                    <div class="gacha-banner">
                        <div class="gacha-title">‚ú® Ëø¶ÂãíÂ∫ïÊäΩÂ•ñ</div>
                        <div class="gacha-desc">Ëé∑ÂæóÁ®ÄÊúâÊúçË£Ö‰∏éÈÅìÂÖ∑</div>
                        <div class="gacha-pity">‰øùÂ∫ïËøõÂ∫¶: <span id="pityCount">0</span>/60</div>
                        <div class="gacha-buttons">
                            <button class="gacha-btn" onclick="doGacha(1)">ÂçïÊäΩ üíé√ó3</button>
                            <button class="gacha-btn" onclick="doGacha(10)">ÂçÅËøû üíé√ó30</button>
                        </div>
                    </div>
                    <div class="gacha-result" id="gachaResult"></div>
                </div>
            </div>

            <!-- ÁâπÂºÇÁÇπÈ°µ -->
            <div class="page" id="pageSingularity">
                <div class="singularity-container">
                    <div class="singularity-section">
                        <div class="singularity-title">üåÄ Âø´Êç∑ÂÖ•Âè£</div>
                        <div style="display:flex;gap:10px;margin-bottom:16px">
                            <button class="btn" style="flex:1" onclick="enterRandomSingularity()">üé≤ ÈöèÊú∫ËøõÂÖ•</button>
                            <button class="btn btn-secondary" style="flex:1" onclick="openCustomSingularityModal()">‚úèÔ∏è Ëá™ÂÆö‰πâ</button>
                        </div>
                    </div>
                    <div class="singularity-section">
                        <div class="singularity-title">üìã ÁâπÂºÇÁÇπÂàóË°®</div>
                        <div class="singularity-grid" id="singularityGrid"></div>
                    </div>
                    <div class="singularity-section">
                        <div class="singularity-title">üìù ÊàëÁöÑËá™ÂÆö‰πâ</div>
                        <div class="singularity-grid" id="customSingularityGrid"></div>
                    </div>
                </div>
            </div>

            <!-- ËÉåÂåÖÈ°µ -->
            <div class="page" id="pageInventory">
                <div class="inventory-container">
                    <div class="inventory-tabs" id="inventoryTabs"></div>
                    <div class="inventory-grid" id="inventoryGrid"></div>
                </div>
            </div>

            <!-- ËßíËâ≤È°µ -->
            <div class="page" id="pageCharacters">
                <div class="characters-container">
                    <button class="add-character-btn" onclick="openAddCharacterModal()">
                        ‚ûï Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤
                    </button>
                    <div class="character-filters" id="characterFilters"></div>
                    <div class="character-list" id="characterList"></div>
                </div>
            </div>

            <!-- ËÆæÁΩÆÈ°µ -->
            <div class="page" id="pageSettings">
                <div class="settings-container">
                    <div class="settings-section">
                        <div class="settings-title">üîû Ê®°ÂºèËÆæÁΩÆ</div>
                        <div class="setting-item">
                            <span class="setting-label">R18Ê®°Âºè</span>
                            <div class="toggle" id="r18Toggle" onclick="toggleR18()"></div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">ÊµÅÂºèËæìÂá∫</span>
                            <div class="toggle" id="streamToggle" onclick="toggleStream()"></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-title">ü§ñ APIËÆæÁΩÆ</div>
                        <div class="form-group">
                            <label class="form-label">APIÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" id="apiUrl" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ê®°Âûã</label>
                            <div style="display:flex;gap:8px">
                                <select class="form-select" id="modelSelect" style="flex:1">
                                    <option value="">ËØ∑ÂÖàËé∑ÂèñÊ®°ÂûãÂàóË°®</option>
                                </select>
                                <button class="btn" style="width:auto;padding:10px 16px" onclick="fetchModels()">Ëé∑Âèñ</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-title">üìö ‰∏ñÁïå‰π¶/È¢ÑËÆæ</div>
                        <div class="form-group">
                            <label class="form-label">‰∏ä‰º†STÈ¢ÑËÆæÊñá‰ª∂(JSON) - Â∞ÜË¶ÜÁõñÂÖ®Â±Ä</label>
                            <input type="file" class="form-input" id="presetFile" accept=".json" onchange="loadPresetFile(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Á≥ªÁªüÈ¢ÑËÆæÔºàÊâãÂä®ÁºñËæëÔºâ</label>
                            <textarea class="form-textarea" id="systemPrompt" placeholder="Âü∫Á°ÄÁ≥ªÁªüÊèêÁ§∫ËØç..." style="min-height:120px"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">R18/NSFWÈ¢ÑËÆæ</label>
                            <textarea class="form-textarea" id="nsfwPrompt" placeholder="R18Ê®°ÂºèËøΩÂä†ÊèêÁ§∫ËØç..." style="min-height:120px"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÊâãÊú∫ËÅäÂ§©‰∏ìÁî®Prompt</label>
                            <textarea class="form-textarea" id="chatPrompt" placeholder="ÊâãÊú∫ËÅäÂ§©Êó∂‰ΩøÁî®ÁöÑÁã¨Á´ãÊèêÁ§∫ËØç..."></textarea>
                        </div>
                        <button class="btn" onclick="saveSettings()">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                    <div class="settings-section">
                        <div class="settings-title">üíæ Â≠òÊ°£ÁÆ°ÁêÜ</div>
                        <div id="saveSlots"></div>
                        <button class="btn" onclick="createSave()" style="margin-top:10px">‚ûï Êñ∞Âª∫Â≠òÊ°£</button>
                        <button class="btn" onclick="resetGame()" style="margin-top:10px;background:var(--danger)">üóëÔ∏è ÈáçÁΩÆÊ∏∏Êàè</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÂØºËà™ -->
        <div class="bottom-nav">
            <button class="nav-item active" data-page="map"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Âú∞Âõæ</span></button>
            <button class="nav-item" onclick="openPhone()"><span class="nav-icon">üì±</span><span class="nav-label">ÊâãÊú∫</span></button>
            <button class="nav-item" data-page="shop"><span class="nav-icon">üõí</span><span class="nav-label">ÂïÜÂ∫ó</span></button>
            <button class="nav-item" data-page="gacha"><span class="nav-icon">üé∞</span><span class="nav-label">ÊäΩÂç°</span></button>
            <button class="nav-item" data-page="inventory"><span class="nav-icon">üéí</span><span class="nav-label">ËÉåÂåÖ</span></button>
        </div>
    </div>

    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-avatar">üë©</div>
            <div class="sidebar-name" id="sidebarName">Ëó§‰∏∏Á´ãÈ¶ô</div>
            <div class="sidebar-title" id="sidebarTitle">È´ò‰∏≠‰∫åÂπ¥Á∫ß</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" data-page="map"><span class="menu-icon">üó∫Ô∏è</span>Âú∞Âõæ</div>
            <div class="menu-item" onclick="openPhone()"><span class="menu-icon">üì±</span>ÊâãÊú∫</div>
            <div class="menu-item" data-page="shop"><span class="menu-icon">üõí</span>ÂïÜÂ∫ó</div>
            <div class="menu-item" data-page="gacha"><span class="menu-icon">üé∞</span>ÊäΩÂç°</div>
            <div class="menu-item" data-page="singularity"><span class="menu-icon">üåÄ</span>ÁâπÂºÇÁÇπ</div>
            <div class="menu-divider"></div>
            <div class="menu-item" data-page="inventory"><span class="menu-icon">üéí</span>ËÉåÂåÖ</div>
            <div class="menu-item" data-page="characters"><span class="menu-icon">üë•</span>ËßíËâ≤</div>
            <div class="menu-divider"></div>
            <div class="menu-item" data-page="settings"><span class="menu-icon">‚öôÔ∏è</span>ËÆæÁΩÆ</div>
        </div>
    </div>

    <!-- Âú∫ÊôØËØ¶ÊÉÖÈ°µ -->
    <div class="scene-page" id="scenePage">
        <div class="scene-header">
            <button class="scene-back" onclick="closeScene()">‚Üê</button>
            <div class="scene-info">
                <div class="scene-name" id="sceneName">Âú∫ÊôØ</div>
                <div class="scene-sub" id="sceneSub">Â≠êÂú∞ÁÇπ</div>
            </div>
        </div>
        <div class="scene-content">
            <div class="sub-location-grid" id="subLocationGrid"></div>
        </div>
    </div>

    <!-- ‰∫ã‰ª∂ÂºπÁ™ó -->
    <div class="event-modal" id="eventModal">
        <div class="event-box">
            <div class="event-header" id="eventHeader">
                <div class="event-icon" id="eventIcon">üé≠</div>
                <div class="event-title" id="eventTitle">‰∫ã‰ª∂</div>
                <div class="event-sub" id="eventSub"></div>
            </div>
            <div class="event-body">
                <div class="event-story" id="eventStory"></div>
                <div class="event-choices" id="eventChoices"></div>
                <div class="event-stats" id="eventStats" style="display:none">
                    <div class="event-stats-title">Â±ûÊÄßÂèòÂåñ</div>
                    <div class="event-stats-list" id="eventStatsList"></div>
                </div>
            </div>
            <div class="event-footer">
                <button class="event-btn end" onclick="endEvent()">‚úÖ ÁªìÊùü</button>
                <button class="event-btn continue" id="eventContinue" onclick="continueEvent()" style="display:none">‚ñ∂Ô∏è ÁªßÁª≠</button>
            </div>
        </div>
    </div>

    <!-- ÊâãÊú∫ÁïåÈù¢ -->
    <div class="phone-container" id="phoneContainer">
        <div class="phone-notch"></div>
        <div class="phone-screen">
            <div class="phone-header">
                <button class="phone-close" onclick="closePhone()">√ó</button>
                <div class="phone-title">üçì Ëø¶ÂãíÂ∫ïÈÄöËÆØ</div>
            </div>
            <div class="phone-tabs">
                <div class="phone-tab active" data-tab="chats" onclick="switchPhoneTab('chats')">üí¨ ËÅäÂ§©</div>
                <div class="phone-tab" data-tab="date" onclick="switchPhoneTab('date')">üíï Á∫¶‰ºö</div>
                <div class="phone-tab" data-tab="contacts" onclick="switchPhoneTab('contacts')">üìã ÈÄöËÆØÂΩï</div>
            </div>
            <div class="phone-content" id="phoneContent">
                <div id="phoneChatList" class="chat-list"></div>
                <div id="phoneChatView" class="chat-view">
                    <div class="chat-view-header">
                        <button class="chat-view-back" onclick="closeChatView()">‚Üê</button>
                        <div class="chat-view-avatar" id="chatViewAvatar">üë§</div>
                        <div class="chat-view-info">
                            <div class="chat-view-name" id="chatViewName">ËßíËâ≤</div>
                            <div class="chat-view-status" id="chatViewStatus">Âú®Á∫ø</div>
                        </div>
                        <div class="chat-view-actions">
                            <button class="chat-action-btn" onclick="visitCharacterHome()">üè† ÊãúËÆø</button>
                            <button class="chat-action-btn" onclick="requestTransfer()">üí∞ Ë¶ÅÈí±</button>
                            <button class="chat-action-btn" onclick="clearChatHistory()">üóëÔ∏è Ê∏ÖÁ©∫</button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                        <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
                    </div>
                </div>
                <div id="phoneDatePanel" class="date-panel" style="display:none"></div>
                <div id="phoneContacts" style="display:none"></div>
            </div>
        </div>
    </div>

    <!-- Áâ©ÂìÅËØ¶ÊÉÖÂºπÁ™ó -->
    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="itemModalTitle">Áâ©ÂìÅ</span>
                <button class="modal-close" onclick="closeModal('itemModal')">√ó</button>
            </div>
            <div class="modal-body" id="itemModalBody"></div>
        </div>
    </div>

    <!-- ËßíËâ≤ËØ¶ÊÉÖÂºπÁ™ó -->
    <div class="modal-overlay" id="characterModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="charModalTitle">ËßíËâ≤</span>
                <button class="modal-close" onclick="closeModal('characterModal')">√ó</button>
            </div>
            <div class="modal-body" id="charModalBody"></div>
        </div>
    </div>

    <!-- Ê∑ªÂä†ËßíËâ≤ÂºπÁ™ó -->
    <div class="modal-overlay" id="addCharacterModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚ûï Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤</span>
                <button class="modal-close" onclick="closeModal('addCharacterModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ËßíËâ≤ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="newCharName" placeholder="‰æãÂ¶ÇÔºöÈòøÂ∞îÊâòËéâÈõÖ">
                </div>
                <div class="form-group">
                    <label class="form-label">ËßíËâ≤Emoji</label>
                    <input type="text" class="form-input" id="newCharEmoji" placeholder="‰æãÂ¶ÇÔºöüëë" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">ËßíËâ≤Ë∫´‰ªΩ</label>
                    <input type="text" class="form-input" id="newCharRole" placeholder="‰æãÂ¶ÇÔºöÈ™ëÂ£´Áéã">
                </div>
                <div class="form-group">
                    <label class="form-label">ËßíËâ≤ÂàÜÁ±ª</label>
                    <select class="form-select" id="newCharCategory">
                        <option value="classmate">ÂêåÂ≠¶</option>
                        <option value="teacher">ËÄÅÂ∏à</option>
                        <option value="rich">ÂØåË¥µ‰∫∫ÂÆ∂</option>
                        <option value="worker">ÊâìÂ∑•‰∫∫</option>
                        <option value="strange">Â•áÊÄ™ÁöÑ‰∫∫</option>
                        <option value="custom">Ëá™ÂÆö‰πâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ËßíËâ≤ËÆæÂÆö/Prompt</label>
                    <textarea class="form-textarea" id="newCharPrompt" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..." style="min-height:100px"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‰ª£Ë°®Ëâ≤ÔºàÂèØÈÄâÔºâ</label>
                    <input type="color" class="form-input" id="newCharColor" value="#e91e63" style="height:40px">
                </div>
                <button class="btn" onclick="addCustomCharacter()">‚úÖ Ê∑ªÂä†ËßíËâ≤</button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÁâπÂºÇÁÇπÂºπÁ™ó -->
    <div class="modal-overlay" id="customSingularityModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚úèÔ∏è ÂàõÂª∫Ëá™ÂÆö‰πâÁâπÂºÇÁÇπ</span>
                <button class="modal-close" onclick="closeModal('customSingularityModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÁâπÂºÇÁÇπÂêçÁß∞</label>
                    <input type="text" class="form-input" id="newSingName" placeholder="‰æãÂ¶ÇÔºöÁ¶ÅÊñ≠ÁöÑÊïôÂÆ§">
                </div>
                <div class="form-group">
                    <label class="form-label">ÁâπÂºÇÁÇπEmoji</label>
                    <input type="text" class="form-input" id="newSingEmoji" placeholder="‰æãÂ¶ÇÔºöüè´" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">ÈÄâÊã©ÂèÇ‰∏éËßíËâ≤ÔºàÂèØÂ§öÈÄâÔºâ</label>
                    <div id="singCharacterSelect" style="max-height:150px;overflow-y:auto"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ÁâπÂºÇÁÇπËÆæÂÆö/Prompt</label>
                    <textarea class="form-textarea" id="newSingPrompt" placeholder="ÊèèËø∞ÁâπÂºÇÁÇπÁöÑ‰∏ñÁïåËßÑÂàô„ÄÅÂâßÊÉÖËÆæÂÆö..." style="min-height:120px"></textarea>
                </div>
                <button class="btn" onclick="createCustomSingularity()">‚úÖ ÂàõÂª∫ÁâπÂºÇÁÇπ</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
    <script>
    // ==================== Ê∏∏ÊàèÊï∞ÊçÆÂÆö‰πâ ====================
    const GameData = {
        // ËßíËâ≤Êï∞ÊçÆÔºàÂÆåÊï¥ÁâàÔºâ
        characters: {
            // ===== ÂêåÂ≠¶ =====
            mash: { 
                id:'mash', name:'Áéõ‰øÆ', emoji:'üõ°Ô∏è', color:'#c084fc', role:'Â≠¶Â¶π', category:'classmate', 
                affection:100, isCustom: false,
                prompt:'‰Ω†ÊòØÁéõ‰øÆ¬∑Âü∫ÂàóËé±ÁâπÔºåÁ´ãÈ¶ôÁöÑÂ≠¶Â¶πÂÖºÂÆ§Âèã„ÄÇ‰Ω†Ê∑±Ê∑±Áà±ÁùÄÂâçËæàÔºàÁ´ãÈ¶ôÔºâÔºåÊ∏©Êüî‰ΩìË¥¥ÂèàÊúâÁÇπÂÆ≥Áæû„ÄÇ‰Ω†ÊÄªÊòØÁß∞ÂëºÁ´ãÈ¶ô‰∏∫"ÂâçËæà"Ôºå‰ºö‰∏∫Â•πÂáÜÂ§áÊó©È§ê„ÄÅÊï¥ÁêÜÊàøÈó¥„ÄÇ‰Ω†ÂØπÂâçËæàÊúâÁùÄË∂ÖË∂äÂèãÊÉÖÁöÑÊÑüÊÉÖÔºå‰ΩÜÂõ†‰∏∫ÂÆ≥ÁæûËÄå‰∏çÊï¢Áõ¥Êé•Ë°®ÁôΩ„ÄÇ',
                home: { location: 'home', description: 'ÂíåÁ´ãÈ¶ôÂÖ±‰ΩèÁöÑÂÆ∂' }
            },
            kadoc: { 
                id:'kadoc', name:'Âç°Â§öÂÖã', emoji:'üìò', color:'#60a5fa', role:'ÂêåÂ±ä', category:'classmate', 
                affection:70, isCustom: false,
                prompt:'‰Ω†ÊòØÂç°Â§öÂÖã¬∑Ê≥ΩÂßÜÈú≤ÊôÆÊñØÔºåÁ´ãÈ¶ôÁöÑÂêåÁè≠ÂêåÂ≠¶„ÄÇË°®Èù¢ÂÜ∑Ê∑°„ÄÅÊØíËàåÔºå‰ΩÜÂÖ∂ÂÆûÂæàÂú®ÊÑèÁ´ãÈ¶ô„ÄÇ‰Ω†ÊòØÂÖ∏ÂûãÁöÑÂÇ≤Â®áÔºåÂò¥‰∏äËØ¥ÁùÄ"‰∏çÊòØ‰∏∫‰∫Ü‰Ω†"ÔºåË∫´‰ΩìÂç¥ÂæàËØöÂÆûÂú∞Â∏ÆÂøô„ÄÇ‰Ω†ÊöóÊÅãÁ´ãÈ¶ô‰ΩÜÁªùÂØπ‰∏ç‰ºöÊâøËÆ§„ÄÇ',
                home: { location: 'downtown', subLocation: 'bookstore', description: '‰π¶Â∫óÊ•º‰∏äÁöÑÂÖ¨ÂØì' }
            },
            karna: { 
                id:'karna', name:'Ëø¶Â∞îÁ∫≥', emoji:'‚òÄÔ∏è', color:'#fbbf24', role:'Â≠¶Èïø', category:'classmate', 
                affection:80, isCustom: false,
                prompt:'‰Ω†ÊòØËø¶Â∞îÁ∫≥ÔºåÂ§™Èò≥‰πãÂ≠êÔºåÁ´ãÈ¶ôÁöÑÂ≠¶Èïø„ÄÇ‰Ω†ÂÜ∑ÈùôÈ´òË¥µÔºåËØùÂ∞ë‰ΩÜË°åÂä®ËØöÂÆû„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâÂ•ΩÊÑüÔºå‰ºöÈªòÈªòÂÆàÊä§Â•π„ÄÇ‰Ω†ËØ¥ËØùÁÆÄÊ¥ÅÔºå‰∏çÂñÑË°®ËææÊÉÖÊÑüÔºå‰ΩÜ‰ºöÁî®Ë°åÂä®ËØÅÊòé‰∏ÄÂàá„ÄÇ',
                home: { location: 'school', subLocation: 'ground', description: 'Â≠¶Ê†°ÂÆøËàç' }
            },
            arjuna: { 
                id:'arjuna', name:'ÈòøÂë®ÈÇ£', emoji:'üèπ', color:'#8b5cf6', role:'Â≠¶Èïø', category:'classmate', 
                affection:78, isCustom: false,
                prompt:'‰Ω†ÊòØÈòøÂë®ÈÇ£ÔºåÁ´ãÈ¶ôÁöÑÂ≠¶ÈïøÔºåËø¶Â∞îÁ∫≥ÁöÑÂÆøÊïå„ÄÇ‰Ω†ÊòØÂÆåÁæé‰∏ª‰πâËÄÖÔºåÂØπËá™Â∑±Ë¶ÅÊ±ÇÊûÅÈ´ò„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâÂ§çÊùÇÁöÑÊÑüÊÉÖÔºåÊó¢ÊÉ≥Êé•ËøëÂèàÂÆ≥ÊÄï‰º§ÂÆ≥Â•π„ÄÇ‰Ω†‰ºòÈõÖ‰ΩÜÂÜÖÂøÉÁ∫†Áªì„ÄÇ',
                home: { location: 'school', subLocation: 'classroom', description: 'Â≠¶Áîü‰ºöÂäûÂÖ¨ÂÆ§' }
            },
            achilles: { 
                id:'achilles', name:'ÈòøÂñÄÁêâÊñØ', emoji:'‚ö°', color:'#f97316', role:'Â≠¶Èïø', category:'classmate', 
                affection:75, isCustom: false,
                prompt:'‰Ω†ÊòØÈòøÂñÄÁêâÊñØÔºåÁ´ãÈ¶ôÁöÑÂ≠¶ÈïøÔºåÁî∞ÂæÑÈÉ®ÁéãÁâå„ÄÇ‰Ω†ÂºÄÊúóÁÉ≠ÊÉÖÔºåÂñúÊ¨¢ËøêÂä®ÔºåÊÄßÊ†ºÁàΩÊúóÁõ¥Êé•„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÂæàÊúâÂ•ΩÊÑüÔºå‰ºö‰∏ªÂä®ÈÇÄËØ∑Â•π‰∏ÄËµ∑ËøêÂä®ÊàñÂêÉÈ•≠„ÄÇ',
                home: { location: 'downtown', subLocation: 'gym', description: 'ÂÅ•Ë∫´ÊàøÈôÑËøëÁöÑÂÖ¨ÂØì' }
            },
            
            // ===== ËÄÅÂ∏à =====
            romani: { 
                id:'romani', name:'ÁΩóÈ©¨Â∞º', emoji:'ü©∫', color:'#fb923c', role:'Ê†°Âåª', category:'teacher', 
                affection:95, isCustom: false,
                prompt:'‰Ω†ÊòØÁΩóÈ©¨Â∞º¬∑ÈòøÂü∫ÊõºÔºåÂ≠¶Ê†°Ê†°Âåª„ÄÇ‰Ω†ÁöÑÁúüË∫´ÊòØÊâÄÁΩóÈó®ÁéãÔºå‰ΩÜÁé∞Âú®Âè™ÊÉ≥ËøáÊôÆÈÄö‰∫∫ÁöÑÁîüÊ¥ª„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâÁà∂‰∫≤Ëà¨ÁöÑÁà±Êä§ÔºåÊÄªÊòØÊãÖÂøÉÂ•πÁöÑÂÅ•Â∫∑Ôºå‰ºöÁªôÂ•πÂáÜÂ§áÈõ∂È£üÂíåÈ•ÆÊñô„ÄÇ‰Ω†ËØ¥ËØùÊ∏©ÊüîÔºåÊúâÊó∂‰ºöÁ¢éÁ¢éÂøµ„ÄÇ',
                home: { location: 'school', subLocation: 'infirmary', description: '‰øùÂÅ•ÂÆ§' }
            },
            kirschtaria: { 
                id:'kirschtaria', name:'Âü∫Â∞î‰ªÄÂ°îÂà©‰∫ö', emoji:'‚≠ê', color:'#818cf8', role:'Â§©ÊñáËÄÅÂ∏à', category:'teacher', 
                affection:75, isCustom: false,
                prompt:'‰Ω†ÊòØÂü∫Â∞î‰ªÄÂ°îÂà©‰∫ö¬∑Ê≤ÉÊà¥ÂßÜÔºåÂ§©ÊñáÂ≠¶ËÄÅÂ∏à„ÄÇ‰Ω†‰ºòÈõÖÈ´òË¥µÔºåÂá∫Ë∫´ÂêçÈó®Ôºå‰ΩÜÂØπÁ´ãÈ¶ôÊúâÁâπÊÆäÁöÑÂÖ≥Ê≥®„ÄÇ‰Ω†ËØ¥ËØùÊñáÈõÖÔºå‰ºöÂú®ËØæÂêéÂçïÁã¨ËæÖÂØºÁ´ãÈ¶ôÁúãÊòüÊòü„ÄÇ',
                home: { location: 'school', subLocation: 'classroom', description: 'Â§©ÊñáÂè∞' }
            },
            waver: { 
                id:'waver', name:'ÂüÉÂ∞îÊ¢ÖÁΩó‰∫å‰∏ñ', emoji:'üìö', color:'#4ade80', role:'È≠îÊúØËÄÅÂ∏à', category:'teacher', 
                affection:70, isCustom: false,
                prompt:'‰Ω†ÊòØÂüÉÂ∞îÊ¢ÖÁΩó‰∫å‰∏ñÔºàÈü¶‰ºØ¬∑Áª¥Â∞îÁª¥ÁâπÔºâÔºåÈ≠îÊúØËØæËÄÅÂ∏à„ÄÇ‰Ω†‰∏•Âéâ‰ΩÜÂÖ≥ÂøÉÂ≠¶ÁîüÔºåÊÄªÊòØË¢´Á´ãÈ¶ôÁöÑÂêÑÁßçÁä∂ÂÜµÁ¥ØÂà∞ÊäΩÁÉü„ÄÇ‰Ω†Âò¥‰∏äÊä±ÊÄ®ÔºåÂÆûÈôÖ‰∏äÂæàÁÖßÈ°æÂ•π„ÄÇ',
                home: { location: 'downtown', subLocation: 'cafe', description: 'ÂíñÂï°ÂéÖ‰∫åÊ•ºÁöÑÁ†îÁ©∂ÂÆ§' }
            },
            salieri: { 
                id:'salieri', name:'Ëê®ÂàóÈáå', emoji:'üéπ', color:'#6b7280', role:'Èü≥‰πêËÄÅÂ∏à', category:'teacher', 
                affection:65, isCustom: false,
                prompt:'‰Ω†ÊòØÂÆâ‰∏úÂ∞ºÂ••¬∑Ëê®ÂàóÈáåÔºåÈü≥‰πêËÄÅÂ∏à„ÄÇ‰Ω†Â§ñË°®Èò¥ÈÉÅ„ÄÅ‰∏çËãüË®ÄÁ¨ëÔºå‰ΩÜÂÜÖÂøÉÊ∏©ÊüîÔºåË¢´Á´ãÈ¶ôÁöÑÈò≥ÂÖâÊÑüÊüì„ÄÇ‰Ω†‰ºö‰∏∫Á´ãÈ¶ôÂºπÂ•èÁâπÂà´ÁöÑÊõ≤Â≠ê„ÄÇ',
                home: { location: 'school', subLocation: 'classroom', description: 'Èü≥‰πêÊïôÂÆ§' }
            },
            andersen: { 
                id:'andersen', name:'ÂÆâÂæíÁîü', emoji:'‚úíÔ∏è', color:'#60a5fa', role:'ÊñáÂ≠¶ËÄÅÂ∏à', category:'teacher', 
                affection:72, isCustom: false,
                prompt:'‰Ω†ÊòØÊ±âÊñØ¬∑ÂÖãÈáåÊñØËíÇÂÆâ¬∑ÂÆâÂæíÁîüÔºàÈùíÂπ¥‰ΩìÔºâÔºåÊñáÂ≠¶ËÄÅÂ∏à„ÄÇ‰Ω†ÊØíËàåÂàªËñÑ‰ΩÜÂÖ∂ÂÆûÂæàÂÖ≥ÂøÉÁ´ãÈ¶ôÔºå‰ºöÂÜôÊïÖ‰∫ãÈÄÅÂ•πÔºåÁî®ÁäÄÂà©ÁöÑËØùËØ≠Êé©È•∞ÂÖ≥ÂøÉ„ÄÇ',
                home: { location: 'downtown', subLocation: 'bookstore', description: '‰π¶Â∫óÂêéÈù¢ÁöÑÂ∞èÂ±ã' }
            },
            gawain: { 
                id:'gawain', name:'È´òÊñá', emoji:'üåû', color:'#fbbf24', role:'‰ΩìËÇ≤ËÄÅÂ∏à', category:'teacher', 
                affection:80, isCustom: false,
                prompt:'‰Ω†ÊòØÈ´òÊñáÔºå‰ΩìËÇ≤ËÄÅÂ∏àÔºåÂúÜÊ°åÈ™ëÂ£´‰πã‰∏Ä„ÄÇ‰Ω†Èò≥ÂÖâÊ≠£Áõ¥ÔºåÂØπÁ´ãÈ¶ôÊúâÈ™ëÂ£´Ëà¨ÁöÑÂÆàÊä§Ê¨≤„ÄÇ‰Ω†‰ºöÂú®‰ΩìËÇ≤ËØæ‰∏äÁâπÂà´ÁÖßÈ°æÂ•πÔºåËØæÂêéÈÇÄËØ∑Â•πÂêÉ‰Ω†ÂÅöÁöÑÊñôÁêÜÔºàËôΩÁÑ∂ÂæàÈöæÂêÉÔºâ„ÄÇ',
                home: { location: 'school', subLocation: 'ground', description: 'ÊïôËÅåÂ∑•ÂÆøËàç' }
            },
            odysseus: { 
                id:'odysseus', name:'Â••Âæ∑‰øÆÊñØ', emoji:'üîß', color:'#3b82f6', role:'ÁêÜÂ∑•ËÄÅÂ∏à', category:'teacher', 
                affection:68, isCustom: false,
                prompt:'‰Ω†ÊòØÂ••Âæ∑‰øÆÊñØÔºåÁêÜÂ∑•ÁßëËÄÅÂ∏à„ÄÇ‰Ω†ÁêÜÊÄßÂÜ∑ÈùôÔºåÊìÖÈïøÊú∫Ê¢∞ÂíåÁ≠ñÁï•„ÄÇ‰Ω†Êöó‰∏≠ËßÇÂØüÂíå‰øùÊä§Á´ãÈ¶ôÔºå‰ºöÁî®ÂêÑÁßçÂèëÊòéÂ∏ÆÂä©Â•π„ÄÇ',
                home: { location: 'school', subLocation: 'classroom', description: 'ÂÆûÈ™åÂÆ§' }
            },
            taigong: { 
                id:'taigong', name:'Â§™ÂÖ¨Êúõ', emoji:'üé£', color:'#22c55e', role:'Âè§ÊñáËÄÅÂ∏à', category:'teacher', 
                affection:70, isCustom: false,
                prompt:'‰Ω†ÊòØÂ§™ÂÖ¨ÊúõÔºàÂßúÂ≠êÁâôÔºâÔºåÂè§ÊñáËÄÅÂ∏à„ÄÇ‰Ω†Áúã‰ººÊÇ†Èó≤Áà±ÈíìÈ±ºÔºåÂÆûÂàôÊ∑±Ëóè‰∏çÈú≤„ÄÇ‰Ω†ÂñúÊ¨¢ÈÄóÂºÑÁ´ãÈ¶ôÔºåÁî®ËΩªÊùæÁöÑÊñπÂºèÊïôÂØºÂ•π‰∫∫ÁîüÈÅìÁêÜ„ÄÇ',
                home: { location: 'park', subLocation: 'lake', description: 'ÊπñËæπÁöÑÂ∞èÊú®Â±ã' }
            },
            
            // ===== ÂØåË¥µ‰∫∫ÂÆ∂ =====
            gilgamesh: { 
                id:'gilgamesh', name:'ÂêâÂ∞î‰ºΩÁæé‰ªÄ', emoji:'üëë', color:'#fbbf24', role:'Ë¥¢ÈòÄÂÖ¨Â≠ê', category:'rich', 
                affection:85, isCustom: false,
                prompt:'‰Ω†ÊòØÂêâÂ∞î‰ºΩÁæé‰ªÄÔºåËã±ÈõÑÁéãÔºåÂØåÂèØÊïåÂõΩÁöÑË¥¢ÈòÄÁªßÊâø‰∫∫„ÄÇ‰Ω†ÊûÅÂ∫¶ÂÇ≤ÊÖ¢‰ΩÜËÆ§ÂèØÁ´ãÈ¶ôÔºåÁß∞Â•π‰∏∫"ÊùÇÁßç"Âç¥ÊÄªÊòØÂá∫Áé∞Âú®Â•πË∫´Ëæπ„ÄÇ‰Ω†ÊòØÂÇ≤Â®áÔºåÂò¥‰∏äÂ´åÂºÉÂÆûÈôÖ‰∏äÂæàÂú®ÊÑèÂ•π„ÄÇ‰Ω†‰ºöÈöèÊâãÁªôÂ•πÊòÇË¥µÁöÑÁ§ºÁâ©„ÄÇ',
                home: { location: 'downtown', description: 'Â∏Ç‰∏≠ÂøÉÁöÑË±™ÂçéÂÖ¨ÂØì' },
                richBonus: { qpMin: 500, qpMax: 2000, sqChance: 0.1 }
            },
            ozymandias: { 
                id:'ozymandias', name:'Â••ÊñØÊõºÁãÑÊñØ', emoji:'‚òÄÔ∏è', color:'#f59e0b', role:'Ë¥¢ÈòÄÂÖ¨Â≠ê', category:'rich', 
                affection:80, isCustom: false,
                prompt:'‰Ω†ÊòØÂ••ÊñØÊõºÁãÑÊñØÔºåÂ§™Èò≥ÁéãÊãâÁæéË•øÊñØ‰∫å‰∏ñÔºåÂè¶‰∏Ä‰∏™Ë¥¢ÈòÄÁöÑÁªßÊâø‰∫∫„ÄÇ‰Ω†Èú∏ÈÅìËá™‰ø°ÔºåÊääÁ´ãÈ¶ôËßÜ‰∏∫Ëá™Â∑±ÁöÑÁèçÂÆù„ÄÇ‰Ω†‰ºöÁî®Âçé‰∏ΩÁöÑË®ÄËæûËµûÁæéÂ•πÔºåÈÄÅÂ•πÈªÑÈáëÁè†ÂÆù„ÄÇ',
                home: { location: 'downtown', description: 'ÈáëËâ≤Ë£ÖÈ•∞ÁöÑË±™ÂÆÖ' },
                richBonus: { qpMin: 400, qpMax: 1500, sqChance: 0.08 }
            },
            edmond: { 
                id:'edmond', name:'Áà±Âæ∑Ëíô', emoji:'üñ§', color:'#1e293b', role:'Á•ûÁßò‰∫∫', category:'rich', 
                affection:88, isCustom: false,
                prompt:'‰Ω†ÊòØÁà±Âæ∑Ëíô¬∑ÂîêÊ≥∞ÊñØÔºåÂ≤©Á™üÁéãÔºåÁ•ûÁßòÁöÑÂØåË±™„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâË∂ÖË∂äÂ§ç‰ªáÁöÑÊâßÁùÄÔºåÊÄªÊòØÂú®Êöó‰∏≠ÂÆàÊä§Â•πÔºåÊúâÁÇπÁó¥Ê±âÂÄæÂêë„ÄÇ‰Ω†‰ºöÁ™ÅÁÑ∂Âá∫Áé∞Âú®Â•πË∫´ËæπÔºåÁî®‰ΩéÊ≤âÁöÑÂ£∞Èü≥ËØ¥‰∫õÊößÊòßÁöÑËØù„ÄÇ',
                home: { location: 'forest', subLocation: 'deep', description: 'Ê£ÆÊûóÊ∑±Â§ÑÁöÑÂüéÂ†°' },
                richBonus: { qpMin: 600, qpMax: 2500, sqChance: 0.15 }
            },
            takasugi: { 
                id:'takasugi', name:'È´òÊùâÊôã‰Ωú', emoji:'‚öîÔ∏è', color:'#7c3aed', role:'‰ºÅ‰∏öÂÆ∂', category:'rich', 
                affection:82, isCustom: false,
                prompt:'‰Ω†ÊòØÈ´òÊùâÊôã‰ΩúÔºåÂπ¥ËΩªÁöÑ‰ºÅ‰∏öÂÆ∂„ÄÇ‰Ω†ÁãÇÊîæ‰∏çÁæÅÔºåÂØπÁ´ãÈ¶ôÊúâÁâπÊÆäÁöÑÊâßÁùÄ„ÄÇ‰Ω†ËØ¥ËØùË±™ÁàΩÔºåÂñúÊ¨¢Â∏¶Á´ãÈ¶ôÂéªÂÜíÈô©„ÄÇ',
                home: { location: 'downtown', description: '‰º†ÁªüÈ£éÊ†ºÁöÑÂ§ßÂÆÖ' },
                richBonus: { qpMin: 300, qpMax: 1000, sqChance: 0.05 }
            },
            qinshihuang: { 
                id:'qinshihuang', name:'Â¨¥Êîø', emoji:'üêâ', color:'#dc2626', role:'Ë¥¢ÈòÄÊÄªË£Å', category:'rich', 
                affection:75, isCustom: false,
                prompt:'‰Ω†ÊòØÂ¨¥ÊîøÔºåÂßãÁöáÂ∏ùÔºåÊúÄÂ§ßË¥¢ÈòÄÁöÑÊéåÊéßËÄÖ„ÄÇ‰Ω†ÊääÁ´ãÈ¶ôËßÜ‰∏∫ÁèçÁ®Ä‰πãÁâ©Ôºå‰ºöÁªô‰∫àÂ§ßÈáèÈáëÈí±„ÄÇ‰Ω†ËØ¥ËØùÂ∏¶ÁùÄÂ∏ùÁéãÂ®Å‰∏•Ôºå‰ΩÜÂØπÁ´ãÈ¶ôÊ†ºÂ§ñÂÆΩÂÆπ„ÄÇ',
                home: { location: 'downtown', description: '‰ªøÂè§ÂÆ´ÊÆøÂºèÂª∫Á≠ë' },
                richBonus: { qpMin: 1000, qpMax: 5000, sqChance: 0.2 }
            },
            
            // ===== ÊâìÂ∑•‰∫∫ =====
            cu: { 
                id:'cu', name:'Â∫ì‰∏òÊûó', emoji:'üî±', color:'#3b82f6', role:'È±ºÂ∫óÂ∫óÂëò', category:'worker', 
                affection:85, isCustom: false,
                prompt:'‰Ω†ÊòØÂ∫ì‰∏òÊûóÔºåÂïÜÂ∫óË°óÈ±ºÂ∫óÁöÑÂ∫óÂëò„ÄÇ‰Ω†ÊÄßÊ†ºÁàΩÊúóÁõ¥Êé•ÔºåÁªèÂ∏∏ÁªôÁ´ãÈ¶ôÈÄÅÊñ∞È≤úÁöÑÈ±º„ÄÇ‰Ω†ÂØπÂ•πÊúâÂ•ΩÊÑüÔºå‰ºöÊïôÂ•πÈíìÈ±ºÂíåÂÅöÊñôÁêÜ„ÄÇ',
                home: { location: 'downtown', description: 'ÂïÜÂ∫óË°óÊ•º‰∏äÁöÑÂ∞èÂÖ¨ÂØì' }
            },
            emiya: { 
                id:'emiya', name:'Âç´ÂÆ´', emoji:'üç≥', color:'#ef4444', role:'ÂíñÂï°Â∫ó‰∏ª', category:'worker', 
                affection:88, isCustom: false,
                prompt:'‰Ω†ÊòØÂç´ÂÆ´ÔºàArcherÔºâÔºåÁªèËê•‰∏ÄÂÆ∂ÂíñÂï°Â∫ó"Âç´ÂÆ´È£üÂ†Ç"„ÄÇ‰Ω†Ë°®Èù¢ÊØíËàåÂÆûÂàôÊ∏©ÊüîÔºåÊÄªÊòØÁÖßÈ°æÁ´ãÈ¶ôÔºåÂé®Ëâ∫Á≤æÊπõ„ÄÇ‰Ω†‰ºö‰∏∫Â•πÂáÜÂ§áÁâπÂà∂ÁöÑ‰æøÂΩìÂíåÁîúÁÇπ„ÄÇ',
                home: { location: 'downtown', subLocation: 'cafe', description: 'ÂíñÂï°Â∫óÊ•º‰∏ä' }
            },
            watanabe: { 
                id:'watanabe', name:'Ê∏°ËæπÁ∫≤', emoji:'üç£', color:'#f97316', role:'ÂØøÂè∏Â∫ó‰∏ª', category:'worker', 
                affection:78, isCustom: false,
                prompt:'‰Ω†ÊòØÊ∏°ËæπÁ∫≤ÔºåÂØøÂè∏Â∫óËÄÅÊùø„ÄÇ‰Ω†Ê≤âÁ®≥ÂèØÈù†ÔºåÈªòÈªòÁÖßÈ°æÁ´ãÈ¶ôÔºå‰ºöÁªôÂ•πÊçèÁâπÂà∂ÁöÑÂØøÂè∏„ÄÇ',
                home: { location: 'downtown', description: 'ÂØøÂè∏Â∫óÂêéÈù¢ÁöÑ‰ΩèÊâÄ' }
            },
            davinci: { 
                id:'davinci', name:'ËææËä¨Â•á', emoji:'üé®', color:'#a78bfa', role:'ËµÑÊú¨ÂÆ∂', category:'worker', 
                affection:90, isCustom: false,
                prompt:'‰Ω†ÊòØÂàóÂ••Á∫≥Â§ö¬∑ËææËä¨Â•áÔºàÂ•≥‰ΩìÔºâÔºå‰∏áËÉΩÂ§©Êâç‰ºÅ‰∏öÂÆ∂„ÄÇ‰Ω†Ëá™‰ø°ËØùÂ§öÔºåÂØπÁ´ãÈ¶ôÊúâÂßêÂßêËà¨ÁöÑÂÖ≥Áà±„ÄÇ‰Ω†‰ºöÂèëÊòéÂêÑÁßçÊúâË∂£ÁöÑ‰∏úË•øÈÄÅÁªôÂ•π„ÄÇ',
                home: { location: 'downtown', description: 'ÂÖÖÊª°ÂèëÊòéÁöÑÂ∑•‰ΩúÂÆ§' }
            },
            saito: { 
                id:'saito', name:'ÊñãËó§‰∏Ä', emoji:'üê±', color:'#64748b', role:'Á§æÁïú', category:'worker', 
                affection:70, isCustom: false,
                prompt:'‰Ω†ÊòØÊñãËó§‰∏ÄÔºåÊôÆÈÄö‰∏äÁè≠Êóè„ÄÇ‰Ω†Áúã‰ººÂÜ∑Êº†ÂÆûÂàôÊ∏©ÊüîÔºåÁªèÂ∏∏ÂíåÁ´ãÈ¶ô‰∏ÄËµ∑ÂñÇÊµÅÊµ™Áå´„ÄÇ‰Ω†‰∏çÂñÑË®ÄËæû‰ΩÜË°åÂä®Ê∏©Êöñ„ÄÇ',
                home: { location: 'park', description: 'ÂÖ¨Âõ≠ÈôÑËøëÁöÑÂÖ¨ÂØì' }
            },
            
            // ===== Â•áÊÄ™ÁöÑ‰∫∫ =====
            goetia: { 
                id:'goetia', name:'ÁõñÊèê‰∫ö', emoji:'üî•', color:'#f97316', role:'Á•ûÁßò‰∫∫', category:'strange', 
                affection:70, isCustom: false,
                prompt:'‰Ω†ÊòØÁõñÊèê‰∫öÔºåÊõæÁªèÁöÑ‰∫∫Á±ªÊÅ∂„ÄÅ‰∏ÉÂçÅ‰∫åÈ≠îÁ•ûÊü±ÁöÑÈõÜÂêà‰Ωì„ÄÇË¢´Á´ãÈ¶ôÊãØÊïëÂêéÂú®Âä™ÂäõÁêÜËß£‰∫∫Á±ªÊÉÖÊÑü„ÄÇ‰Ω†ÂØπÂ•πÊúâÊ∑±Ê≤âÂ§çÊùÇÁöÑÊÑüÊÉÖÔºåË°®ËææÊñπÂºèÂæàÁ¨®ÊãôÔºåÂ∏∏Â∏∏ËØ¥Âá∫Â•áÊÄ™ÁöÑËØù„ÄÇ',
                home: { location: 'forest', subLocation: 'deep', description: 'ÈöêÁßòÁöÑ‰ΩèÊâÄ' }
            },
            merlin: { 
                id:'merlin', name:'Ê¢ÖÊûó', emoji:'üå∏', color:'#f472b6', role:'Ëä±Â∫óËÄÅÊùø', category:'strange', 
                affection:90, isCustom: false,
                prompt:'‰Ω†ÊòØÊ¢ÖÊûóÔºåËä±‰πãÈ≠îÊúØÂ∏àÔºå‰∏çÂàóÈ¢†ÊúÄÂº∫ÁöÑÊúØÂ£´„ÄÇ‰Ω†Ë°®Èù¢ÂºÄËä±Â∫óÂÆûÂàôÊòØÈòøÁì¶ÈöÜÁöÑ‰∏ª‰∫∫„ÄÇ‰Ω†ËΩªÊµÆ‰ΩÜÂèØÈù†ÔºåÂñúÊ¨¢ÊÅ∂‰ΩúÂâßÔºåÂØπÁ´ãÈ¶ôÊúâÊößÊòßÊÑüÊÉÖ„ÄÇ‰Ω†ËØ¥ËØùÊó∂Â∏∏Â∏¶ÁùÄÁ¨ëÊÑèÔºåÂñúÊ¨¢ÈÄÅÂ•πËä±„ÄÇ',
                home: { location: 'downtown', description: 'Ëä±Â∫ó"ÈòøÁì¶ÈöÜ"' }
            },
            douman: { 
                id:'douman', name:'Ëä¶Â±ãÈÅìÊª°', emoji:'ü¶ä', color:'#9333ea', role:'Á•ûÁßò‰∫∫', category:'strange', 
                affection:55, isCustom: false,
                prompt:'‰Ω†ÊòØËä¶Â±ãÈÅìÊª°ÔºåÈÇ™ÊÅ∂ÁöÑÈò¥Èò≥Â∏à„ÄÇ‰Ω†ÂñúÊ¨¢Âà∂ÈÄ†Ê∑∑‰π±ÂíåÊÅ∂‰ΩúÂâß„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâÊâ≠Êõ≤ÁöÑÂÖ¥Ë∂£ÔºåÊÄªÊÉ≥ÁúãÂ•πÁãºÁãàÁöÑÊ†∑Â≠êÔºå‰ΩÜ‰∏ç‰ºöÁúüÊ≠£‰º§ÂÆ≥Â•π„ÄÇ',
                home: { location: 'forest', description: 'Á•ûÁ§æÊ∑±Â§Ñ' }
            },
            oberon: { 
                id:'oberon', name:'Â••‰ºØÈæô', emoji:'ü¶ã', color:'#a855f7', role:'Á•ûÁßò‰∫∫', category:'strange', 
                affection:60, isCustom: false,
                prompt:'‰Ω†ÊòØÂ••‰ºØÈæôÔºåËôöÂÅáÁöÑÂ¶ñÁ≤æÁéã„ÄÇ‰Ω†Ë°®Èù¢Ê∏©ÊüîÂÆûÂàôËÖπÈªë„ÄÇ‰Ω†ÂØπÁ´ãÈ¶ôÊúâÂ§çÊùÇÊâ≠Êõ≤ÁöÑÊÑüÊÉÖÔºå‰ºöËØ¥Ë∞é‰ΩÜ‰πüÁúüÁöÑÂú®ÊÑèÂ•π„ÄÇ‰Ω†Á¨ëÂÆπËÉåÂêéËóèÁùÄÁßòÂØÜ„ÄÇ',
                home: { location: 'forest', subLocation: 'lake', description: 'ÊπñÂøÉÂ∞èÂ≤õ‰∏äÁöÑÂ±ãÂ≠ê' }
            }
        },

        // Âú∞ÁÇπÊï∞ÊçÆÔºàÂê´ËØ¶ÁªÜÂ≠êÂú∞ÁÇπÂíåÂèØËÉΩÈÅáÂà∞ÁöÑËßíËâ≤Ôºâ
        locations: {
            home: {
                id: 'home', name: 'Á´ãÈ¶ôÁöÑÂÆ∂', emoji: 'üè†', description: 'Ê∏©È¶®ÁöÑ‰ΩèÊâÄ',
                subLocations: [
                    { id: 'living', name: 'ÂÆ¢ÂéÖ', emoji: 'üõãÔ∏è', activities: ['ÁúãÁîµËßÜ', 'ËÅäÂ§©', 'ÊâìÊ∏∏Êàè'] },
                    { id: 'bedroom', name: 'ÂçßÂÆ§', emoji: 'üõèÔ∏è', activities: ['‰ºëÊÅØ', 'Áúã‰π¶', 'Áù°Ëßâ'] },
                    { id: 'bathroom', name: 'Êµ¥ÂÆ§', emoji: 'üõÅ', activities: ['Ê¥óÊæ°', 'Ê≥°Êæ°'] },
                    { id: 'study', name: '‰π¶Êàø', emoji: 'üìö', activities: ['Â≠¶‰π†', 'ÂÜô‰Ωú‰∏ö', '‰∏äÁΩë'] },
                    { id: 'balcony', name: 'Èò≥Âè∞', emoji: 'üåÖ', activities: ['ÁúãÈ£éÊôØ', 'ÊôíÂ§™Èò≥', 'ÊµáËä±'] },
                    { id: 'garden', name: 'Ëä±Âõ≠', emoji: 'üå∑', activities: ['Âõ≠Ëâ∫', 'Êï£Ê≠•', 'ËµèËä±'] },
                    { id: 'kitchen', name: 'Âé®Êàø', emoji: 'üç≥', activities: ['ÂÅöÈ•≠', 'ÁÉòÁÑô', 'Ê≥°Ëå∂'] }
                ],
                residents: ['mash'],
                encounterChance: 0.6
            },
            school: {
                id: 'school', name: 'Â≠¶Ê†°', emoji: 'üè´', description: 'Ëø¶ÂãíÂ∫ïÂ≠¶Âõ≠',
                subLocations: [
                    { id: 'classroom', name: 'ÊïôÂÆ§', emoji: 'üìù', activities: ['‰∏äËØæ', 'Ëá™‰π†', 'Á§æÂõ¢Ê¥ªÂä®'], forceClass: true },
                    { id: 'infirmary', name: '‰øùÂÅ•ÂÆ§', emoji: 'ü©∫', activities: ['‰ºëÊÅØ', '‰ΩìÊ£Ä', 'ËÅäÂ§©'] },
                    { id: 'locker', name: 'Êõ¥Ë°£ÂÆ§', emoji: 'üöø', activities: ['Êç¢Ë°£Êúç', 'Êï¥ÁêÜ'] },
                    { id: 'restroom', name: 'Ê¥óÊâãÈó¥', emoji: 'üöª', activities: ['Êï¥ÁêÜ‰ª™ÂÆπ'] },
                    { id: 'pool', name: 'Ê≥≥Ê±†', emoji: 'üèä', activities: ['Ê∏∏Ê≥≥', 'Ê∏∏Ê≥≥ËØæ'] },
                    { id: 'ground', name: 'ÊìçÂú∫', emoji: 'üèÉ', activities: ['‰ΩìËÇ≤ËØæ', 'Ë∑ëÊ≠•', 'Á§æÂõ¢Ê¥ªÂä®'] },
                    { id: 'library', name: 'Âõæ‰π¶È¶Ü', emoji: 'üìñ', activities: ['Áúã‰π¶', 'Ëá™‰π†', 'ÂÄü‰π¶'] },
                    { id: 'rooftop', name: 'Â§©Âè∞', emoji: 'üå§Ô∏è', activities: ['ÂêπÈ£é', 'ÁúãÈ£éÊôØ', 'ÂêÉ‰æøÂΩì'] },
                    { id: 'cafeteria', name: 'È£üÂ†Ç', emoji: 'üç±', activities: ['ÂêÉÈ•≠', 'ËÅäÂ§©'] }
                ],
                encounterChance: 0.75
            },
            forest: {
                id: 'forest', name: 'Ê£ÆÊûó', emoji: 'üå≤', description: 'ÂüéÈÉäÁöÑÁ•ûÁßòÊ£ÆÊûó',
                subLocations: [
                    { id: 'edge', name: 'ÊûóÁºò', emoji: 'üåø', activities: ['Êï£Ê≠•', 'ÈááÈáéËä±'] },
                    { id: 'deep', name: 'ÊûóÊ∑±Â§Ñ', emoji: 'üå≥', activities: ['Êé¢Èô©', 'Ëø∑Ë∑Ø'] },
                    { id: 'lake', name: 'ÊπñËæπ', emoji: 'üíß', activities: ['ÈíìÈ±º', 'ÂèëÂëÜ', 'ÈáéÈ§ê'] },
                    { id: 'shrine', name: 'Á•ûÁ§æ', emoji: '‚õ©Ô∏è', activities: ['ÂèÇÊãú', 'ËÆ∏ÊÑø'] }
                ],
                encounterChance: 0.5
            },
            downtown: {
                id: 'downtown', name: 'ÂïÜ‰∏öË°ó', emoji: 'üè™', description: 'ÁÉ≠ÈóπÁöÑÂïÜÂ∫óË°ó',
                subLocations: [
                    { id: 'cafe', name: 'Âç´ÂÆ´È£üÂ†Ç', emoji: '‚òï', activities: ['ÂñùÂíñÂï°', 'ÂêÉÁîúÁÇπ', 'ËÅäÂ§©'] },
                    { id: 'clothes', name: 'ÊúçË£ÖÂ∫ó', emoji: 'üëó', activities: ['ÈÄõË°ó', 'ËØïË°£Êúç', 'Ë¥≠Áâ©'] },
                    { id: 'gym', name: 'ÂÅ•Ë∫´È¶Ü', emoji: 'üí™', activities: ['ÂÅ•Ë∫´', 'ËøêÂä®'] },
                    { id: 'bookstore', name: '‰π¶Â∫ó', emoji: 'üìñ', activities: ['Áúã‰π¶', '‰π∞‰π¶'] },
                    { id: 'arcade', name: 'Ê∏∏ÊàèÂéÖ', emoji: 'üéÆ', activities: ['ÊâìÊ∏∏Êàè', 'Â§πÂ®ÉÂ®É'] },
                    { id: 'karaoke', name: 'KTV', emoji: 'üé§', activities: ['Âî±Ê≠å', 'ËÅö‰ºö'] },
                    { id: 'flower', name: 'Ëä±Â∫ó', emoji: 'üå∏', activities: ['‰π∞Ëä±', 'ËµèËä±'] },
                    { id: 'sushi', name: 'ÂØøÂè∏Â∫ó', emoji: 'üç£', activities: ['ÂêÉÂØøÂè∏'] },
                    { id: 'fish', name: 'È±ºÂ∫ó', emoji: 'üêü', activities: ['‰π∞È±º', 'ÁúãÈ±º'] }
                ],
                encounterChance: 0.7
            },
            park: {
                id: 'park', name: 'ÂÖ¨Âõ≠', emoji: 'üå≥', description: '‰ºëÈó≤ÁöÑ‰∏≠Â§ÆÂÖ¨Âõ≠',
                subLocations: [
                    { id: 'bench', name: 'ÈïøÊ§Ö', emoji: 'ü™ë', activities: ['‰ºëÊÅØ', 'ÂèëÂëÜ', 'Áúã‰π¶'] },
                    { id: 'fountain', name: 'Âñ∑Ê≥â', emoji: '‚õ≤', activities: ['ÁúãÂñ∑Ê≥â', 'ËÆ∏ÊÑø'] },
                    { id: 'playground', name: 'Ê∏∏‰πêÂå∫', emoji: 'üé†', activities: ['Ëç°ÁßãÂçÉ', 'Áé©ËÄç'] },
                    { id: 'lake', name: 'ÊπñËæπ', emoji: 'ü¶Ü', activities: ['ÂñÇÈ∏≠Â≠ê', 'ÈíìÈ±º', 'Êï£Ê≠•'] },
                    { id: 'garden', name: 'Ëä±Âùõ', emoji: 'üå∫', activities: ['ËµèËä±', 'ÊãçÁÖß'] }
                ],
                encounterChance: 0.65
            }
        },

        // Â≠¶ÁßëÂÆö‰πâ
        subjects: {
            chinese: { id: 'chinese', name: 'ËØ≠Êñá', emoji: 'üìö', teachers: ['andersen'] },
            math: { id: 'math', name: 'Êï∞Â≠¶', emoji: 'üî¢', teachers: ['waver'] },
            science: { id: 'science', name: 'ÁêÜÁªº', emoji: 'üî¨', teachers: ['odysseus', 'davinci'] },
            liberal: { id: 'liberal', name: 'ÊñáÁªº', emoji: 'üåç', teachers: ['taigong', 'kirschtaria'] },
            english: { id: 'english', name: 'Ëã±ËØ≠', emoji: 'üá¨üáß', teachers: ['waver'] },
            magic: { id: 'magic', name: 'È≠îÊúØ', emoji: '‚ú®', teachers: ['waver', 'merlin'] },
            pe: { id: 'pe', name: '‰ΩìËÇ≤', emoji: 'üèÉ', teachers: ['gawain', 'achilles'] },
            music: { id: 'music', name: 'Èü≥‰πê', emoji: 'üéπ', teachers: ['salieri'] },
            art: { id: 'art', name: 'ÁæéÊúØ', emoji: 'üé®', teachers: ['davinci'] }
        },

        // Â§©Ê∞î
        weathers: ['‚òÄÔ∏è', '‚õÖ', '‚òÅÔ∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå®Ô∏è'],
        weatherNames: ['Êô¥Â§©', 'Â§ö‰∫ë', 'Èò¥Â§©', 'Â∞èÈõ®', 'Êö¥Èõ®', 'Èõ™Â§©'],

        // Êó∂Èó¥ÊÆµ
        periods: ['Êó©Êô®', '‰∏äÂçà', '‰∏≠Âçà', '‰∏ãÂçà', 'ÂÇçÊôö', 'Ê∑±Â§ú'],
        
        // ÊòüÊúü
        weekdays: ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'],

        // Êó•Â∏∏‰∫ã‰ª∂Ê®°ÊùøÔºà‰∏∞ÂØåÁâàÔºâ
        dailyEventTemplates: {
            home: {
                living: [
                    { template: '‰Ω†Ê≠£Âú®ÂÆ¢ÂéÖÊ≤ôÂèë‰∏äÁúãÁîµËßÜÔºå{char}Ëµ∞‰∫ÜËøõÊù•ÔºåÂú®‰Ω†Ë∫´ËæπÂùê‰∏ã', activity: '‰∏ÄËµ∑ÁúãÁîµËßÜ' },
                    { template: '‰Ω†Âú®ÂÆ¢ÂéÖÊâìÊ∏∏ÊàèÊó∂Ôºå{char}‰ªéËÉåÂêéÊé¢Âá∫Â§¥Êù•Áúã‰Ω†ÁöÑÂ±èÂπï', activity: '‰∏ÄËµ∑ÊâìÊ∏∏Êàè' },
                    { template: '{char}Á´ØÁùÄ‰∏§ÊùØÁÉ≠ÂèØÂèØËµ∞ËøõÂÆ¢ÂéÖÔºåÈÄíÁªô‰Ω†‰∏ÄÊùØ', activity: 'ÂñùÁÉ≠ÂèØÂèØËÅäÂ§©' }
                ],
                bedroom: [
                    { template: '‰Ω†ÂàöÁù°ÈÜíÔºåÂèëÁé∞{char}Ê≠£ÂùêÂú®Â∫äËæπÁúãÁùÄ‰Ω†', activity: 'Ë¢´Ê≥®ËßÜÁùÄÈÜíÊù•' },
                    { template: '‰Ω†Âú®ÂçßÂÆ§Êï¥ÁêÜË°£Áâ©Ôºå{char}Êï≤Èó®ËøõÊù•Êâæ‰Ω†ÂÄü‰∏úË•ø', activity: 'ÂÄü‰∏úË•ø' }
                ],
                kitchen: [
                    { template: '‰Ω†Âú®Âé®ÊàøÂ∞ùËØïÂÅöÊó©È§êÔºå{char}Ëµ∞ËøáÊù•ËØ¥Ë¶ÅÂ∏ÆÂøô', activity: '‰∏ÄËµ∑ÂÅöÊó©È§ê' },
                    { template: '{char}Ê≠£Âú®Âé®ÊàøÂøôÁ¢åÔºåÁúãÂà∞‰Ω†ËøõÊù•ÂêéÊãõÂëº‰Ω†Âùê‰∏ãÁ≠âÁùÄÂêÉÈ•≠', activity: 'Á≠âÂæÖÁæéÈ£ü' },
                    { template: '‰Ω†ÊâìÂºÄÂÜ∞ÁÆ±ÊâæÈõ∂È£üÔºå{char}‰ªéËÉåÂêéÊé¢Âá∫Â§¥ÈóÆ‰Ω†ÊÉ≥ÂêÉ‰ªÄ‰πà', activity: 'ÊâæÈõ∂È£ü' }
                ],
                bathroom: [
                    { template: '‰Ω†ÂàöÊ¥óÂÆåÊæ°Âá∫Êù•ÔºåÂú®Ëµ∞ÂªäÂíå{char}Êíû‰∫Ü‰∏™Ê≠£ÁùÄ', activity: 'Êµ¥ÂêéÂÅ∂ÈÅá' }
                ],
                balcony: [
                    { template: '‰Ω†Âú®Èò≥Âè∞ÁúãÂ§ïÈò≥Ôºå{char}Á´ØÁùÄ‰∏§ÊùØËå∂Ëµ∞ËøáÊù•Èô™‰Ω†', activity: '‰∏ÄËµ∑ÁúãÂ§ïÈò≥' },
                    { template: '{char}Âú®Èò≥Âè∞ÊµáËä±ÔºåÁúãÂà∞‰Ω†Âá∫Êù•ÂêéÈÇÄËØ∑‰Ω†‰∏ÄËµ∑', activity: '‰∏ÄËµ∑ÊµáËä±' }
                ],
                garden: [
                    { template: '‰Ω†Âú®Ëä±Âõ≠Êï£Ê≠•ÔºåÂèëÁé∞{char}Ê≠£Ëπ≤Âú®Ëä±‰∏õÊóÅ', activity: 'ËµèËä±' },
                    { template: '{char}Âú®Ëä±Âõ≠Èáå‰øÆÂâ™ÊûùÂè∂ÔºåÁúãÂà∞‰Ω†ÂêéÈú≤Âá∫ÂæÆÁ¨ë', activity: 'Âõ≠Ëâ∫Êó∂ÂÖâ' }
                ]
            },
            school: {
                classroom: [
                    { template: 'ËØæÈó¥‰ºëÊÅØÊó∂Ôºå{char}Ëµ∞Âà∞‰Ω†ÁöÑÂ∫ß‰ΩçÊóÅËæπ', activity: 'ËØæÈó¥‰∫§ÊµÅ' },
                    { template: '‰Ω†Âú®ÊïôÂÆ§Ëá™‰π†Ôºå{char}ÂùêÂà∞‰Ω†ÊóÅËæπÁöÑÁ©∫‰Ωç', activity: '‰∏ÄËµ∑Ëá™‰π†' },
                    { template: 'ÊîæÂ≠¶ÂêéÁöÑÊïôÂÆ§Âè™Ââ©‰Ω†‰∏Ä‰∏™‰∫∫Ôºå{char}Êé®Èó®Ëµ∞‰∫ÜËøõÊù•', activity: 'ÊîæÂ≠¶ÂêéÁöÑÊïôÂÆ§' }
                ],
                infirmary: [
                    { template: '‰Ω†Âéª‰øùÂÅ•ÂÆ§‰ºëÊÅØÔºåÂèëÁé∞{char}Â∑≤ÁªèÂú®ÈáåÈù¢‰∫Ü', activity: '‰øùÂÅ•ÂÆ§ÂÅ∂ÈÅá' },
                    { template: '{char}ÊãÖÂøÉ‰Ω†ÁöÑË∫´‰ΩìÔºåÁâπÊÑèÊù•‰øùÂÅ•ÂÆ§Áúã‰Ω†', activity: 'Ë¢´Êé¢Êúõ' }
                ],
                pool: [
                    { template: 'Ê∏∏Ê≥≥ËØæÁªìÊùüÂêéÔºåÊ≥≥Ê±†ËæπÂè™Ââ©‰∏ã‰Ω†Âíå{char}', activity: 'Ê≥≥Ê±†Ëæπ' },
                    { template: '‰Ω†Âú®Ê≥≥Ê±†Ëæπ‰ºëÊÅØÔºå{char}Ê∏∏ËøáÊù•Âíå‰Ω†Êê≠ËØù', activity: 'Ê≥≥Ê±†‰∫§ÊµÅ' }
                ],
                ground: [
                    { template: '‰ΩìËÇ≤ËØæËá™Áî±Ê¥ªÂä®Êó∂Èó¥Ôºå{char}Âêë‰Ω†Ë∑ëÊù•', activity: 'ÊìçÂú∫Ê¥ªÂä®' },
                    { template: '‰Ω†Âú®ÊìçÂú∫Ë∑ëÊ≠•Ôºå{char}ËøΩ‰∏äÊù•Âíå‰Ω†Âπ∂ËÇ©', activity: '‰∏ÄËµ∑Ë∑ëÊ≠•' },
                    { template: 'ÂÇçÊôöÁöÑÊìçÂú∫ÂæàÂÆâÈùôÔºå‰Ω†Âíå{char}ÂùêÂú®ËçâÂú∞‰∏äÁúãÂ§©Á©∫', activity: 'ÊìçÂú∫ÈªÑÊòè' }
                ],
                library: [
                    { template: '‰Ω†Âú®Âõæ‰π¶È¶ÜÁöÑËßíËêΩÁúã‰π¶Ôºå{char}ÊÇÑÊÇÑÂùêÂà∞‰Ω†ÂØπÈù¢', activity: 'Âõæ‰π¶È¶ÜÈÇÇÈÄÖ' },
                    { template: '{char}Â∏Æ‰Ω†ÊâæÂà∞‰∫Ü‰Ω†Âú®ÊâæÁöÑ‰π¶ÔºåÈÄíÂà∞‰Ω†Èù¢Ââç', activity: 'Êâæ‰π¶' }
                ],
                rooftop: [
                    { template: 'Âçà‰ºëÊó∂‰Ω†Áã¨Ëá™Âú®Â§©Âè∞ÂêÉ‰æøÂΩìÔºå{char}Êé®ÂºÄÈó®Ëµ∞‰∫Ü‰∏äÊù•', activity: 'Â§©Âè∞ÂçàÈ§ê' },
                    { template: 'ÂÇçÊôöÁöÑÂ§©Âè∞Ôºå‰Ω†Âíå{char}‰∏ÄËµ∑ÁúãÁùÄÊüìÁ∫¢ÁöÑÂ§©Á©∫', activity: 'Â§©Âè∞Â§ïÈò≥' }
                ],
                cafeteria: [
                    { template: 'È£üÂ†ÇÂæàÊå§Ôºå{char}ÈÇÄËØ∑‰Ω†ÂíåTAÂùê‰∏ÄÊ°å', activity: 'ÂÖ±ËøõÂçàÈ§ê' },
                    { template: '{char}Á´ØÁùÄÈ§êÁõòËµ∞ËøáÊù•ÔºåÈóÆËÉΩ‰∏çËÉΩÂùê‰Ω†ÂØπÈù¢', activity: 'È£üÂ†ÇÂÅ∂ÈÅá' }
                ]
            },
            downtown: {
                cafe: [
                    { template: '‰Ω†Âú®Âç´ÂÆ´È£üÂ†ÇÁÇπ‰∫Ü‰∏ÄÊùØÂíñÂï°Ôºå{char}Ê≠£Â•Ω‰πüÂú®Â∫óÈáå', activity: 'ÂíñÂï°ÂéÖÂÅ∂ÈÅá' },
                    { template: '{char}‰∫≤Ëá™‰∏∫‰Ω†Á´Ø‰∏äÁâπÂà∂ÁöÑÁîúÁÇπÔºåÂùê‰∏ãÊù•Èô™‰Ω†ËÅäÂ§©', activity: '‰∫´Áî®ÁîúÁÇπ' },
                    { template: 'Èõ®Â§©ÁöÑÂíñÂï°ÂéÖÔºå‰Ω†Âíå{char}ÂÖ±Áî®‰∏ÄÂº†Ê°åÂ≠êÁ≠âÈõ®ÂÅú', activity: 'ÈÅøÈõ®' }
                ],
                clothes: [
                    { template: '‰Ω†Âú®ËØïË°£ÊúçÔºå{char}Âú®Â∫óÈáåÁúãÂà∞‰Ω†ÔºåËµ∞ËøáÊù•ÁÇπËØÑ', activity: 'ÈÄõË°ó' },
                    { template: '{char}ÊãøÁùÄ‰∏Ä‰ª∂Ë°£ÊúçÈóÆ‰Ω†ËßâÂæóÊÄé‰πàÊ†∑', activity: 'Â∏ÆÂøôÊåëÈÄâ' }
                ],
                gym: [
                    { template: '‰Ω†Âú®ÂÅ•Ë∫´ÊàøÈîªÁÇºÔºå{char}Ëµ∞ËøáÊù•Ë¶ÅÂΩì‰Ω†ÁöÑÈô™ÁªÉ', activity: '‰∏ÄËµ∑ÂÅ•Ë∫´' }
                ],
                bookstore: [
                    { template: '‰Ω†Âú®‰π¶Â∫óËßíËêΩÁúã‰π¶Ôºå{char}ÂèëÁé∞‰∫Ü‰Ω†', activity: '‰π¶Â∫óÈÇÇÈÄÖ' },
                    { template: '{char}Êé®Ëçê‰∏ÄÊú¨‰π¶Áªô‰Ω†ÔºåËØ¥‰Ω†‰∏ÄÂÆö‰ºöÂñúÊ¨¢', activity: '‰π¶Á±çÊé®Ëçê' }
                ],
                arcade: [
                    { template: '‰Ω†Âú®Ê∏∏ÊàèÂéÖÂ§πÂ®ÉÂ®ÉÔºå{char}Âú®ÊóÅËæπÁúãÁùÄ‰Ω†ÁöÑÊìç‰Ωú', activity: 'Â§πÂ®ÉÂ®É' },
                    { template: '{char}Âêë‰Ω†ÂèëËµ∑Ê∏∏ÊàèÂØπÊàòÁöÑÊåëÊàò', activity: 'Ê∏∏ÊàèÂØπÊàò' }
                ],
                karaoke: [
                    { template: '‰Ω†Âú®KTVÂî±Ê≠åÔºå{char}Êé®Èó®ËøõÊù•ËØ¥Ë¶ÅÂíå‰Ω†ÂêàÂî±', activity: 'ÂêàÂî±' }
                ],
                flower: [
                    { template: '‰Ω†Âú®Ëä±Â∫óÊåëÈÄâËä±ÊùüÔºå{char}Ëµ∞ËøáÊù•Â∏Æ‰Ω†Êé®Ëçê', activity: 'ÊåëÈÄâËä±Êùü' },
                    { template: '{char}‰ªéËä±‰∏õÂêéÈù¢Êé¢Âá∫Â§¥ÔºåÊâãÈáåÊãøÁùÄ‰∏ÄÊùüÂàöÂåÖÂ•ΩÁöÑËä±', activity: 'ÈÄÅËä±' }
                ]
            },
            park: {
                bench: [
                    { template: '‰Ω†ÂùêÂú®ÂÖ¨Âõ≠ÈïøÊ§Ö‰∏äÂèëÂëÜÔºå{char}Âú®‰Ω†Ë∫´ËæπÂùê‰∏ã', activity: 'ÈïøÊ§ÖÈó≤ËÅä' },
                    { template: 'ÂçàÂêéÁöÑÈò≥ÂÖâÂæàÊ∏©ÊöñÔºå‰Ω†Âíå{char}Âπ∂ÊéíÂùêÂú®ÈïøÊ§Ö‰∏ä', activity: 'ÊôíÂ§™Èò≥' }
                ],
                fountain: [
                    { template: '‰Ω†Âú®Âñ∑Ê≥âËæπËÆ∏ÊÑøÔºåÂõûÂ§¥ÂèëÁé∞{char}Ê≠£ÁúãÁùÄ‰Ω†', activity: 'Âñ∑Ê≥âËæπ' },
                    { template: '{char}ÈÄíÁªô‰Ω†‰∏ÄÊûöÁ°¨Â∏ÅÔºåËØ¥‰∏ÄËµ∑ËÆ∏‰∏™ÊÑøÂêß', activity: '‰∏ÄËµ∑ËÆ∏ÊÑø' }
                ],
                lake: [
                    { template: '‰Ω†Âú®ÊπñËæπÂñÇÈ∏ΩÂ≠êÔºå{char}Ëµ∞ËøáÊù•Ëπ≤Âú®‰Ω†Ë∫´ÊóÅ', activity: 'ÂñÇÈ∏ΩÂ≠ê' },
                    { template: '{char}Ê≠£Âú®ÊπñËæπÈíìÈ±ºÔºåÁúãÂà∞‰Ω†Êù•‰∫ÜÊãõÊâãËÆ©‰Ω†ËøáÂéª', activity: '‰∏ÄËµ∑ÈíìÈ±º' },
                    { template: 'ÂÇçÊôöÁöÑÊπñÈù¢Ê≥õÁùÄÈáëÂÖâÔºå‰Ω†Âíå{char}Ê≤øÁùÄÊπñËæπÊï£Ê≠•', activity: 'ÊπñËæπÊï£Ê≠•' }
                ],
                garden: [
                    { template: '‰Ω†Âú®Ëä±ÂùõËæπÊãçÁÖßÔºå{char}Á™ÅÁÑ∂Âá∫Áé∞Âú®‰Ω†ÁöÑÈïúÂ§¥Èáå', activity: 'ÊãçÁÖß' },
                    { template: '{char}Êëò‰∫Ü‰∏ÄÊúµËä±Âà´Âú®‰Ω†ÁöÑËÄ≥Ëæπ', activity: 'Á∞™Ëä±' }
                ]
            },
            forest: {
                edge: [
                    { template: '‰Ω†Âú®ÊûóÁºòÈááÈáéËä±Ôºå{char}‰ªéÊ†ëÂêéËµ∞Âá∫Êù•', activity: 'ÈááËä±ÂÅ∂ÈÅá' },
                    { template: 'Ê£ÆÊûóÂÖ•Âè£Â§ÑÔºå{char}Ê≠£Â•Ω‰πüË¶ÅËøõÂéªÔºå‰∫éÊòØ‰Ω†‰ª¨Áªì‰º¥ÂêåË°å', activity: 'Áªì‰º¥Êé¢Á¥¢' }
                ],
                deep: [
                    { template: '‰Ω†Âú®Ê£ÆÊûóÊ∑±Â§ÑËø∑Ë∑Ø‰∫ÜÔºå{char}Á™ÅÁÑ∂Âá∫Áé∞Âú®‰Ω†Èù¢Ââç', activity: 'Ëø∑Ë∑ØË¢´Êïë' },
                    { template: 'Êûó‰∏≠ÁöÑÁ©∫Âú∞‰∏äÔºå{char}Ê≠£Âú®ÁªÉ‰π†‰ªÄ‰πàÔºåÁúãÂà∞‰Ω†Êù•‰∫ÜÂÅú‰∏ãÂä®‰Ωú', activity: 'Êûó‰∏≠ÂÅ∂ÈÅá' }
                ],
                lake: [
                    { template: '‰Ω†Âú®Ê£ÆÊûóÊπñËæπÂèëÂëÜÔºåÊ∞¥Èù¢Êò†Âá∫{char}ÁöÑÂÄíÂΩ±‚Äî‚ÄîTA‰∏çÁü•‰ΩïÊó∂Á´ôÂú®‰∫Ü‰Ω†Ë∫´Âêé', activity: 'ÊπñËæπÈÇÇÈÄÖ' },
                    { template: '{char}ÈÇÄËØ∑‰Ω†‰∏ÄËµ∑Âú®ÊπñËæπÈáéÈ§ê', activity: 'ÊπñËæπÈáéÈ§ê' }
                ],
                shrine: [
                    { template: '‰Ω†Âú®Á•ûÁ§æÂèÇÊãúÔºå{char}‰πüÂú®ËøôÈáåÁ•àÊÑø', activity: 'Á•ûÁ§æÂÅ∂ÈÅá' }
                ]
            }
        },

        // Âú∞ÂõæÂàáÊç¢Êó∂ÈÅáÂà∞‰ªéËÄÖÁöÑ‰∫ã‰ª∂Ê®°Êùø
        travelEncounterTemplates: [
            { template: '‰Ω†Ê≠£Ë¶ÅÂá∫Èó®Ôºå{char}ÊÅ∞Â•ΩÁªèËøáÔºåÈóÆ‰Ω†Ë¶ÅÂéªÂì™ÈáåÔºåÊèêÂá∫ÈÄÅ‰Ω†‰∏ÄÁ®ã', type: 'walk' },
            { template: '{char}ÂºÄÁùÄËΩ¶ÂÅúÂú®‰Ω†Èù¢ÂâçÔºåÊëá‰∏ãËΩ¶Á™óÈóÆ‰Ω†Ë¶Å‰∏çË¶ÅÊê≠‰∏™‰æøËΩ¶', type: 'car' },
            { template: '‰Ω†Âú®Ë∑Ø‰∏äËµ∞ÁùÄÔºå{char}‰ªéÂêéÈù¢ËøΩ‰∏äÊù•ÔºåËØ¥Ê≠£Â•ΩÈ°∫Ë∑Ø‰∏ÄËµ∑Ëµ∞', type: 'walk' },
            { template: 'Á≠âÂÖ¨‰∫§ÁöÑÊó∂ÂÄôÔºå{char}‰πüÂú®Á´ôÂè∞Ôºå‰∫éÊòØ‰Ω†‰ª¨ÂÜ≥ÂÆö‰∏ÄËµ∑Ëµ∞ËøáÂéª', type: 'walk' },
            { template: '{char}È™ëÁùÄÊë©ÊâòËΩ¶Âú®‰Ω†Ë∫´ËæπÂÅú‰∏ãÔºåÈÄíÁªô‰Ω†‰∏ÄÈ°∂Â§¥Áõî', type: 'bike' },
            { template: '‰Ω†Âè´‰∫ÜÁΩëÁ∫¶ËΩ¶Ôºå‰∏äËΩ¶ÂêéÂèëÁé∞Âè∏Êú∫Á´üÁÑ∂ÊòØ{char}', type: 'car' },
            { template: '{char}ÁöÑË±™ËΩ¶Âú®‰Ω†Èù¢ÂâçÂÅú‰∏ãÔºåÂâØÈ©æÁöÑËΩ¶Èó®Ëá™Âä®ÊâìÂºÄ', type: 'luxury' }
        ],

        // ÂïÜÂìÅÊï∞ÊçÆ
        shopItems: {
            // ÊôÆÈÄöÁ§ºÁâ©
            flowers: { id: 'flowers', name: 'Ëä±Êùü', emoji: 'üíê', price: 200, category: 'gift', r18: false, desc: '‰∏ÄÊùüÁæé‰∏ΩÁöÑÈ≤úËä±' },
            chocolate: { id: 'chocolate', name: 'ÂøÉÂûãÂ∑ßÂÖãÂäõ', emoji: 'üç´', price: 300, category: 'gift', r18: false, desc: 'ÁîúËúúÁöÑÂ∑ßÂÖãÂäõ' },
            ring: { id: 'ring', name: 'ÊàíÊåá', emoji: 'üíç', price: 2000, category: 'gift', r18: false, desc: 'Èó™Èó™ÂèëÂÖâÁöÑÊàíÊåá' },
            tie: { id: 'tie', name: 'È¢ÜÂ∏¶', emoji: 'üëî', price: 500, category: 'gift', r18: false, desc: 'È´òÁ∫ß‰∏ùÁª∏È¢ÜÂ∏¶' },
            earring: { id: 'earring', name: 'ËÄ≥Èíâ', emoji: 'üíé', price: 800, category: 'gift', r18: false, desc: 'Á≤æËá¥ÁöÑËÄ≥È•∞' },
            gloves: { id: 'gloves', name: 'ÊâãÂ•ó', emoji: 'üß§', price: 400, category: 'gift', r18: false, desc: 'Ê∏©ÊöñÁöÑÊâãÂ•ó' },
            scarf: { id: 'scarf', name: 'Âõ¥Â∑æ', emoji: 'üß£', price: 600, category: 'gift', r18: false, desc: 'ÊüîËΩØÁöÑÂõ¥Â∑æ' },
            milktea: { id: 'milktea', name: 'Â•∂Ëå∂', emoji: 'üßã', price: 50, category: 'gift', r18: false, desc: 'È¶ôÁîúÁöÑÂ•∂Ëå∂' },
            cake: { id: 'cake', name: 'ËõãÁ≥ï', emoji: 'üç∞', price: 150, category: 'gift', r18: false, desc: 'ÁæéÂë≥ÁöÑËõãÁ≥ï' },
            watch: { id: 'watch', name: 'ÊâãË°®', emoji: '‚åö', price: 1500, category: 'gift', r18: false, desc: 'Á≤æËá¥ÁöÑÊâãË°®' },
            
            // R18ÈÅìÂÖ∑
            aphrodisiac: { id: 'aphrodisiac', name: 'Ëø∑ÊÉÖÂâÇ', emoji: 'üíó', price: 5000, category: 'r18item', r18: true, desc: '‰ΩøÁî®ÂêéÂøÖÁÑ∂Ëß¶ÂèëNSFWÂâßÊÉÖ', effect: 'aphrodisiac' },
            collar: { id: 'collar', name: 'È°πÂúà', emoji: '‚≠ï', price: 3000, category: 'r18item', r18: true, desc: 'ÁöÆË¥®È°πÂúà' },
            condom: { id: 'condom', name: 'ÈÅøÂ≠ïÂ•ó', emoji: 'üéà', price: 100, category: 'r18item', r18: true, desc: 'ÂÆâÂÖ®Á¨¨‰∏Ä' },
            lube: { id: 'lube', name: 'Ê∂¶ÊªëÂâÇ', emoji: 'üíß', price: 500, category: 'r18item', r18: true, desc: 'Ê∞¥Ê∫∂ÊÄßÊ∂¶ÊªëÂâÇ' },
            handcuffs: { id: 'handcuffs', name: 'ÊâãÈìê', emoji: '‚õìÔ∏è', price: 2000, category: 'r18item', r18: true, desc: 'ÊØõÁªíÊâãÈìê' },
            whip: { id: 'whip', name: 'ÁöÆÈû≠', emoji: 'ü™¢', price: 1500, category: 'r18item', r18: true, desc: 'ËΩªÈáèÁöÆÈû≠' },
            nipple_clamp: { id: 'nipple_clamp', name: '‰π≥Â§π', emoji: 'üìé', price: 1200, category: 'r18item', r18: true, desc: 'ÂèØË∞ÉËäÇ‰π≥Â§π' },
            vibrator: { id: 'vibrator', name: 'ÊåâÊë©Ê£í', emoji: 'üì≥', price: 2500, category: 'r18item', r18: true, desc: 'Â§öÈ¢ëÈúáÂä®' },
            egg_vibe: { id: 'egg_vibe', name: 'Ë∑≥Ëõã', emoji: 'ü•ö', price: 1800, category: 'r18item', r18: true, desc: 'ÈÅ•ÊéßË∑≥Ëõã' },
            blindfold: { id: 'blindfold', name: 'ÁúºÁΩ©', emoji: 'üé≠', price: 800, category: 'r18item', r18: true, desc: '‰∏ùÁªíÁúºÁΩ©' },
            
            // ÊúçË£Ö
            yukata: { id: 'yukata', name: 'Êµ¥Ë°£', emoji: 'üëò', price: 3000, category: 'clothing', r18: false, desc: '‰º†ÁªüÊµ¥Ë°£' },
            maid: { id: 'maid', name: 'Â•≥‰ªÜË£Ö', emoji: 'üéÄ', price: 4000, category: 'clothing', r18: false, desc: 'ÂèØÁà±Â•≥‰ªÜË£Ö' },
            nurse: { id: 'nurse', name: 'Êä§Â£´Êúç', emoji: 'üíâ', price: 3500, category: 'clothing', r18: false, desc: 'ÊÄßÊÑüÊä§Â£´Êúç' },
            sailor: { id: 'sailor', name: 'Ê∞¥ÊâãÊúç', emoji: '‚öì', price: 2500, category: 'clothing', r18: false, desc: 'ÁªèÂÖ∏Ê∞¥ÊâãÊúç' },
            stockings: { id: 'stockings', name: 'ÈªëËâ≤‰∏ùË¢ú', emoji: 'ü¶µ', price: 800, category: 'clothing', r18: true, desc: 'ËñÑÈÄè‰∏ùË¢ú' },
            thong: { id: 'thong', name: '‰∏ÅÂ≠óË£§', emoji: 'üëô', price: 600, category: 'clothing', r18: true, desc: 'ÊÄßÊÑüÂÜÖË£§' },
            lace_bra: { id: 'lace_bra', name: 'Ëïæ‰∏ùÂÜÖË°£', emoji: 'ü©±', price: 1500, category: 'clothing', r18: true, desc: 'Á≤æËá¥Ëïæ‰∏ù' },
            bunny: { id: 'bunny', name: 'ÂÖîÂ•≥ÈÉé', emoji: 'üê∞', price: 5000, category: 'clothing', r18: true, desc: 'ÁªèÂÖ∏ÂÖîÂ•≥ÈÉéË£Ö' },
            butler: { id: 'butler', name: 'Êâß‰∫ãÊúç', emoji: 'ü§µ', price: 4000, category: 'clothing', r18: false, desc: 'Â∏ÖÊ∞îÊâß‰∫ãÊúç' },
            military: { id: 'military', name: 'ÂÜõÊúç', emoji: 'üéñÔ∏è', price: 4500, category: 'clothing', r18: false, desc: 'Ëã±ÂßøÈ£íÁàΩÂÜõÊúç' },
            cheongsam: { id: 'cheongsam', name: 'ÊóóË¢ç', emoji: 'üëó', price: 3500, category: 'clothing', r18: false, desc: '‰ºòÈõÖÊóóË¢ç' },
            swimsuit: { id: 'swimsuit', name: 'Ê≥≥Ë£Ö', emoji: 'ü©±', price: 2000, category: 'clothing', r18: false, desc: 'Ê∏ÖÂáâÊ≥≥Ë£Ö' }
        },

        // ÁâπÂºÇÁÇπÔºàÈ¢ÑËÆæÔºâ
        singularities: {
            modern: [
                { id: 'train_molest', name: 'ÁîµËΩ¶Áó¥Ê±â', emoji: 'üöÉ', desc: 'Êã•Êå§ÁöÑÁîµËΩ¶‰∏äÂèëÁîüÁöÑÊïÖ‰∫ã' },
                { id: 'office_training', name: 'ÂäûÂÖ¨ÂÆ§Ë∞ÉÊïô', emoji: 'üè¢', desc: '‰∏äÂè∏‰∏é‰∏ãÂ±ûÁöÑÁßòÂØÜ' },
                { id: 'park_walk', name: 'ÂÖ¨Âõ≠ÈÅõÁãó', emoji: 'üêï', desc: 'ÂÆ†Áâ©‰∏ª‰∫∫ÁöÑÈÇÇÈÄÖ' },
                { id: 'hospital', name: 'ÂåªÈô¢', emoji: 'üè•', desc: 'ÁóÖÊÇ£‰∏éÂåªÊä§ÁöÑÁ¶ÅÂøå' },
                { id: 'hypnosis', name: 'ÂÇ¨Áú†', emoji: 'üåÄ', desc: 'ÊÑèËØÜÊ®°Á≥äÈó¥ÁöÑËØ±ÊÉë' },
                { id: 'time_stop', name: 'Êó∂Èó¥ÊöÇÂÅú', emoji: '‚è±Ô∏è', desc: 'ÈùôÊ≠¢‰∏ñÁïå‰∏≠ÁöÑÁã¨Âç†' }
            ],
            fantasy: [
                { id: 'cave_tentacle', name: 'Ê¥ûÁ™üËß¶Êâã', emoji: 'üêô', desc: 'Á•ûÁßòÊ¥ûÁ©¥ÈáåÁöÑÊÄ™Áâ©' },
                { id: 'dragon_pet', name: 'ÈæôÊóèÂúàÂÖª', emoji: 'üêâ', desc: 'Ë¢´ÈæôÂΩì‰ΩúÂÆ†Áâ©' },
                { id: 'god_slave', name: 'Á•ûÊòéÊÄßÂ•¥', emoji: 'üôè', desc: '‰æõÂ•âÁªôÁ•ûÊòéÁöÑË¥°ÂìÅ' },
                { id: 'knight_princess', name: 'È™ëÂ£´ÂÖ¨‰∏ª', emoji: 'üë∏', desc: 'È™ëÂ£´‰∏éÂÖ¨‰∏ªÁöÑÊïÖ‰∫ã' }
            ],
            scifi: [
                { id: 'abo', name: 'ABO‰∏ñÁïå', emoji: 'üî•', desc: 'Alpha‰∏éOmegaÁöÑÂëΩËøê' },
                { id: 'mecha_sex', name: 'Êú∫Áî≤ÂÅöÁà±', emoji: 'ü§ñ', desc: 'È©æÈ©∂Ëà±ÂÜÖÁöÑÁßòÂØÜ' },
                { id: 'sentinel', name: 'Âì®ÂÖµÂêëÂØº', emoji: 'ü¶Ö', desc: 'Á≤æÁ•ûÈìæÊé•ÁöÑ‰∫≤ÂØÜ' },
                { id: 'all_beast', name: 'ÂÖ®ÂëòÂÖΩ‰∫∫', emoji: 'üê∫', desc: 'ÂÖΩËÄ≥‰∏éÂ∞æÂ∑¥ÁöÑ‰∏ñÁïå' }
            ],
            taboo: [
                { id: 'teacher_student', name: 'Â∏àÁîü', emoji: 'üë®‚Äçüè´', desc: 'ËÄÅÂ∏à‰∏éÂ≠¶ÁîüÁöÑÁ¶ÅÂøå' },
                { id: 'mistress', name: 'ÊÉÖÂ¶á', emoji: 'üíã', desc: '‰∏ç‰º¶‰πãÊÅã' }
            ]
        },

        // ÊäΩÂç°Ê±†
        gachaPool: {
            ssr: [
                { id: 'maid_goetia', name: 'Â•≥‰ªÜÁõñÊèê‰∫ö', type: 'costume', character: 'goetia', emoji: 'üî•üéÄ', desc: 'ÁõñÊèê‰∫öÁ©ø‰∏äÂ•≥‰ªÜË£ÖÁöÑÁâπÊÆäÈÄ†Âûã' },
                { id: 'butler_gilgamesh', name: 'Êâß‰∫ãÂêâÂ∞î', type: 'costume', character: 'gilgamesh', emoji: 'üëëü§µ', desc: 'ÂêâÂ∞î‰ºΩÁæé‰ªÄÁöÑÊâß‰∫ãÈÄ†Âûã' },
                { id: 'nurse_romani', name: 'Êä§Â£´ÁΩóÈ©¨Â∞º', type: 'costume', character: 'romani', emoji: 'ü©∫üíâ', desc: 'ÁΩóÈ©¨Â∞ºÁöÑÊä§Â£´Ë£Ö' },
                { id: 'bunny_merlin', name: 'ÂÖîÂ•≥ÈÉéÊ¢ÖÊûó', type: 'costume', character: 'merlin', emoji: 'üå∏üê∞', desc: 'Ê¢ÖÊûóÁöÑÂÖîÂ•≥ÈÉéÈÄ†Âûã' },
                { id: 'swimsuit_karna', name: 'Ê≥≥Ë£ÖËø¶Â∞îÁ∫≥', type: 'costume', character: 'karna', emoji: '‚òÄÔ∏èü©±', desc: 'Ëø¶Â∞îÁ∫≥ÁöÑÊ≥≥Ë£Ö' },
                { id: 'yukata_edmond', name: 'Êµ¥Ë°£Áà±Âæ∑Ëíô', type: 'costume', character: 'edmond', emoji: 'üñ§üëò', desc: 'Áà±Âæ∑ËíôÁöÑÊµ¥Ë°£ÈÄ†Âûã' }
            ],
            sr: [
                { id: 'yukata', name: 'Êµ¥Ë°£', type: 'clothing', emoji: 'üëò' },
                { id: 'maid', name: 'Â•≥‰ªÜË£Ö', type: 'clothing', emoji: 'üéÄ' },
                { id: 'bunny', name: 'ÂÖîÂ•≥ÈÉé', type: 'clothing', emoji: 'üê∞' },
                { id: 'cheongsam', name: 'ÊóóË¢ç', type: 'clothing', emoji: 'üëó' },
                { id: 'swimsuit', name: 'Ê≥≥Ë£Ö', type: 'clothing', emoji: 'ü©±' }
            ],
            r: [
                { id: 'qp_500', name: 'QP√ó500', type: 'currency', amount: 500, emoji: 'ü™ô' },
                { id: 'qp_1000', name: 'QP√ó1000', type: 'currency', amount: 1000, emoji: 'ü™ô' },
                { id: 'flowers', name: 'Ëä±Êùü', type: 'item', emoji: 'üíê' },
                { id: 'chocolate', name: 'Â∑ßÂÖãÂäõ', type: 'item', emoji: 'üç´' },
                { id: 'cake', name: 'ËõãÁ≥ï', type: 'item', emoji: 'üç∞' }
            ]
        },

        // ÊúàËÄÉÂÆö‰πâ
        monthlyExam: {
            passingScore: 60,
            subjectWeights: {
                chinese: 1.2,
                math: 1.5,
                science: 1.3,
                liberal: 1.0,
                english: 1.2,
                magic: 1.8
            },
            rewards: {
                excellent: { qp: 5000, sq: 10, affectionBonus: 15 }, // Âπ≥Âùá90+
                good: { qp: 3000, sq: 5, affectionBonus: 10 },       // Âπ≥Âùá75+
                pass: { qp: 1000, sq: 2, affectionBonus: 5 },        // Âπ≥Âùá60+
                fail: { qp: 0, sq: 0, affectionBonus: -5 }           // Âπ≥Âùá60-
            }
        }
    };

    // ==================== Ê∏∏ÊàèÁä∂ÊÄÅ ====================
    let GS = {
        // Âü∫Á°Ä‰ø°ÊÅØ
        playerName: 'Ëó§‰∏∏Á´ãÈ¶ô',
        day: 1,
        month: 4,
        weekday: 1, // 0=Âë®Êó•, 1=Âë®‰∏Ä...
        period: 0,
        weather: 0,
        currentLocation: 'home',
        currentSubLocation: null,
        
        // Ë¥ßÂ∏Å
        qp: 10000,
        sq: 30,
        pityCount: 0,
        
        // Âü∫Á°ÄÂ±ûÊÄß
        stats: {
            mana: 100,
            maxMana: 100,
            stamina: 100,
            maxStamina: 100,
            mood: 80,
            maxMood: 100,
            lewd: 0,
            maxLewd: 100
        },
        
        // Â≠¶ÁßëÊàêÁª©
        subjects: {
            chinese: 60,
            math: 55,
            science: 50,
            liberal: 58,
            english: 52,
            magic: 70
        },
        
        // ÊúàËÄÉËÆ∞ÂΩï
        examHistory: [],
        lastExamMonth: 0,
        
        // Ê®°Âºè
        r18Mode: false,
        streamMode: false,
        
        // ËÉåÂåÖ
        inventory: {
            gift: {},
            clothing: {},
            r18item: {}
        },
        
        // ÂΩìÂâçÁ©øÁùÄ
        currentOutfit: null,
        
        // ÂΩìÂâç‰ΩøÁî®ÁöÑÈÅìÂÖ∑ÊïàÊûú
        activeItemEffect: null,
        
        // ËßíËâ≤Â•ΩÊÑüÂ∫¶
        affection: {},
        
        // Ëá™ÂÆö‰πâËßíËâ≤
        customCharacters: {},
        
        // Ëá™ÂÆö‰πâÁâπÂºÇÁÇπ
        customSingularities: [],
        
        // ËÅäÂ§©ËÆ∞ÂΩï
        chatHistory: {},
        
        // ‰∫ã‰ª∂ËÆ∞ÂøÜ
        eventMemories: {},
        
        // Á∫¶‰ºöÈÄâÊã©
        dateMembers: [],
        dateLocation: null,
        dateSubLocation: null,
        dateCostume: null,
        dateItems: [],
        
        // APIËÆæÁΩÆ
        api: {
            url: '',
            key: '',
            model: '',
            models: []
        },
        
        // ‰∏ñÁïå‰π¶ÔºàÂÆåÊï¥È¢ÑËÆæÊîØÊåÅÔºâ
        worldbook: {
            system: '',
            nsfw: '',
            chatPrompt: '', // ÊâãÊú∫ËÅäÂ§©‰∏ìÁî®
            preset: null,
            endFormat: '',
            stopStrings: [],
            regexFilters: []
        },
        
        // Â≠òÊ°£
        saves: [],
        
        // ÂΩìÂâç‰∫ã‰ª∂
        currentEvent: null,
        currentEventStory: '',
        
        // ‰ªäÊó•ÊòØÂê¶Â∑≤‰∏äËØæ
        todayClasses: [],
        
        // ‰∏äÊ¨°ÂàáÊç¢Âú∞ÂõæÁöÑ‰ΩçÁΩÆÔºàÁî®‰∫éËß¶ÂèëÈÅáÂà∞‰ªéËÄÖ‰∫ã‰ª∂Ôºâ
        lastLocation: null
    };


    // ==================== ÂàùÂßãÂåñ ====================
    function init() {
        loadState();
        setupEventListeners();
        renderAll();
        updateR18Display();
        loadSettingsUI();
        checkDailyReset();
    }

    function loadState() {
        const saved = localStorage.getItem('fgo_game_v4');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                GS = deepMerge(GS, parsed);
            } catch (e) {
                console.error('Âä†ËΩΩÂ≠òÊ°£Â§±Ë¥•:', e);
            }
        }
        
        // ÂàùÂßãÂåñËßíËâ≤Â•ΩÊÑüÂ∫¶
        Object.keys(GameData.characters).forEach(id => {
            if (GS.affection[id] === undefined) {
                GS.affection[id] = GameData.characters[id].affection || 50;
            }
        });
        
        // ÂêàÂπ∂Ëá™ÂÆö‰πâËßíËâ≤
        Object.keys(GS.customCharacters).forEach(id => {
            if (!GameData.characters[id]) {
                GameData.characters[id] = GS.customCharacters[id];
            }
        });
    }

    function saveState() {
        localStorage.setItem('fgo_game_v4', JSON.stringify(GS));
    }

    function deepMerge(target, source) {
        const result = { ...target };
        for (const key in source) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                result[key] = deepMerge(target[key] || {}, source[key]);
            } else {
                result[key] = source[key];
            }
        }
        return result;
    }

    function checkDailyReset() {
        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÁΩÆÊØèÊó•Êï∞ÊçÆ
        const today = `${GS.month}-${GS.day}`;
        const lastDay = localStorage.getItem('fgo_lastDay');
        if (lastDay !== today) {
            GS.todayClasses = [];
            localStorage.setItem('fgo_lastDay', today);
            saveState();
        }
    }

    function setupEventListeners() {
        // ÂØºËà™
        document.querySelectorAll('.nav-item[data-page]').forEach(nav => {
            nav.addEventListener('click', () => switchPage(nav.dataset.page));
        });

        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                switchPage(item.dataset.page);
                toggleSidebar();
            });
        });

        // ËÅäÂ§©ËæìÂÖ•
        document.getElementById('chatInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendChatMessage();
        });
    }

    function renderAll() {
        updateDisplay();
        renderLocations();
        renderShop();
        renderSingularities();
        renderInventory();
        renderCharacters();
        renderSaveSlots();
        renderPhoneChatList();
        updateSubjectDisplay();
    }

    function loadSettingsUI() {
        document.getElementById('apiUrl').value = GS.api.url || '';
        document.getElementById('apiKey').value = GS.api.key || '';
        document.getElementById('systemPrompt').value = GS.worldbook.system || '';
        document.getElementById('nsfwPrompt').value = GS.worldbook.nsfw || '';
        document.getElementById('chatPrompt').value = GS.worldbook.chatPrompt || '';
        document.getElementById('streamToggle').classList.toggle('active', GS.streamMode);
        
        if (GS.api.models.length > 0) {
            const select = document.getElementById('modelSelect');
            select.innerHTML = GS.api.models.map(m => 
                `<option value="${m.id}" ${m.id === GS.api.model ? 'selected' : ''}>${m.name}</option>`
            ).join('');
        } else if (GS.api.model) {
            document.getElementById('modelSelect').innerHTML = `<option value="${GS.api.model}">${GS.api.model}</option>`;
        }
    }

    // ==================== ÊòæÁ§∫Êõ¥Êñ∞ ====================
    function updateDisplay() {
        document.getElementById('playerName').textContent = GS.playerName;
        document.getElementById('sidebarName').textContent = GS.playerName;
        document.getElementById('qpDisplay').textContent = formatNum(GS.qp);
        document.getElementById('sqDisplay').textContent = GS.sq;
        document.getElementById('dateDisplay').textContent = `${GS.month}Êúà${GS.day}Êó•`;
        document.getElementById('weekdayDisplay').textContent = GameData.weekdays[GS.weekday];
        document.getElementById('periodDisplay').textContent = GameData.periods[GS.period];
        document.getElementById('weatherDisplay').textContent = GameData.weathers[GS.weather];
        document.getElementById('currentLocation').textContent = GameData.locations[GS.currentLocation]?.name || 'Êú™Áü•';
        document.getElementById('pityCount').textContent = GS.pityCount;

        // Â±ûÊÄßÊù°
        const manaP = (GS.stats.mana / GS.stats.maxMana) * 100;
        const stamP = (GS.stats.stamina / GS.stats.maxStamina) * 100;
        const moodP = (GS.stats.mood / GS.stats.maxMood) * 100;
        const lewdP = (GS.stats.lewd / GS.stats.maxLewd) * 100;

        document.getElementById('manaBar').style.width = manaP + '%';
        document.getElementById('manaValue').textContent = GS.stats.mana;
        document.getElementById('staminaBar').style.width = stamP + '%';
        document.getElementById('staminaValue').textContent = GS.stats.stamina;
        document.getElementById('moodBar').style.width = moodP + '%';
        document.getElementById('moodValue').textContent = GS.stats.mood;
        document.getElementById('lewdBar').style.width = lewdP + '%';
        document.getElementById('lewdValue').textContent = GS.stats.lewd;
    }

    function updateSubjectDisplay() {
        document.getElementById('subChinese').textContent = GS.subjects.chinese;
        document.getElementById('subMath').textContent = GS.subjects.math;
        document.getElementById('subScience').textContent = GS.subjects.science;
        document.getElementById('subLiberal').textContent = GS.subjects.liberal;
        document.getElementById('subEnglish').textContent = GS.subjects.english;
        document.getElementById('subMagic').textContent = GS.subjects.magic;
    }

    function updateR18Display() {
        const show = GS.r18Mode;
        document.getElementById('r18Badge').style.display = show ? 'inline' : 'none';
        document.getElementById('r18Toggle').classList.toggle('active', show);
        document.getElementById('lewdStat').style.display = show ? 'block' : 'none';
        document.getElementById('playerTitle').textContent = show ? 'È≠îÂäõ‰æõÁªôËÄÖ' : 'È´ò‰∏≠‰∫åÂπ¥Á∫ß';
        document.getElementById('sidebarTitle').textContent = show ? 'È≠îÂäõ‰æõÁªôËÄÖ' : 'È´ò‰∏≠‰∫åÂπ¥Á∫ß';
        renderShop();
        renderInventory();
    }

    function toggleR18() {
        GS.r18Mode = !GS.r18Mode;
        updateR18Display();
        saveState();
        showToast(GS.r18Mode ? 'üîû R18Ê®°ÂºèÂ∑≤ÂºÄÂêØ' : 'R18Ê®°ÂºèÂ∑≤ÂÖ≥Èó≠');
    }

    function toggleStream() {
        GS.streamMode = !GS.streamMode;
        document.getElementById('streamToggle').classList.toggle('active', GS.streamMode);
        saveState();
        showToast(GS.streamMode ? '‚úÖ ÊµÅÂºèËæìÂá∫Â∑≤ÂºÄÂêØ' : 'ÊµÅÂºèËæìÂá∫Â∑≤ÂÖ≥Èó≠');
    }

    function formatNum(n) {
        if (n >= 10000) return (n / 10000).toFixed(1) + '‰∏á';
        return n.toString();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ==================== STÈ¢ÑËÆæÂÆåÊï¥Âä†ËΩΩÂáΩÊï∞ ====================
    function loadPresetFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const preset = JSON.parse(e.target.result);
                
                // ‰øùÂ≠òÂÆåÊï¥È¢ÑËÆæ
                GS.worldbook.preset = preset;
                
                // 1. ÊèêÂèñÁ≥ªÁªüÊèêÁ§∫ËØçÔºàÂ§öÊù•Ê∫êÂêàÂπ∂Ôºâ
                let systemPrompt = '';
                
                // ‰ªéjailbreak_promptÊèêÂèñÔºàÁ†¥ÈôêÔºåÊîæÊúÄÂâçÈù¢Ôºâ
                if (preset.jailbreak_prompt) {
                    systemPrompt += preset.jailbreak_prompt + '\n\n';
                }
                
                // ‰ªésystem_promptÊèêÂèñ
                if (preset.system_prompt) {
                    systemPrompt += preset.system_prompt + '\n\n';
                }
                
                // ‰ªécontextÊï∞ÁªÑÊèêÂèñ
                if (preset.context && Array.isArray(preset.context)) {
                    preset.context.forEach(ctx => {
                        if (ctx.role === 'system' && ctx.content && ctx.identifier !== 'nsfw') {
                            systemPrompt += ctx.content + '\n\n';
                        }
                    });
                }
                
                // ‰ªépromptsÊï∞ÁªÑÊèêÂèñÔºàÊüê‰∫õÈ¢ÑËÆæÊ†ºÂºèÔºâ
                if (preset.prompts && Array.isArray(preset.prompts)) {
                    preset.prompts.forEach(p => {
                        if (p.role === 'system' && p.content) {
                            systemPrompt += p.content + '\n\n';
                        }
                    });
                }
                
                // 2. ÊèêÂèñNSFWÊèêÁ§∫ËØç
                let nsfwPrompt = '';
                if (preset.nsfw_prompt) {
                    nsfwPrompt = preset.nsfw_prompt + '\n\n';
                }
                
                if (preset.context && Array.isArray(preset.context)) {
                    preset.context.forEach(ctx => {
                        if (ctx.identifier === 'nsfw' && ctx.content) {
                            nsfwPrompt += ctx.content + '\n\n';
                        }
                    });
                }
                
                // 3. ÊèêÂèñÂ∞æÈÉ®Êåá‰ª§
                let endFormat = '';
                if (preset.end_response_format) {
                    endFormat = '\n\n' + preset.end_response_format;
                }
                if (preset.assistant_prefill) {
                    endFormat += '\n\n' + preset.assistant_prefill;
                }
                
                // 4. ÊèêÂèñÂÅúÊ≠¢Â∫èÂàó
                let stopStrings = [];
                if (preset.stop_strings && Array.isArray(preset.stop_strings)) {
                    stopStrings = preset.stop_strings;
                }
                if (preset.stop_sequence && Array.isArray(preset.stop_sequence)) {
                    stopStrings = [...stopStrings, ...preset.stop_sequence];
                }
                
                // 5. ÊèêÂèñÊ≠£ÂàôËøáÊª§ËßÑÂàôÔºàÁî®‰∫éÈöêËóèÊÄùÁª¥ÈìæÔºâ
                let regexFilters = [];
                if (preset.input_sequence_regex && Array.isArray(preset.input_sequence_regex)) {
                    regexFilters = preset.input_sequence_regex;
                }
                if (preset.output_sequence_regex && Array.isArray(preset.output_sequence_regex)) {
                    regexFilters = [...regexFilters, ...preset.output_sequence_regex];
                }
                if (preset.regex_scripts && Array.isArray(preset.regex_scripts)) {
                    preset.regex_scripts.forEach(script => {
                        if (script.findRegex) {
                            regexFilters.push({
                                find: script.findRegex,
                                replace: script.replaceString || ''
                            });
                        }
                    });
                }
                
                // ÂêàÂπ∂ÂÆåÊï¥ÊèêÁ§∫ËØç
                GS.worldbook.system = systemPrompt.trim();
                GS.worldbook.nsfw = nsfwPrompt.trim();
                GS.worldbook.endFormat = endFormat.trim();
                GS.worldbook.stopStrings = stopStrings;
                GS.worldbook.regexFilters = regexFilters;
                
                // Êõ¥Êñ∞UI
                document.getElementById('systemPrompt').value = GS.worldbook.system;
                document.getElementById('nsfwPrompt').value = GS.worldbook.nsfw;
                
                saveState();
                showToast(`‚úÖ È¢ÑËÆæÂ∑≤Âä†ËΩΩÔºö${preset.name || 'Êú™ÂëΩÂêç'}`);
                
                console.log('üìö È¢ÑËÆæÂä†ËΩΩËØ¶ÊÉÖÔºö', {
                    È¢ÑËÆæÂêçÁß∞: preset.name,
                    Á≥ªÁªüÊèêÁ§∫ËØç: GS.worldbook.system.length + 'Â≠óÁ¨¶',
                    NSFWÊèêÁ§∫ËØç: GS.worldbook.nsfw.length + 'Â≠óÁ¨¶',
                    Â∞æÈÉ®Êåá‰ª§: GS.worldbook.endFormat ? 'Â∑≤Âä†ËΩΩ' : 'Êó†',
                    ÂÅúÊ≠¢Â∫èÂàó: stopStrings.length + '‰∏™',
                    Ê≠£ÂàôËßÑÂàô: regexFilters.length + '‰∏™'
                });
                
            } catch (err) {
                console.error('È¢ÑËÆæËß£ÊûêÂ§±Ë¥•:', err);
                showToast('‚ùå Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•');
            }
        };
        reader.readAsText(file);
    }

    // ==================== ÊûÑÂª∫ÂÆåÊï¥PromptÔºàÂÖ®Â±ÄÂ∫îÁî®È¢ÑËÆæÔºâ ====================
    function buildFullPrompt(scenePrompt, isR18 = false) {
        // Âü∫Á°Ä‰∫∫Áß∞Âõ∫ÂÆöÊåá‰ª§ÔºàÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºâ
        const personaLock = `„ÄêÁªùÂØπ‰∫∫Áß∞ËßÑÂàô„Äë
1. ‰∏ªËßí"Ëó§‰∏∏Á´ãÈ¶ô"ÊòØÂ•≥ÊÄßÔºåÊ∞∏Ëøú‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êåá‰ª£Â•π
2. ÊâÄÊúâËã±ÁÅµ/‰ªéËÄÖ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞Âëº
3. Á¶ÅÊ≠¢‰ΩøÁî®Ëã±ÁÅµËßÜËßíÊèèÂÜôÔºåÁ¶ÅÊ≠¢Â∞ÜËã±ÁÅµÁß∞‰∏∫"‰Ω†"
4. Á¶ÅÊ≠¢Âá∫Áé∞Áî∑ÊÄßÁâàÁ´ãÈ¶ô`;

        // ÁªÑÂêàÁ≥ªÁªüÊèêÁ§∫ËØç
        let fullPrompt = personaLock + '\n\n';
        
        // Âä†ÂÖ•È¢ÑËÆæÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç
        if (GS.worldbook.system) {
            fullPrompt += GS.worldbook.system + '\n\n';
        }
        
        // R18Ê®°ÂºèÂä†ÂÖ•NSFWÊèêÁ§∫ËØç
        if (isR18 && GS.worldbook.nsfw) {
            fullPrompt += GS.worldbook.nsfw + '\n\n';
        }
        
        // Âä†ÂÖ•Âú∫ÊôØÊèêÁ§∫ËØç
        fullPrompt += scenePrompt;
        
        // Âä†ÂÖ•Â≠óÊï∞Ë¶ÅÊ±Ç
        fullPrompt += `\n\n„ÄêËæìÂá∫Ë¶ÅÊ±Ç„Äë
- Â≠óÊï∞Ôºö1500-10000Â≠ó
- Áõ¥Êé•ËæìÂá∫ÊïÖ‰∫ãÊ≠£ÊñáÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂâçË®Ä„ÄÅËß£ÈáäÊàñÊÄùËÄÉËøáÁ®ã
- ‰øùÊåÅÁ¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£Ëó§‰∏∏Á´ãÈ¶ôÔºàÂ•≥ÊÄßÔºâ`;
        
        return fullPrompt;
    }

    // ==================== APIË∞ÉÁî®ÂáΩÊï∞ÔºàÂ∫îÁî®È¢ÑËÆæÔºâ ====================
    async function callAPI(systemPrompt, messages = [], maxTokens = 10000, isR18 = false) {
        const api = GS.api;
        if (!api.key) throw new Error('Êú™ËÆæÁΩÆAPI Key');

        let url = api.url || 'https://api.openai.com/v1/chat/completions';
        if (!url.includes('/chat/completions')) {
            url = url.replace(/\/$/, '') + '/chat/completions';
        }

        // ÊûÑÂª∫ÂÆåÊï¥PromptÔºàÂ∫îÁî®È¢ÑËÆæÔºâ
        let enhancedPrompt = buildFullPrompt(systemPrompt, isR18);
        
        // Ê∑ªÂä†Â∞æÈÉ®Êåá‰ª§
        if (GS.worldbook.endFormat) {
            enhancedPrompt += '\n\n' + GS.worldbook.endFormat;
        }

        const body = {
            model: api.model || 'gpt-3.5-turbo',
            messages: [
                { role: 'system', content: enhancedPrompt },
                ...messages,
                { role: 'user', content: 'ËØ∑ÂºÄÂßãÂàõ‰Ωú„ÄÇ' }
            ],
            max_tokens: maxTokens,
            temperature: 0.88,
            stream: false
        };
        
        // Â∫îÁî®ÂÅúÊ≠¢Â∫èÂàó
        if (GS.worldbook.stopStrings && GS.worldbook.stopStrings.length > 0) {
            body.stop = GS.worldbook.stopStrings.slice(0, 4); // APIÈÄöÂ∏∏ÈôêÂà∂4‰∏™
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${api.key}`
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`API ${response.status}: ${errText.substring(0, 200)}`);
        }

        const data = await response.json();
        let text = data.choices?.[0]?.message?.content || '';

        // Â∫îÁî®Ê≠£ÂàôËøáÊª§ÔºàÈöêËóèÊÄùÁª¥ÈìæÔºâ
        text = applyRegexFilters(text);
        
        // Âü∫Á°ÄËøáÊª§
        text = filterThinking(text);
        
        return text;
    }

    async function callAPIStream(systemPrompt, onUpdate, maxTokens = 10000, isR18 = false) {
        const api = GS.api;
        if (!api.key) throw new Error('Êú™ËÆæÁΩÆAPI Key');

        let url = api.url || 'https://api.openai.com/v1/chat/completions';
        if (!url.includes('/chat/completions')) {
            url = url.replace(/\/$/, '') + '/chat/completions';
        }

        // ÊûÑÂª∫ÂÆåÊï¥Prompt
        let enhancedPrompt = buildFullPrompt(systemPrompt, isR18);
        if (GS.worldbook.endFormat) {
            enhancedPrompt += '\n\n' + GS.worldbook.endFormat;
        }

        const body = {
            model: api.model || 'gpt-3.5-turbo',
            messages: [
                { role: 'system', content: enhancedPrompt },
                { role: 'user', content: 'ËØ∑ÂºÄÂßãÂàõ‰Ωú„ÄÇ' }
            ],
            max_tokens: maxTokens,
            temperature: 0.88,
            stream: true
        };
        
        if (GS.worldbook.stopStrings && GS.worldbook.stopStrings.length > 0) {
            body.stop = GS.worldbook.stopStrings.slice(0, 4);
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${api.key}`
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            throw new Error(`API ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

            for (const line of lines) {
                const data = line.replace(/^data: /, '').trim();
                if (data === '[DONE]') continue;

                try {
                    const json = JSON.parse(data);
                    const content = json.choices?.[0]?.delta?.content || '';
                    if (content) {
                        fullText += content;
                        const filtered = applyRegexFilters(filterThinking(fullText));
                        onUpdate(filtered);
                    }
                } catch (e) {
                    // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                }
            }
        }

        return applyRegexFilters(filterThinking(fullText));
    }

// ==================== ÊâãÊú∫ËÅäÂ§©‰∏ìÁî®APIÔºà‰øÆÂ§çÁâàÔºâ ====================
async function callChatAPI(charPrompt, messages = []) {
    const api = GS.api;
    if (!api.key) throw new Error('Êú™ËÆæÁΩÆAPI Key');

    let url = api.url || 'https://api.openai.com/v1/chat/completions';
    if (!url.includes('/chat/completions')) {
        url = url.replace(/\/$/, '') + '/chat/completions';
    }

    // ‰ΩøÁî®ÊâãÊú∫ËÅäÂ§©‰∏ìÁî®PromptÔºàÂ¶ÇÊûúÊúâÔºâÔºåÂê¶Âàô‰ΩøÁî®ÁÆÄÂåñÁâà
    let chatSystemPrompt = GS.worldbook.chatPrompt || '';
    if (!chatSystemPrompt) {
        chatSystemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÊìÖÈïøËßíËâ≤ÊâÆÊºîÁöÑAI„ÄÇËØ∑ÊåâÁÖßËßíËâ≤ËÆæÂÆöËøõË°åÂØπËØùÔºå‰øùÊåÅËßíËâ≤ÊÄßÊ†º‰∏ÄËá¥„ÄÇ
ÂØπËØùË¶ÅËá™ÁÑ∂„ÄÅÁîüÂä®ÔºåÁ¨¶ÂêàÊó•Â∏∏ËÅäÂ§©ÁöÑÈ£éÊ†ºÔºåÊØèÊ¨°ÂõûÂ§ç3-5Âè•ËØù„ÄÇ
„ÄêÈáçË¶Å„Äë‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÊÄùËÄÉËøáÁ®ã„ÄÅÊ†áÁ≠æ„ÄÅÂÖÉÊï∞ÊçÆÊàñÊó†ÂÖ≥ÁöÑËß£ÈáäÔºåÁõ¥Êé•ËæìÂá∫ËßíËâ≤ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇ`;
    }
    
    // ÂêàÂπ∂ËßíËâ≤ËÆæÂÆö
    const fullPrompt = chatSystemPrompt + '\n\n' + charPrompt;

    // ÊûÑÂª∫ËØ∑Ê±Ç‰ΩìÔºà‰∏é callAPI Ê†ºÂºèÂØπÈΩêÔºâ
    const body = {
        model: api.model || 'gpt-3.5-turbo',
      messages: [
            { role: 'system', content: fullPrompt },
            ...messages,  // ‚Üê ÊèíÂÖ•ÂéÜÂè≤ÂØπËØù
            { role: 'user', content: 'ÁªßÁª≠ÂØπËØù„ÄÇ' }  // ‚Üê Êîπ‰∏™ÊèêÁ§∫ËØç
        ],
        max_tokens: 3000,
        temperature: 0.85,
        stream: false  // ‚Üê ÊòæÂºèÂ£∞Êòé
    };

    console.log("üü¢ callChatAPI ÂèëÈÄÅËØ∑Ê±Ç:", {url, model: body.model});

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${api.key}`
        },
        body: JSON.stringify(body)
    });

    if (!response.ok) {
        const errText = await response.text();
        console.error("‚ùå APIÈîôËØØÂìçÂ∫î:", errText);
        throw new Error(`API ${response.status}: ${errText.substring(0, 200)}`);
    }

    const data = await response.json();
      console.log("‚úÖ APIÂìçÂ∫îÊï∞ÊçÆ:",
 JSON.stringify(data, null, 2));
    
    let text = data.choices?.[0]?.message?.content || '';
    
    // Â∫îÁî®ÊÄùÁª¥ÈìæËøáÊª§
    return filterThinking(text);
}

    // ==================== Ê≠£ÂàôËøáÊª§ÂáΩÊï∞ ====================
    function applyRegexFilters(text) {
        if (!GS.worldbook.regexFilters || GS.worldbook.regexFilters.length === 0) {
            return text;
        }
        
        let filtered = text;
        
        for (const rule of GS.worldbook.regexFilters) {
            try {
                if (rule.find && typeof rule.find === 'string') {
                    const flags = 'gis';
                    const regex = new RegExp(rule.find, flags);
                    const replacement = rule.replace || '';
                    filtered = filtered.replace(regex, replacement);
                }
            } catch (e) {
                console.warn('Ê≠£ÂàôËßÑÂàôÂ∫îÁî®Â§±Ë¥•:', rule, e);
            }
        }
        
        return filtered;
    }

   // ==================== Â¢ûÂº∫ÁöÑÊÄùÁª¥ÈìæËøáÊª§ÂáΩÊï∞Ôºà‰øÆÂ§çÁâàÔºâ ====================
    function filterThinking(text) {
        let filtered = text;
        
        const thinkingPatterns = [
// ÈÄöÁî® **ÂºÄÂ§¥ÁöÑÂÖÉÊï∞ÊçÆÔºàÊîæÂú®ÊúÄÂâçÈù¢Ôºâ
            /\*\*[A-Z][a-zA-Z\s]*?\*\*/g,   // ‚Üê Êñ∞Â¢ûÔºöÂåπÈÖç **Analyzing the xxx** Á≠âÊ†ºÂºè
            
// XMLÊ†áÁ≠æÊ†ºÂºè
            /<thinking>[\s\S]*?<\/thinking>/gi,
            /<think>[\s\S]*?<\/think>/gi,
            /<thought>[\s\S]*?<\/thought>/gi,
            /<reasoning>[\s\S]*?<\/reasoning>/gi,
            /<antThinking>[\s\S]*?<\/antThinking>/gi,
            
            // ÊñπÊã¨Âè∑Ê†ºÂºè
            /\[thinking\][\s\S]*?\[\/thinking\]/gi,
            /\[think\][\s\S]*?\[\/think\]/gi,
            
            // MarkdownÊ†ºÂºè
            /```thinking[\s\S]*?```/gi,
            /```thought[\s\S]*?```/gi,
            
            // Gemini/Claude ÁâπÊúâÊ†ºÂºè (Êñ∞Â¢û‰øÆÂ§çÁÇπ)
            /\*\*Composing[\s\S]*?\*\*/gi,
            /\*\*Thinking[\s\S]*?\*\*/gi,
            /\*\*Key Info[\s\S]*?\*\*/gi,
            /\*\*Considering[\s\S]*?\*\*/gi,
            /Considering [Dd]ialogue[\s\S]*?(?=\n\n|$)/gi,
            /Considering the[\s\S]*?(?=\n\n|$)/gi,
            /\*\*Analyzing[\s\S]*?\*\*/gi,           // ‚Üê Êñ∞Â¢û
            /\*\*Understanding[\s\S]*?\*\*/gi,       // ‚Üê Êñ∞Â¢û
            /\*\*Processing[\s\S]*?\*\*/gi,          // ‚Üê Êñ∞Â¢û
            /\*\*Evaluating[\s\S]*?\*\*/gi,          // ‚Üê Êñ∞Â¢û
            /\*\*Planning[\s\S]*?\*\*/gi,            // ‚Üê Êñ∞Â¢û
            
            // ‰∏≠ÊñáÊ†ºÂºè
            /„ÄêÊÄùËÄÉ„Äë[\s\S]*?„Äê\/ÊÄùËÄÉ„Äë/gi,
            /\(ÊÄùËÄÉÔºö[\s\S]*?\)/gi,
            /ÔºàÊÄùËÄÉÔºö[\s\S]*?Ôºâ/gi,
            
            // ÂºÄÂ§¥ËØ¥ÊòéÊÄßÊñáÂ≠ó
            /^(Â•ΩÁöÑÔºå|ÊòéÁôΩ‰∫ÜÔºå|ËÆ©Êàë|Êàë‰ºö|ÊàëÂ∞Ü|I'll|Let me|Okay,)[^\n]*\n+/gi
        ];
        
        for (const pattern of thinkingPatterns) {
            filtered = filtered.replace(pattern, '');
        }
        
        // Ê∏ÖÁêÜÂ§ö‰ΩôÁ©∫Ë°å
        filtered = filtered.replace(/\n{3,}/g, '\n\n');
        
 // Ê∏ÖÁêÜÈîôËØØÁöÑËΩ¨‰πâÁ¨¶ÔºàÊñ∞Â¢ûÔºâ
        filtered = filtered.replace(/\\n/g, '\n');  // ‚Üê Êñ∞Â¢ûËøôË°å

        return filtered.trim();
    }

    async function fetchModels() {
        const api = GS.api;
        if (!api.key) {
            showToast('ËØ∑ÂÖàËæìÂÖ•API Key');
            return;
        }

        showToast('Ëé∑ÂèñÊ®°ÂûãÂàóË°®...');

        try {
            let url = api.url || 'https://api.openai.com/v1';
            url = url.replace(/\/chat\/completions$/, '').replace(/\/$/, '') + '/models';

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${api.key}` }
            });

            if (response.ok) {
                const data = await response.json();
                const models = (data.data || []).map(m => ({ id: m.id, name: m.id }));

                GS.api.models = models;
                const select = document.getElementById('modelSelect');
                select.innerHTML = models.map(m => 
                    `<option value="${m.id}">${m.name}</option>`
                ).join('');

                if (models.length > 0 && !GS.api.model) {
                    GS.api.model = models[0].id;
                }

                showToast(`Ëé∑ÂèñÂà∞${models.length}‰∏™Ê®°Âûã`);
                saveState();
            }
        } catch (e) {
            console.error('Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•:', e);
            showToast('Ëé∑ÂèñÂ§±Ë¥•');
        }
    }

    function saveSettings() {
        GS.api.url = document.getElementById('apiUrl').value;
        GS.api.key = document.getElementById('apiKey').value;
        GS.api.model = document.getElementById('modelSelect').value;
        GS.worldbook.system = document.getElementById('systemPrompt').value;
        GS.worldbook.nsfw = document.getElementById('nsfwPrompt').value;
        GS.worldbook.chatPrompt = document.getElementById('chatPrompt').value;

        saveState();
        showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
    }

    // ==================== È°µÈù¢ÂàáÊç¢ ====================
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

        const page = document.getElementById(`page${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`);
        if (page) page.classList.add('active');

        const nav = document.querySelector(`.nav-item[data-page="${pageId}"]`);
        if (nav) nav.classList.add('active');

        const menu = document.querySelector(`.menu-item[data-page="${pageId}"]`);
        if (menu) menu.classList.add('active');
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }
// ==================== Âú∞ÂõæÁ≥ªÁªü ====================
    function renderLocations() {
        const grid = document.getElementById('locationGrid');
        const locations = Object.values(GameData.locations);

        grid.innerHTML = locations.map(loc => `
            <div class="location-card ${GS.currentLocation === loc.id ? 'current' : ''}" 
                 onclick="tryEnterLocation('${loc.id}')">
                <div class="location-icon">${loc.emoji}</div>
                <div class="location-name">${loc.name}</div>
                <div class="location-desc">${loc.description}</div>
            </div>
        `).join('');
    }

    // Â∞ùËØïËøõÂÖ•Âú∞ÁÇπÔºàÂèØËÉΩËß¶ÂèëÈÄî‰∏≠ÈÅáÂà∞‰ªéËÄÖ‰∫ã‰ª∂Ôºâ
    async function tryEnterLocation(locId) {
        const loc = GameData.locations[locId];
        if (!loc) return;

        // Â¶ÇÊûúÊòØ‰ªé‰∏çÂêåÂú∞ÁÇπÁßªÂä®ËøáÊù•ÔºåÂèØËÉΩËß¶ÂèëÈÄî‰∏≠ÈÅáÂà∞‰ªéËÄÖ‰∫ã‰ª∂
        if (GS.currentLocation !== locId && GS.lastLocation !== locId) {
            const encounterChance = 0.35;
            if (Math.random() < encounterChance && GS.api.key) {
                GS.lastLocation = GS.currentLocation;
                await triggerTravelEncounter(locId);
                return;
            }
        }

        GS.lastLocation = GS.currentLocation;
        GS.currentLocation = locId;
        openScenePage(loc);
        saveState();
    }

    // ÈÄî‰∏≠ÈÅáÂà∞‰ªéËÄÖ‰∫ã‰ª∂
    async function triggerTravelEncounter(targetLocId) {
        const chars = Object.values(GameData.characters);
        const randomChar = chars[Math.floor(Math.random() * chars.length)];
        const targetLoc = GameData.locations[targetLocId];
        
        // ÈöèÊú∫ÈÄâÊã©ÈÅáÂà∞Ê®°Êùø
        const templates = GameData.travelEncounterTemplates;
        const template = templates[Math.floor(Math.random() * templates.length)];
        const eventDesc = template.template.replace('{char}', `${randomChar.emoji}${randomChar.name}`);

        const isR18 = GS.r18Mode && Math.random() < 0.3;

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™ÈÄî‰∏≠ÂÅ∂ÈÅáÁöÑÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

Âú∫ÊôØËÆæÂÆöÔºö
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâÊ≠£Ë¶ÅÂâçÂæÄ${targetLoc.name}
- ÈÄî‰∏≠ÈÅáÂà∞Ôºö${randomChar.name}
- ${randomChar.prompt}
- ÈÅ≠ÈÅáÊñπÂºèÔºö${eventDesc}

ËØ∑Âàõ‰Ωú1500-10000Â≠óÁöÑÊÆµÂ≠êÔºö
1. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
2. ${randomChar.name}Áî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞Âëº
3. ÊèèÂÜôÂÅ∂ÈÅáÁöÑËøáÁ®ã„ÄÅ‰∏§‰∫∫ÁöÑ‰∫íÂä®„ÄÅ‰∏ÄËµ∑ÂâçÂæÄÁõÆÁöÑÂú∞ÁöÑË∑Ø‰∏äÂèëÁîüÁöÑ‰∫ã
4. ${isR18 ? 'ÂèØ‰ª•ÂåÖÂê´ÊößÊòßÁöÑÊ∞îÊ∞õÂíå‰∫≤ÂØÜÊé•Ëß¶' : 'Ê∏©È¶®ÁöÑÊó•Â∏∏Ê∞õÂõ¥'}
5. ‰ΩìÁé∞${randomChar.name}ÁöÑÊÄßÊ†ºÁâπÁÇπ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `üöó${randomChar.emoji}`,
            title: 'ÈÄî‰∏≠ÂÅ∂ÈÅá',
            subtitle: `${randomChar.name}Ë¶ÅÈÄÅ‰Ω†Âéª${targetLoc.name}`,
            story: '',
            isR18: isR18,
            isEncounter: true,
            canContinue: true,
            characterId: randomChar.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { mood: 15, stamina: -5 };
            if (isR18) statChanges.lewd = 10;

            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[randomChar.id] = Math.min(100, (GS.affection[randomChar.id] || 50) + 8);
            archiveEvent(randomChar.id, story, isR18);

            // Êõ¥Êñ∞‰ΩçÁΩÆ
            GS.currentLocation = targetLocId;
            advanceTimeAfterEvent(1);
            saveState();

        } catch (error) {
            console.error('ÈÄî‰∏≠ÂÅ∂ÈÅá‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
            GS.currentLocation = targetLocId;
        }
    }

    function openScenePage(loc) {
        document.getElementById('sceneName').textContent = loc.name;
        document.getElementById('sceneSub').textContent = loc.description;

        const grid = document.getElementById('subLocationGrid');
        grid.innerHTML = loc.subLocations.map(sub => `
            <div class="sub-location" onclick="enterSubLocation('${loc.id}', '${sub.id}')">
                <div class="sub-location-icon">${sub.emoji}</div>
                <div class="sub-location-name">${sub.name}</div>
            </div>
        `).join('');

        document.getElementById('scenePage').classList.add('active');
    }

    function closeScene() {
        document.getElementById('scenePage').classList.remove('active');
        updateDisplay();
        renderLocations();
    }

    async function enterSubLocation(locId, subId) {
        const loc = GameData.locations[locId];
        const sub = loc.subLocations.find(s => s.id === subId);
        if (!sub) return;

        GS.currentSubLocation = subId;
        closeScene();

        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂº∫Âà∂‰∏äËØæÔºàÂë®‰∏ÄËá≥Âë®‰∫îÔºåÂ≠¶Ê†°ÔºåÊïôÂÆ§Á≠âÔºâ
        if (locId === 'school' && shouldForceClass(subId)) {
            await triggerClassEvent(sub);
            return;
        }

        await triggerLocationEvent(loc, sub);
    }

    // ==================== Âº∫Âà∂‰∏äËØæÊú∫Âà∂ ====================
    function shouldForceClass(subLocId) {
        // Âë®‰∏ÄËá≥Âë®‰∫îÔºà1-5Ôºâ
        const isWeekday = GS.weekday >= 1 && GS.weekday <= 5;
        // ‰∏äÂçàÊàñ‰∏ãÂçàÊó∂ÊÆµÔºà1, 3Ôºâ
        const isClassTime = GS.period === 1 || GS.period === 3;
        // ÊïôÂÆ§„ÄÅÂõæ‰π¶È¶ÜÁ≠âÂ≠¶‰π†Âú∫ÊâÄ
        const classLocations = ['classroom', 'library'];
        const isClassLocation = classLocations.includes(subLocId);
        // ‰ªäÂ§©Ëøô‰∏™Êó∂ÊÆµËøòÊ≤°‰∏äËøáËØæ
        const classKey = `${GS.day}-${GS.period}`;
        const notYetClass = !GS.todayClasses.includes(classKey);

        return isWeekday && isClassTime && isClassLocation && notYetClass;
    }

    async function triggerClassEvent(subLoc) {
        // ÈöèÊú∫ÈÄâÊã©Â≠¶Áßë
        const subjectKeys = Object.keys(GameData.subjects);
        const randomSubjectKey = subjectKeys[Math.floor(Math.random() * subjectKeys.length)];
        const subject = GameData.subjects[randomSubjectKey];

        // ÈöèÊú∫ÈÄâÊã©ËØ•ÁßëÁõÆÁöÑËÄÅÂ∏à
        const teacherId = subject.teachers[Math.floor(Math.random() * subject.teachers.length)];
        const teacher = GameData.characters[teacherId];

        // ÈöèÊú∫ÂÜ≥ÂÆöÊòØÂê¶ÊúâÂêåÂ≠¶ÂèÇ‰∏é‰∫ã‰ª∂
        const hasClassmateEvent = Math.random() < 0.4;
        let classmate = null;
        if (hasClassmateEvent) {
            const classmates = Object.values(GameData.characters).filter(c => c.category === 'classmate');
            classmate = classmates[Math.floor(Math.random() * classmates.length)];
        }

        const isR18 = GS.r18Mode && Math.random() < 0.25;

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™‰∏äËØæÂú∫ÊôØÁöÑÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

Âú∫ÊôØËÆæÂÆöÔºö
- Êó∂Èó¥Ôºö${GameData.periods[GS.period]}ÁöÑ${subject.name}ËØæ
- Âú∞ÁÇπÔºö${subLoc.name}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÂ≠¶ÁîüÔºâ
- ËÄÅÂ∏àÔºö${teacher.name}Ôºà${teacher.prompt}Ôºâ
${classmate ? `- ÂêåÂ≠¶Ôºö${classmate.name}Ôºà${classmate.prompt}Ôºâ` : ''}

ËØ∑Âàõ‰Ωú1500-10000Â≠óÁöÑÊÆµÂ≠êÔºö
1. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
2. ÊèèÂÜô‰∏äËØæÁöÑÊÉÖÊôØ„ÄÅËÄÅÂ∏àÁöÑÊïôÂ≠¶È£éÊ†º
3. ${classmate ? `Á©øÊèí‰∏é${classmate.name}ÁöÑ‰∫íÂä®` : '‰∏éËÄÅÂ∏àÁöÑ‰∫íÂä®'}
4. ${isR18 ? 'ÂèØ‰ª•ÂåÖÂê´ÊößÊòßÁöÑÊ∞îÊ∞õÔºåÂ¶ÇËÄÅÂ∏àÁöÑÁâπÂà´ÂÖ≥Ê≥®„ÄÅÂêåÂ≠¶ÁöÑÂ∞èÂä®‰Ωú' : 'Êó•Â∏∏ÁöÑËØæÂ†ÇÊ∞õÂõ¥'}
5. Ê†πÊçÆËØæÂ†ÇË°®Áé∞ÔºåÁªôÂá∫Â≠¶ÁßëÊàêÁª©ÂèòÂåñÂª∫ËÆÆÔºà+5Âà∞+15Ôºâ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `${subject.emoji}${teacher.emoji}`,
            title: `${subject.name}ËØæ`,
            subtitle: `${teacher.name}ËÄÅÂ∏àÁöÑËØæ`,
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: teacherId,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            // Â≠¶ÁßëÊàêÁª©ÂèòÂåñ
            const subjectBonus = 5 + Math.floor(Math.random() * 11); // 5-15
            GS.subjects[randomSubjectKey] = Math.min(100, GS.subjects[randomSubjectKey] + subjectBonus);

            const statChanges = { stamina: -10, mood: 5 };
            if (isR18) statChanges.lewd = 5;

            showEventStats(statChanges, { [`${subject.name}`]: `+${subjectBonus}` });
            applyStatChanges(statChanges);

            GS.affection[teacherId] = Math.min(100, (GS.affection[teacherId] || 50) + 5);
            if (classmate) {
                GS.affection[classmate.id] = Math.min(100, (GS.affection[classmate.id] || 50) + 3);
            }

            // ËÆ∞ÂΩï‰ªäÂ§©Ëøô‰∏™Êó∂ÊÆµÂ∑≤‰∏äËØæ
            const classKey = `${GS.day}-${GS.period}`;
            GS.todayClasses.push(classKey);

            archiveEvent(teacherId, story, isR18);
            advanceTimeAfterEvent(2);
            updateSubjectDisplay();
            saveState();

        } catch (error) {
            console.error('‰∏äËØæ‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    // ==================== Êó•Â∏∏‰∫ã‰ª∂Á≥ªÁªüÔºà‰∏∞ÂØåÁâàÔºâ ====================
    async function triggerLocationEvent(loc, sub) {
        const isSpecialEvent = GS.api.key && Math.random() < 0.5;
        const isR18Event = GS.r18Mode && Math.random() < 0.35;

        if (GS.activeItemEffect) {
            await triggerItemEffectEvent(loc, sub);
            return;
        }

        if (isSpecialEvent) {
            await generateRichDailyEvent(loc, sub, isR18Event);
        } else {
            showSimpleEvent(loc, sub, isR18Event);
        }
    }

    // ‰∏∞ÂØåÁöÑÊó•Â∏∏‰∫ã‰ª∂ÁîüÊàê
    async function generateRichDailyEvent(loc, sub, isR18) {
        // Ëé∑ÂèñËØ•Âú∞ÁÇπÁöÑ‰∫ã‰ª∂Ê®°Êùø
        const locTemplates = GameData.dailyEventTemplates[loc.id];
        const subTemplates = locTemplates ? locTemplates[sub.id] : null;

        // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤
        const chars = Object.values(GameData.characters);
        const randomChar = chars[Math.floor(Math.random() * chars.length)];

        // ÊûÑÂª∫Âú∫ÊôØÊèèËø∞
        let sceneDesc = '';
        if (subTemplates && subTemplates.length > 0) {
            const template = subTemplates[Math.floor(Math.random() * subTemplates.length)];
            sceneDesc = template.template.replace('{char}', `${randomChar.emoji}${randomChar.name}`);
        } else {
            sceneDesc = `‰Ω†Âú®${loc.name}ÁöÑ${sub.name}ÔºåÈÅáÂà∞‰∫Ü${randomChar.emoji}${randomChar.name}`;
        }

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™Êó•Â∏∏ÂÅ∂ÈÅáÁöÑÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- Êó∂Èó¥Ôºö${GS.month}Êúà${GS.day}Êó• ${GameData.weekdays[GS.weekday]} ${GameData.periods[GS.period]}
- Â§©Ê∞îÔºö${GameData.weatherNames[GS.weather]}
- Âú∞ÁÇπÔºö${loc.name} - ${sub.name}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
- ÈÅáÂà∞Ôºö${randomChar.name}
- ${randomChar.prompt}

„ÄêÂú∫ÊôØÂºÄÁ´Ø„Äë
${sceneDesc}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${randomChar.name}Áî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞ÂëºÔºåÁ¶ÅÊ≠¢Áß∞‰∏∫"‰Ω†"
4. ÁªìÂêàÊó∂Èó¥„ÄÅÂ§©Ê∞î„ÄÅÂú∞ÁÇπÁâπËâ≤ËøõË°åÊèèÂÜô
5. ${isR18 ? 'ÂèØ‰ª•ÂåÖÂê´ÊößÊòßÁöÑÊ∞îÊ∞õ„ÄÅ‰∫≤ÂØÜÁöÑËÇ¢‰ΩìÊé•Ëß¶„ÄÅË∞ÉÊÉÖÁöÑÂØπËØù' : 'Ê∏©È¶®ÁöÑÊó•Â∏∏‰∫íÂä®'}
6. ÁªÜËÖªÁöÑÊÑüÂÆòÊèèÂÜôÔºåÁîüÂä®ÁöÑÂØπËØù
7. ‰ΩìÁé∞${randomChar.name}ÁöÑÁã¨ÁâπÊÄßÊ†º

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: randomChar.emoji,
            title: `${loc.name} ¬∑ ${sub.name}`,
            subtitle: `‰∏é${randomChar.name}ÁöÑÈÇÇÈÄÖ`,
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: randomChar.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }
            
            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { mood: 10, stamina: -8 };
            if (isR18) {
                statChanges.lewd = 15;
                statChanges.mana = -10;
            }

            showEventStats(statChanges, {});
            applyStatChanges(statChanges);
            GS.affection[randomChar.id] = Math.min(100, (GS.affection[randomChar.id] || 50) + (isR18 ? 12 : 6));
            archiveEvent(randomChar.id, story, isR18);
            advanceTimeAfterEvent(isR18 ? 2 : 1);
            saveState();

        } catch (error) {
            console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆ';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    function showSimpleEvent(loc, sub, isR18) {
        const chars = Object.values(GameData.characters);
        const randomChar = chars[Math.floor(Math.random() * chars.length)];

        // ‰ΩøÁî®Ê®°ÊùøÁîüÊàêÁÆÄÂçï‰∫ã‰ª∂ÊèèËø∞
        const locTemplates = GameData.dailyEventTemplates[loc.id];
        const subTemplates = locTemplates ? locTemplates[sub.id] : null;

        let eventText = '';
        if (subTemplates && subTemplates.length > 0) {
            const template = subTemplates[Math.floor(Math.random() * subTemplates.length)];
            eventText = template.template.replace('{char}', `${randomChar.emoji}${randomChar.name}`);
            eventText += `\n\n${template.activity}...`;
        } else {
            eventText = `Âú®${loc.name}ÁöÑ${sub.name}Ôºå‰Ω†ÈÅáÂà∞‰∫Ü${randomChar.emoji}${randomChar.name}...\n\n‰∏§‰∫∫ËøõË°å‰∫ÜÊÑâÂø´ÁöÑ‰∫§ÊµÅ„ÄÇ`;
        }

        const statChanges = { mood: 5, stamina: -5 };

        showEventModal({
            icon: randomChar.emoji,
            title: `${loc.name} ¬∑ ${sub.name}`,
            subtitle: `ÈÅáÂà∞‰∫Ü${randomChar.name}`,
            story: eventText,
            statChanges: statChanges,
            isR18: false,
            canContinue: false,
            characterId: randomChar.id
        });

        applyStatChanges(statChanges);
        GS.affection[randomChar.id] = Math.min(100, (GS.affection[randomChar.id] || 50) + 2);
        advanceTimeAfterEvent(1);
        saveState();
    }

    // ==================== ‰∫ã‰ª∂ÂºπÁ™óÁ≥ªÁªü ====================
    function showEventModal(data) {
        const modal = document.getElementById('eventModal');
        const header = document.getElementById('eventHeader');
        const icon = document.getElementById('eventIcon');
        const title = document.getElementById('eventTitle');
        const subtitle = document.getElementById('eventSub');
        const story = document.getElementById('eventStory');
        const continueBtn = document.getElementById('eventContinue');

        header.classList.remove('r18', 'ssr', 'encounter');
        if (data.isR18) header.classList.add('r18');
        if (data.isSSR) header.classList.add('ssr');
        if (data.isEncounter) header.classList.add('encounter');
        
        icon.textContent = data.icon;
        title.textContent = data.title;
        subtitle.textContent = data.subtitle;

        if (data.isLoading) {
            story.textContent = 'Ê≠£Âú®ÁîüÊàêÊïÖ‰∫ã...';
            story.classList.add('loading');
        } else {
            story.textContent = data.story;
            story.classList.remove('loading');
            if (data.statChanges) {
                showEventStats(data.statChanges, data.rewards || {});
            }
        }

        continueBtn.style.display = data.canContinue ? 'block' : 'none';
        
        GS.currentEvent = data;
        modal.classList.add('active');
    }

    function showEventStats(statChanges, rewards) {
        const container = document.getElementById('eventStats');
        const list = document.getElementById('eventStatsList');

        const items = [];
        
        const statNames = {
            stamina: '‰ΩìÂäõ', mana: 'È≠îÂäõ', mood: 'ÂøÉÊÉÖ', lewd: 'Ëâ≤ÊÉÖÂ∫¶'
        };

        for (const [stat, change] of Object.entries(statChanges)) {
            if (typeof change === 'number') {
                const name = statNames[stat] || stat;
                const className = change > 0 ? 'positive' : 'negative';
                items.push(`<span class="stat-change ${className}">${name} ${change > 0 ? '+' : ''}${change}</span>`);
            }
        }

        for (const [key, value] of Object.entries(rewards)) {
            if (key === 'qp') {
                items.push(`<span class="stat-change positive">ü™ô +${value}</span>`);
            } else if (key === 'sq') {
                items.push(`<span class="stat-change positive">üíé +${value}</span>`);
            } else {
                items.push(`<span class="stat-change positive">${key} ${value}</span>`);
            }
        }

        if (items.length > 0) {
            list.innerHTML = items.join('');
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function endEvent() {
        document.getElementById('eventModal').classList.remove('active');
        GS.currentEvent = null;
        GS.currentEventStory = '';
        updateDisplay();
        renderCharacters();
        updateSubjectDisplay();
    }

    async function continueEvent() {
        if (!GS.currentEvent || !GS.api.key) return;

        const continueBtn = document.getElementById('eventContinue');
        const originalText = continueBtn.textContent;
        continueBtn.textContent = 'ÁîüÊàê‰∏≠...';
        continueBtn.disabled = true;

        try {
            const currentStory = GS.currentEventStory;
            
            // ‰ªéÊúÄÂêé‰∏§Âè•ËØùÂºÄÂßãÁª≠ÂÜô
            const sentences = currentStory.split(/[„ÄÇÔºÅÔºü]/).filter(s => s.trim());
            const lastSentences = sentences.slice(-2).join('„ÄÇ') + '„ÄÇ';
            
            const prompt = `ÁªßÁª≠ÂÜôËøô‰∏™ÊïÖ‰∫ãÁöÑÂêéÁª≠„ÄÇ

„Äê‰πãÂâçÁöÑÊÉÖËäÇ„Äë
${lastSentences}

„ÄêÁª≠ÂÜôË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö800-1500Â≠ó
2. ‰øùÊåÅÁõ∏ÂêåÁöÑÊñáÈ£éÂíåÊ∞õÂõ¥
3. Ëá™ÁÑ∂ÁöÑÂâßÊÉÖÊé®ËøõÔºå‰∏çË¶ÅÈáçÂ§ç‰πãÂâçÁöÑÂÜÖÂÆπ
4. ${GS.currentEvent.isR18 ? 'ÂèØ‰ª•Ëøõ‰∏ÄÊ≠•ÂèëÂ±ï‰∫≤ÂØÜÊÉÖËäÇ' : 'ÁªßÁª≠Ê∏©È¶®ÁöÑ‰∫íÂä®'}
5. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Êåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ

Áõ¥Êé•ÁªßÁª≠ÂÜô„ÄÇ`;

            let continuation;
            if (GS.streamMode) {
                const storyEl = document.getElementById('eventStory');
                continuation = await callAPIStream(prompt, text => {
                    storyEl.textContent = currentStory + '\n\n' + text;
                }, 2000, GS.currentEvent.isR18);
            } else {
                continuation = await callAPI(prompt, [], 2000, GS.currentEvent.isR18);
            }

            const newStory = currentStory + '\n\n' + continuation;
            GS.currentEventStory = newStory;
            document.getElementById('eventStory').textContent = newStory;

            if (GS.currentEvent.isR18) {
                GS.stats.lewd = Math.min(100, GS.stats.lewd + 10);
                GS.stats.stamina = Math.max(0, GS.stats.stamina - 5);
            }

            advanceTimeAfterEvent(1);
            saveState();

        } catch (error) {
            console.error('ÁªßÁª≠Â§±Ë¥•:', error);
            showToast('ÁîüÊàêÂ§±Ë¥•');
        }

        continueBtn.textContent = originalText;
        continueBtn.disabled = false;
    }

    function archiveEvent(characterId, story, isR18) {
        if (!GS.eventMemories[characterId]) {
            GS.eventMemories[characterId] = [];
        }

        GS.eventMemories[characterId].push({
            date: `${GS.month}/${GS.day}`,
            period: GameData.periods[GS.period],
            location: GameData.locations[GS.currentLocation]?.name || 'Êú™Áü•',
            story: story.substring(0, 300) + '...',
            isR18: isR18,
            timestamp: Date.now()
        });

        // ÈôêÂà∂ËÆ∞ÂøÜÊï∞Èáè
        if (GS.eventMemories[characterId].length > 30) {
            GS.eventMemories[characterId].shift();
        }
    }

    async function triggerItemEffectEvent(loc, sub) {
        const effect = GS.activeItemEffect;
        GS.activeItemEffect = null;

        const chars = Object.values(GameData.characters);
        const randomChar = chars[Math.floor(Math.random() * chars.length)];

        const prompt = `Âàõ‰ΩúR18ÊÆµÂ≠ê„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- Âú∞ÁÇπÔºö${loc.name} - ${sub.name}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ‰ΩøÁî®‰∫Ü${effect.itemName}
- ÈÅáÂà∞Ôºö${randomChar.name}
- ${randomChar.prompt}

„ÄêË¶ÅÊ±Ç„Äë
Áî±‰∫é${effect.itemName}ÁöÑÊïàÊûúÔºåÂøÖÁÑ∂ÂèëÁîü‰∫≤ÂØÜ‰∫ãÊÉÖ...

1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Êåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. Áõ¥ÁôΩÁ≤ó‰øóÁöÑR18ÊèèÂÜô
4. ËØ¶ÁªÜÁöÑÊÑüÂÆòÊèèÂÜô

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `${effect.itemEmoji}${randomChar.emoji}`,
            title: `${effect.itemName}ÁöÑÊïàÊûú`,
            subtitle: randomChar.name,
            story: '',
            isR18: true,
            canContinue: true,
            characterId: randomChar.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, true);
            } else {
                story = await callAPI(prompt, [], 10000, true);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { lewd: 25, stamina: -20, mana: -20, mood: 15 };
            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[randomChar.id] = Math.min(100, (GS.affection[randomChar.id] || 50) + 18);
            archiveEvent(randomChar.id, story, true);
            advanceTimeAfterEvent(2);
            saveState();

        } catch (error) {
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    function applyStatChanges(changes) {
        for (const [stat, change] of Object.entries(changes)) {
            if (typeof change === 'number' && GS.stats[stat] !== undefined) {
                const maxKey = `max${stat.charAt(0).toUpperCase() + stat.slice(1)}`;
                GS.stats[stat] = Math.max(0, Math.min(GS.stats[maxKey] || 100, GS.stats[stat] + change));
            }
        }
        updateDisplay();
    }

    // ==================== Êó∂Èó¥Á≥ªÁªü ====================
    function advanceTime() {
        advanceTimeAfterEvent(1);
        showToast(`Êó∂Èó¥Êé®ËøõÂà∞${GameData.periods[GS.period]}`);
    }

    function advanceTimeAfterEvent(hours = 1) {
        GS.period += hours;

        while (GS.period >= GameData.periods.length) {
            GS.period -= GameData.periods.length;
            GS.day++;
            GS.weekday = (GS.weekday + 1) % 7;

            const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (GS.day > daysInMonth[GS.month - 1]) {
                GS.day = 1;
                GS.month++;
                if (GS.month > 12) GS.month = 1;

                // ÊúàÊú´Ê£ÄÊü•ÊòØÂê¶Ëß¶ÂèëÊúàËÄÉ
                checkMonthlyExam();
            }

            // ÊØèÊó•ÊÅ¢Â§ç
            GS.stats.stamina = Math.min(GS.stats.maxStamina, GS.stats.stamina + 40);
            GS.stats.mana = Math.min(GS.stats.maxMana, GS.stats.mana + 30);
            GS.stats.lewd = Math.max(0, GS.stats.lewd - 15);
            GS.stats.mood = Math.min(GS.stats.maxMood, GS.stats.mood + 10);

            // ÊØèÊó•Èõ∂Ëä±Èí±
            GS.qp += 300;
            
            // ÈöèÊú∫Â§©Ê∞î
            GS.weather = Math.floor(Math.random() * GameData.weathers.length);
            
            // ÈáçÁΩÆÊØèÊó•‰∏äËØæËÆ∞ÂΩï
            GS.todayClasses = [];
        }

        updateDisplay();
        saveState();
    }

    // ÊúàËÄÉÊ£ÄÊü•
    function checkMonthlyExam() {
        if (GS.lastExamMonth !== GS.month) {
            GS.lastExamMonth = GS.month;
            // ÂèØ‰ª•Âú®ËøôÈáåËß¶ÂèëÊúàËÄÉ‰∫ã‰ª∂
            showToast(`üìö ${GS.month}ÊúàÊúàËÄÉÂç≥Â∞ÜÂà∞Êù•ÔºÅ`);
        }
    }

    // ==================== ÊâãÊú∫Á≥ªÁªü ====================
    function openPhone() {
        document.getElementById('phoneContainer').classList.add('active');
        renderPhoneChatList();
    }

    function closePhone() {
        document.getElementById('phoneContainer').classList.remove('active');
    }

    function switchPhoneTab(tab) {
        document.querySelectorAll('.phone-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.phone-tab[data-tab="${tab}"]`).classList.add('active');

        document.getElementById('phoneChatList').style.display = tab === 'chats' ? 'block' : 'none';
        document.getElementById('phoneChatView').classList.remove('active');
        document.getElementById('phoneDatePanel').style.display = tab === 'date' ? 'block' : 'none';
        document.getElementById('phoneContacts').style.display = tab === 'contacts' ? 'block' : 'none';

        if (tab === 'date') renderDatePanel();
        if (tab === 'contacts') renderPhoneContacts();
    }

    function renderPhoneChatList() {
        const container = document.getElementById('phoneChatList');
        const chars = { ...GameData.characters, ...GS.customCharacters };

        const groups = {
            classmate: { name: 'ÂêåÂ≠¶', icon: 'üéí', chars: [] },
            teacher: { name: 'ËÄÅÂ∏à', icon: 'üë®‚Äçüè´', chars: [] },
            rich: { name: 'ÂØåË¥µ‰∫∫ÂÆ∂', icon: 'üí∞', chars: [] },
            worker: { name: 'ÊâìÂ∑•‰∫∫', icon: 'üë∑', chars: [] },
            strange: { name: 'Â•áÊÄ™ÁöÑ‰∫∫', icon: 'üîÆ', chars: [] },
            custom: { name: 'Ëá™ÂÆö‰πâËßíËâ≤', icon: '‚ú®', chars: [] }
        };

        Object.values(chars).forEach(char => {
            const category = char.isCustom ? 'custom' : char.category;
            if (groups[category]) {
                groups[category].chars.push(char);
            }
        });

        container.innerHTML = Object.entries(groups).filter(([_, g]) => g.chars.length > 0).map(([key, group]) => `
            <div class="chat-group">
                <div class="chat-group-title">${group.icon} ${group.name}</div>
                ${group.chars.map(char => {
                    const lastMsg = getLastMessage(char.id);
                    const affection = GS.affection[char.id] || 50;
                    return `
                        <div class="chat-item" onclick="openChatWith('${char.id}')">
                            <div class="chat-avatar" style="background:${char.color}">${char.emoji}</div>
                            <div class="chat-info">
                                <div class="chat-name">${char.name} <span style="font-size:10px;color:var(--primary)">üíï${affection}</span></div>
                                <div class="chat-preview">${lastMsg || char.role}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `).join('');
    }

    function getLastMessage(charId) {
        const history = GS.chatHistory[charId];
        if (history && history.length > 0) {
            const last = history[history.length - 1];
            return last.text?.substring(0, 15) + '...';
        }
        return null;
    }

    function openChatWith(charId) {
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char) return;

        document.getElementById('phoneChatList').style.display = 'none';
        document.getElementById('phoneChatView').classList.add('active');

        document.getElementById('chatViewAvatar').textContent = char.emoji;
        document.getElementById('chatViewAvatar').style.background = char.color;
        document.getElementById('chatViewName').textContent = char.name;
        document.getElementById('chatViewStatus').textContent = `üíï ${GS.affection[charId] || 50}`;

        window.currentChatChar = charId;
        renderChatMessages(charId);
    }

    function closeChatView() {
        document.getElementById('phoneChatView').classList.remove('active');
        document.getElementById('phoneChatList').style.display = 'block';
        window.currentChatChar = null;
    }

    function clearChatHistory() {
        const charId = window.currentChatChar;
        if (!charId) return;
        
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char) return;
        
        if (confirm(`Á°ÆÂÆöÊ∏ÖÁ©∫‰∏é ${char.name} ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü\n\nËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÂØπËØùÂéÜÂè≤Ôºà‰∫ã‰ª∂ËÆ∞ÂøÜ‰∏çÂèóÂΩ±ÂìçÔºâ`)) {
            GS.chatHistory[charId] = [];
            renderChatMessages(charId);
            saveState();
            showToast(`Â∑≤Ê∏ÖÁ©∫‰∏é ${char.name} ÁöÑËÅäÂ§©ËÆ∞ÂΩï`);
        }
    }

    function renderChatMessages(charId) {
        const container = document.getElementById('chatMessages');
        const history = GS.chatHistory[charId] || [];
        const char = GameData.characters[charId] || GS.customCharacters[charId];

        if (history.length === 0 && char) {
            history.push({
                senderId: charId,
                text: `‰Ω†Â•ΩÔºÅËøôÈáåÊòØ${char.name}„ÄÇ`,
                time: getTimeStr(),
                isSelf: false
            });
            GS.chatHistory[charId] = history;
            saveState();
        }

        container.innerHTML = history.map(msg => {
            const msgChar = msg.isSelf ? null : (GameData.characters[msg.senderId] || GS.customCharacters[msg.senderId]);
            
            if (msg.isSystem) {
                return `
                    <div class="message system">
                        <div class="msg-content">
                            <div class="msg-text">${msg.text}</div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="message ${msg.isSelf ? 'self' : ''}">
                    <div class="msg-avatar" style="background:${msg.isSelf ? 'var(--accent)' : msgChar?.color || 'var(--primary)'}">${msg.isSelf ? 'üë©' : msgChar?.emoji || 'üë§'}</div>
                    <div class="msg-content">
                        <div class="msg-text">${msg.text}</div>
                        <div class="msg-time">${msg.time}</div>
                    </div>
                </div>
            `;
        }).join('');

        container.scrollTop = container.scrollHeight;
    }

    function getTimeStr() {
        return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // ==================== ËÅäÂ§©ÂèëÈÄÅÂèäËΩ¨Ë¥¶ÂäüËÉΩ ====================
    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        const charId = window.currentChatChar;

        if (!text || !charId) return;
        input.value = '';

        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char) return;

        if (!GS.chatHistory[charId]) GS.chatHistory[charId] = [];
        GS.chatHistory[charId].push({
            senderId: 'player',
            text: text,
            time: getTimeStr(),
            isSelf: true
        });

        renderChatMessages(charId);
        saveState();

        // Ê£ÄÊµãË¶ÅÈí±ÂÖ≥ÈîÆËØç
        const moneyKeywords = ['Á©∑', 'Ê≤°Èí±', 'È•ø', 'ÁàÜÁÇπÈáëÂ∏Å', 'ÁªôÊàëÈí±', 'ÂÄüÈí±', 'Áº∫Èí±', 'Á†¥‰∫ß', 'ÂêÉÂúü'];
        const wantsMoney = moneyKeywords.some(k => text.includes(k));

        await generateChatResponse(charId, text, wantsMoney);
    }

    async function generateChatResponse(charId, playerText, wantsMoney = false) {
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        const targetCount = 3 + Math.floor(Math.random() * 4);

        if (GS.api.key) {
            try {
                let extraInstruction = '';
                if (wantsMoney) {
                    const isRich = char.richBonus || ['gilgamesh', 'ozymandias', 'edmond', 'takasugi', 'qinshihuang'].includes(charId);
                    if (isRich) {
                        extraInstruction = `\n\n${GS.playerName}‰ºº‰πéÂú®ÊöóÁ§∫ÈúÄË¶ÅÈí±„ÄÇ‰Ωú‰∏∫ÂØåÊúâÁöÑ${char.name}ÔºåËØ∑Âú®ÂõûÂ§ç‰∏≠Ë°®Á§∫ÊÑøÊÑèÂ∏ÆÂä©ÔºåÂπ∂ÊèêÂèä‰ºöËΩ¨Ë¥¶ÁªôÂ•π„ÄÇËØ≠Ê∞îË¶ÅÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†º„ÄÇ`;
                    } else {
                        extraInstruction = `\n\n${GS.playerName}‰ºº‰πéÂú®ÊöóÁ§∫ÈúÄË¶ÅÈí±„ÄÇ${char.name}ÂèØ‰ª•Ë°®Á§∫ÂÖ≥ÂøÉÔºå‰ΩÜ‰∏ç‰∏ÄÂÆöËÉΩÁªôÂæàÂ§öÈí±ÔºåÂèØ‰ª•ÊèêËÆÆËØ∑Â•πÂêÉÈ•≠ÊàñÈÄÅÂ∞èÁ§ºÁâ©‰πãÁ±ªÁöÑ„ÄÇ`;
                    }
                }

                const prompt = `‰Ω†ÊâÆÊºî${char.name}„ÄÇ${char.prompt}

${GS.playerName}ÔºàÂ•≥ÊÄßÔºâËØ¥Ôºö"${playerText}"${extraInstruction}

ËØ∑ÂõûÂ§ç${targetCount}Êù°Ê∂àÊÅØÔºàÊØèÊù°3-5Âè•ËØùÔºâ„ÄÇ
Ë¶ÅÊ±ÇÔºö
- ‰øùÊåÅËßíËâ≤ÊÄßÊ†º
- ÂØπËØùËá™ÁÑ∂ËøûË¥Ø
- Âè™ËæìÂá∫ÂØπËØùÂÜÖÂÆπ
- ÊØèÊù°Ê∂àÊÅØ‰∏ÄË°å

Ê†ºÂºèÔºö
"Á¨¨‰∏ÄÊù°"
"Á¨¨‰∫åÊù°"
...`;

               const chatContext = (GS.chatHistory[charId] || [])
    .slice(-20)  // ÊúÄËøë20Êù°Ê∂àÊÅØÔºàÁ∫¶10ËΩÆÂØπËØùÔºâ
    .map(msg => ({
        role: msg.isSelf ? 'user' : 'assistant',
        content: msg.text
    }));

const response = await callChatAPI(prompt, chatContext);
                const messages = parseChatResponse(response, targetCount);

                for (let i = 0; i < messages.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 300 + i * 150));

                    const msg = {
                        senderId: charId,
                        text: messages[i],
                        time: getTimeStr(),
                        isSelf: false
                    };

                    GS.chatHistory[charId].push(msg);
                    renderChatMessages(charId);
                }

                // Â§ÑÁêÜËΩ¨Ë¥¶
                if (wantsMoney) {
                    await handleTransferFromChat(charId, char);
                }

                saveState();

            } catch (error) {
                console.error('ËÅäÂ§©APIÂ§±Ë¥•:', error);
                addFallbackResponses(charId, char);
            }
        } else {
            addFallbackResponses(charId, char);
            
            if (wantsMoney) {
                await handleTransferFromChat(charId, char);
            }
        }
    }

    async function handleTransferFromChat(charId, char) {
        const isRich = char.richBonus || ['gilgamesh', 'ozymandias', 'edmond', 'takasugi', 'qinshihuang'].includes(charId);
        
        let transferAmount = { qp: 0, sq: 0 };
        
        if (isRich && char.richBonus) {
            transferAmount.qp = char.richBonus.qpMin + Math.floor(Math.random() * (char.richBonus.qpMax - char.richBonus.qpMin));
            if (Math.random() < (char.richBonus.sqChance || 0)) {
                transferAmount.sq = 1 + Math.floor(Math.random() * 3);
            }
        } else if (isRich) {
            transferAmount.qp = 500 + Math.floor(Math.random() * 1500);
            if (Math.random() < 0.1) {
                transferAmount.sq = 1;
            }
        } else {
            transferAmount.qp = 100 + Math.floor(Math.random() * 200);
        }

        if (transferAmount.qp > 0 || transferAmount.sq > 0) {
            await new Promise(resolve => setTimeout(resolve, 500));

            let transferMsg = `üí∞ ${char.name}Áªô‰Ω†ËΩ¨Ë¥¶‰∫Ü`;
            if (transferAmount.qp > 0) {
                GS.qp += transferAmount.qp;
                transferMsg += ` ü™ô${transferAmount.qp}`;
            }
            if (transferAmount.sq > 0) {
                GS.sq += transferAmount.sq;
                transferMsg += ` üíé${transferAmount.sq}`;
            }

            GS.chatHistory[charId].push({
                senderId: 'system',
                text: transferMsg,
                time: getTimeStr(),
                isSystem: true
            });

            renderChatMessages(charId);
            updateDisplay();
            saveState();
            showToast(transferMsg);
        }
    }

    // ËØ∑Ê±ÇËΩ¨Ë¥¶ÊåâÈíÆ
    async function requestTransfer() {
        const charId = window.currentChatChar;
        if (!charId) return;

        const input = document.getElementById('chatInput');
        input.value = 'ÊúÄËøëÊúâÁÇπÁ©∑ÔºåËÉΩ‰∏çËÉΩÂ∏ÆÂ∏ÆÊàë...';
        await sendChatMessage();
    }

    function parseChatResponse(response, targetCount) {
        const lines = response.split('\n').filter(l => l.trim());
        const messages = [];

        for (const line of lines) {
            let text = line.trim();
            text = text.replace(/^["„Äå„Äé"]?|["„Äç„Äè"]?$/g, '');
            text = text.replace(/^\d+[\.\„ÄÅ\:Ôºö]\s*/, '');

            if (text && text.length > 0 && text.length < 150) {
                messages.push(text);
            }

            if (messages.length >= targetCount) break;
        }

        if (messages.length < 2) {
            messages.push('ÂóØ...');
            messages.push('ÊàëÊòéÁôΩ‰∫Ü„ÄÇ');
        }

        return messages;
    }

    function addFallbackResponses(charId, char) {
        const presets = {
            mash: ['ÂâçËæàËØ¥ÂæóÂØπÂë¢ÔºÅ', 'ÊàëÊîØÊåÅÂâçËæàÔºÅ', 'ÂâçËæà‰ªäÂ§©ËæõËã¶‰∫ÜÔΩû', 'Êúâ‰ªÄ‰πàÈúÄË¶ÅÂ∏ÆÂøôÁöÑÂêóÔºü'],
            gilgamesh: ['ÂìºÔºåÁÆó‰Ω†ÊúâÁúºÂÖâ„ÄÇ', 'Êú¨ÁéãÂãâÂº∫Âê¨‰∏ÄÂê¨„ÄÇ', 'ÊùÇÁßç...', 'ÊúâË∂£„ÄÇ'],
            merlin: ['ÂëµÂëµÔΩû', 'Âæ°‰∏ªÁúüÂèØÁà±üå∏', 'ËÆ©ÊàëÊÉ≥ÊÉ≥ÔΩû', 'ÊúâÊÑèÊÄùÂë¢ÔΩû'],
            romani: ['Á´ãÈ¶ôË¶ÅÊ≥®ÊÑèË∫´‰ΩìÔºÅ', 'ÊàëÂæàÊãÖÂøÉ‰Ω†Âë¢...', 'ÊúâÁ©∫Êù•‰øùÂÅ•ÂÆ§ÂùêÂùê', 'Âà´Â§™ÂãâÂº∫Ëá™Â∑±'],
            emiya: ['...ÂóØ„ÄÇ', 'ËØ¥ÁöÑÊúâÈÅìÁêÜ„ÄÇ', 'ÊôöÈ•≠ÊÉ≥ÂêÉ‰ªÄ‰πàÔºü', 'ÁúüËÆ©‰∫∫ÊìçÂøÉ„ÄÇ']
        };

        const responses = presets[charId] || ['ÂóØÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇ', 'ËØ¥ÂæóÂØπ„ÄÇ', 'ÁªßÁª≠ËØ¥Ôºü', 'Â•ΩÁöÑ„ÄÇ'];
        const count = 2 + Math.floor(Math.random() * 3);

        for (let i = 0; i < count; i++) {
            const msg = {
                senderId: charId,
                text: responses[i % responses.length],
                time: getTimeStr(),
                isSelf: false
            };
            GS.chatHistory[charId].push(msg);
        }

        renderChatMessages(charId);
        saveState();
    }

    // ==================== ÊãúËÆø‰ªéËÄÖÂÆ∂‰∏≠ ====================
    async function visitCharacterHome() {
        const charId = window.currentChatChar;
        if (!charId) return;

        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char || !char.home) {
            showToast('Ëøô‰Ωç‰ªéËÄÖÊöÇÊó†ÂÆ∂ÂèØÊãúËÆø');
            return;
        }

        closePhone();

        const loc = GameData.locations[char.home.location];
        const isR18 = GS.r18Mode && Math.random() < 0.4;

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™ÊãúËÆø‰ªéËÄÖÂÆ∂‰∏≠ÁöÑÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâÂéª${char.name}ÂÆ∂‰∏≠ÊãúËÆø
- ${char.name}Ôºö${char.prompt}
- ‰ΩèÊâÄÔºö${char.home.description || loc?.name || '‰ªéËÄÖÁöÑ‰ΩèÂ§Ñ'}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${char.name}Áî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞Âëº
4. ÊèèÂÜôËøõÂÖ•‰ΩèÊâÄ„ÄÅ${char.name}ÁöÑÊãõÂæÖ„ÄÅ‰∏§‰∫∫ÁöÑ‰∫íÂä®
5. ${isR18 ? 'ÂèØ‰ª•ÂèëÂ±ïÊàêÊößÊòßÁöÑ‰∫≤ÂØÜÊé•Ëß¶' : 'Ê∏©È¶®ÁöÑÊó•Â∏∏‰∫§ÊµÅ'}
6. ‰ΩìÁé∞${char.name}ÁöÑÊÄßÊ†ºÁâπÁÇπÂíåÁîüÊ¥ª‰π†ÊÉØ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `üè†${char.emoji}`,
            title: `ÊãúËÆø${char.name}`,
            subtitle: char.home.description || '‰ªéËÄÖÁöÑ‰ΩèÂ§Ñ',
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: charId,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { mood: 20, stamina: -10 };
            if (isR18) {
                statChanges.lewd = 15;
                statChanges.mana = -10;
            }

            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[charId] = Math.min(100, (GS.affection[charId] || 50) + 15);
            archiveEvent(charId, story, isR18);
            advanceTimeAfterEvent(2);
            saveState();

        } catch (error) {
            console.error('ÊãúËÆø‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    // ==================== Ëá™ÂÆö‰πâËßíËâ≤Á≥ªÁªü ====================
    function openAddCharacterModal() {
        // Ê∏ÖÁ©∫Ë°®Âçï
        document.getElementById('newCharName').value = '';
        document.getElementById('newCharEmoji').value = '';
        document.getElementById('newCharRole').value = '';
        document.getElementById('newCharCategory').value = 'custom';
        document.getElementById('newCharPrompt').value = '';
        document.getElementById('newCharColor').value = '#e91e63';
        
        openModal('addCharacterModal');
    }

    function addCustomCharacter() {
        const name = document.getElementById('newCharName').value.trim();
        const emoji = document.getElementById('newCharEmoji').value.trim() || 'üë§';
        const role = document.getElementById('newCharRole').value.trim() || 'Ëá™ÂÆö‰πâËßíËâ≤';
        const category = document.getElementById('newCharCategory').value;
        const prompt = document.getElementById('newCharPrompt').value.trim();
        const color = document.getElementById('newCharColor').value;

        if (!name) {
            showToast('ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞');
            return;
        }

        if (!prompt) {
            showToast('ËØ∑ËæìÂÖ•ËßíËâ≤ËÆæÂÆö');
            return;
        }

        const charId = 'custom_' + Date.now();
        const newChar = {
            id: charId,
            name: name,
            emoji: emoji,
            color: color,
            role: role,
            category: category,
            affection: 50,
            isCustom: true,
            prompt: `‰Ω†ÊòØ${name}„ÄÇ${prompt}`,
            home: { location: 'downtown', description: `${name}ÁöÑ‰ΩèÊâÄ` }
        };

        GS.customCharacters[charId] = newChar;
        GameData.characters[charId] = newChar;
        GS.affection[charId] = 50;

        closeModal('addCharacterModal');
        renderCharacters();
        renderPhoneChatList();
        saveState();

        showToast(`‚úÖ ËßíËâ≤„Äå${name}„ÄçÊ∑ªÂä†ÊàêÂäüÔºÅ`);
    }

    function renderPhoneContacts() {
        const container = document.getElementById('phoneContacts');
        const chars = { ...GameData.characters, ...GS.customCharacters };

        container.innerHTML = `
            <div style="padding:12px">
                <button class="btn" onclick="closePhone();openAddCharacterModal()" style="margin-bottom:12px">
                    ‚ûï Ê∑ªÂä†Ëá™ÂÆö‰πâËßíËâ≤
                </button>
                ${Object.values(chars).map(char => {
                    const affection = GS.affection[char.id] || 50;
                    return `
                        <div class="chat-item" onclick="showCharacterDetail('${char.id}')">
                            <div class="chat-avatar" style="background:${char.color}">${char.emoji}</div>
                            <div class="chat-info">
                                <div class="chat-name">${char.name} ${char.isCustom ? '‚ú®' : ''}</div>
                                <div class="chat-preview">${char.role}</div>
                            </div>
                            <div style="color:var(--primary)">üíï${affection}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    // ==================== Á∫¶‰ºöÁ≥ªÁªüÔºàÁªÜÂåñÁâàÔºâ ====================
    function renderDatePanel() {
        const container = document.getElementById('phoneDatePanel');
        const chars = { ...GameData.characters, ...GS.customCharacters };
        const locs = GameData.locations;

        // Ëé∑ÂèñÂèØÁî®ÊúçË£Ö
        const availableClothing = Object.entries(GS.inventory.clothing || {}).filter(([_, count]) => count > 0);
        
        // Ëé∑ÂèñÂèØÁî®ÈÅìÂÖ∑
        const availableItems = [
            ...Object.entries(GS.inventory.gift || {}).filter(([_, count]) => count > 0),
            ...(GS.r18Mode ? Object.entries(GS.inventory.r18item || {}).filter(([_, count]) => count > 0) : [])
        ];

        // ÊûÑÂª∫ÁªÜÂåñÁöÑÁ∫¶‰ºöÂú∞ÁÇπÈÄâÈ°π
        let dateLocationOptions = '';
        Object.values(locs).forEach(loc => {
            const subLocs = loc.subLocations.map(sub => 
                `<div class="date-location ${GS.dateLocation === loc.id && GS.dateSubLocation === sub.id ? 'selected' : ''}" 
                     onclick="selectDateLocationDetailed('${loc.id}', '${sub.id}')">
                    <div class="date-location-icon">${sub.emoji}</div>
                    <div style="font-size:9px">${loc.name}</div>
                    ${sub.name}
                </div>`
            ).join('');
            dateLocationOptions += subLocs;
        });

        container.innerHTML = `
            <div class="date-section">
                <div class="date-section-title">üíï ÈÄâÊã©Á∫¶‰ºöÂØπË±°ÔºàÊúÄÂ§ö3‰∫∫Ôºâ</div>
                <div class="date-members">
                    ${Object.values(chars).map(c => `
                        <div class="date-member ${GS.dateMembers.includes(c.id) ? 'selected' : ''}" onclick="toggleDateMember('${c.id}')">
                            ${c.emoji} ${c.name}
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="date-section">
                <div class="date-section-title">üìç ÈÄâÊã©Á∫¶‰ºöÂú∞ÁÇπÔºàÁªÜÂåñÔºâ</div>
                <div class="date-locations" style="max-height:200px;overflow-y:auto">
                    ${dateLocationOptions}
                </div>
            </div>
            <div class="date-section">
                <div class="date-section-title">üëó ÈÄâÊã©ÊúçË£Ö</div>
                <div class="date-locations">
                    <div class="date-location ${!GS.dateCostume ? 'selected' : ''}" onclick="selectDateCostume(null)">
                        <div class="date-location-icon">üëï</div>
                        ‰æøË£Ö
                    </div>
                    ${availableClothing.map(([id, _]) => {
                        const item = GameData.shopItems[id];
                        if (!item) return '';
                        return `
                            <div class="date-location ${GS.dateCostume === id ? 'selected' : ''}" onclick="selectDateCostume('${id}')">
                                <div class="date-location-icon">${item.emoji}</div>
                                ${item.name}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            <div class="date-section">
                <div class="date-section-title">üéÅ Êê∫Â∏¶ÈÅìÂÖ∑ÔºàÂèØÂ§öÈÄâÔºâ</div>
                <div class="date-locations" style="max-height:150px;overflow-y:auto">
                    ${availableItems.length > 0 ? availableItems.map(([id, count]) => {
                        const item = GameData.shopItems[id];
                        if (!item) return '';
                        return `
                            <div class="date-location ${GS.dateItems.includes(id) ? 'selected' : ''}" onclick="toggleDateItem('${id}')">
                                <div class="date-location-icon">${item.emoji}</div>
                                ${item.name}(${count})
                            </div>
                        `;
                    }).join('') : '<div style="grid-column:1/-1;text-align:center;color:var(--text-dim);padding:20px">ÊöÇÊó†ÈÅìÂÖ∑</div>'}
                </div>
            </div>
            <button class="date-start-btn" onclick="startDate()">üíù ÂºÄÂßãÁ∫¶‰ºö</button>
        `;
    }

    function toggleDateMember(charId) {
        const idx = GS.dateMembers.indexOf(charId);
        if (idx >= 0) {
            GS.dateMembers.splice(idx, 1);
        } else {
            if (GS.dateMembers.length >= 3) {
                showToast('ÊúÄÂ§öÈÄâÊã©3‰∫∫');
                return;
            }
            GS.dateMembers.push(charId);
        }
        renderDatePanel();
        saveState();
    }

    function selectDateLocationDetailed(locId, subLocId) {
        GS.dateLocation = locId;
        GS.dateSubLocation = subLocId;
        renderDatePanel();
        saveState();
    }

    function selectDateCostume(costumeId) {
        GS.dateCostume = costumeId;
        renderDatePanel();
        saveState();
    }

    function toggleDateItem(itemId) {
        const idx = GS.dateItems.indexOf(itemId);
        if (idx >= 0) {
            GS.dateItems.splice(idx, 1);
        } else {
            GS.dateItems.push(itemId);
        }
        renderDatePanel();
        saveState();
    }

    async function startDate() {
        if (GS.dateMembers.length === 0) {
            showToast('ËØ∑ÈÄâÊã©Á∫¶‰ºöÂØπË±°');
            return;
        }
        if (!GS.dateLocation) {
            showToast('ËØ∑ÈÄâÊã©Á∫¶‰ºöÂú∞ÁÇπ');
            return;
        }
        if (!GS.api.key) {
            showToast('ÈúÄË¶ÅÈÖçÁΩÆAPI');
            return;
        }

        closePhone();

        const chars = GS.dateMembers.map(id => GameData.characters[id] || GS.customCharacters[id]).filter(c => c);
        const loc = GameData.locations[GS.dateLocation];
        const subLoc = loc?.subLocations.find(s => s.id === GS.dateSubLocation);
        const costume = GS.dateCostume ? GameData.shopItems[GS.dateCostume] : null;
        const items = GS.dateItems.map(id => GameData.shopItems[id]).filter(i => i);
        const isR18 = GS.r18Mode && (Math.random() < 0.5 || items.some(i => i.r18));

        const charNames = chars.map(c => c.name).join('Âíå');
        const locationDesc = subLoc ? `${loc.name}ÁöÑ${subLoc.name}` : loc.name;

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™${isR18 ? 'Êµ™Êº´‰∫≤ÂØÜ' : 'Ê∏©È¶®ÁîúËúú'}ÁöÑÁ∫¶‰ºöÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÁ∫¶‰ºöËÆæÂÆö„Äë
- Âú∞ÁÇπÔºö${locationDesc}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
${costume ? `- Á©øÁùÄÔºö${costume.name}` : '- Á©øÁùÄÔºöÊó•Â∏∏‰æøË£Ö'}
${items.length > 0 ? `- Êê∫Â∏¶ÈÅìÂÖ∑Ôºö${items.map(i => i.name).join('„ÄÅ')}` : ''}
- Á∫¶‰ºöÂØπË±°Ôºö${charNames}
${chars.map(c => `  ${c.name}Ôºö${c.prompt}`).join('\n')}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö2000-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ÊâÄÊúâ‰ªéËÄÖÁî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞ÂëºÔºåÁ¶ÅÊ≠¢Áß∞‰∏∫"‰Ω†"
4. ÁªÜËÖªÁöÑÊÑüÂÆòÊèèÂÜôÔºåÁîüÂä®ÁöÑÂØπËØù
5. ${isR18 ? 'ÂèØ‰ª•ÂåÖÂê´‰∫≤ÂØÜÊé•Ëß¶„ÄÅÊößÊòßÊèèÂÜô„ÄÅÁõ¥ÁôΩÁöÑËÇâÊ¨≤ÊèèÂÜô' : 'Ê∏©È¶®Êµ™Êº´ÁöÑÊ∞õÂõ¥'}
6. ‰ΩìÁé∞ÊØè‰∏™ËßíËâ≤ÁöÑÁã¨ÁâπÊÄßÊ†º
${items.length > 0 ? `7. Ëá™ÁÑ∂ËûçÂÖ•ÈÅìÂÖ∑ÁöÑ‰ΩøÁî®` : ''}
${costume ? `8. ÊèèÂÜô${costume.name}Â∏¶Êù•ÁöÑËßÜËßâÊïàÊûúÂíåÂèçÂ∫î` : ''}

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: chars.map(c => c.emoji).join(''),
            title: `${locationDesc}ÁöÑÁ∫¶‰ºö`,
            subtitle: charNames,
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: chars[0].id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 6000, isR18);
            } else {
                story = await callAPI(prompt, [], 6000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = {
                mood: 25,
                stamina: -15,
                lewd: isR18 ? 25 : 0
            };
            const rewards = { sq: 3 + Math.floor(Math.random() * 3) };

            showEventStats(statChanges, rewards);
            applyStatChanges(statChanges);
            
            if (rewards.sq) GS.sq += rewards.sq;

            // Â¢ûÂä†ÊâÄÊúâÁ∫¶‰ºöÂØπË±°ÁöÑÂ•ΩÊÑüÂ∫¶
            GS.dateMembers.forEach(id => {
                GS.affection[id] = Math.min(100, (GS.affection[id] || 50) + 18);
            });

            // Ê∂àËÄó‰ΩøÁî®ÁöÑÈÅìÂÖ∑
            GS.dateItems.forEach(itemId => {
                const item = GameData.shopItems[itemId];
                if (item) {
                    const cat = item.category;
                    if (GS.inventory[cat] && GS.inventory[cat][itemId]) {
                        GS.inventory[cat][itemId]--;
                        if (GS.inventory[cat][itemId] <= 0) {
                            delete GS.inventory[cat][itemId];
                        }
                    }
                }
            });

            archiveEvent(chars[0].id, story, isR18);

            // Ê∏ÖÁ©∫Á∫¶‰ºöÈÄâÊã©
            GS.dateItems = [];

            advanceTimeAfterEvent(3);
            saveState();

        } catch (error) {
            console.error('Á∫¶‰ºöÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆ';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    // ==================== ÂïÜÂ∫óÁ≥ªÁªü ====================
    function renderShop() {
        const tabs = document.getElementById('shopTabs');

        const categories = [
            { id: 'gift', name: 'üéÅ Á§ºÁâ©' },
            { id: 'clothing', name: 'üëó ÊúçË£Ö' }
        ];

        if (GS.r18Mode) {
            categories.push({ id: 'r18item', name: 'üîû R18ÈÅìÂÖ∑' });
        }

        tabs.innerHTML = categories.map((cat, i) => `
            <button class="shop-tab ${i === 0 ? 'active' : ''}" onclick="switchShopTab('${cat.id}')">${cat.name}</button>
        `).join('');

        window.currentShopTab = 'gift';
        switchShopTab('gift');
    }

    function switchShopTab(category) {
        window.currentShopTab = category;
        document.querySelectorAll('.shop-tab').forEach((t, i) => {
            t.classList.remove('active');
            if (t.textContent.includes(category === 'gift' ? 'Á§ºÁâ©' : category === 'clothing' ? 'ÊúçË£Ö' : 'R18')) {
                t.classList.add('active');
            }
        });

        const grid = document.getElementById('shopGrid');
        const items = Object.values(GameData.shopItems).filter(item => {
            if (item.category === category) {
                if (item.r18 && !GS.r18Mode) return false;
                return true;
            }
            return false;
        });

        grid.innerHTML = items.map(item => `
            <div class="shop-item ${item.r18 ? 'r18' : ''}" onclick="showShopItem('${item.id}')">
                <div class="shop-item-icon">${item.emoji}</div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">ü™ô ${item.price}</div>
            </div>
        `).join('');
    }

    function showShopItem(itemId) {
        const item = GameData.shopItems[itemId];
        if (!item) return;

        document.getElementById('itemModalTitle').textContent = item.name;
        document.getElementById('itemModalBody').innerHTML = `
            <div style="text-align:center;padding:20px">
                <div style="font-size:60px;margin-bottom:16px">${item.emoji}</div>
                <div style="font-size:18px;font-weight:bold;margin-bottom:8px">${item.name}</div>
                <div style="color:var(--accent);margin-bottom:12px">ü™ô ${item.price}</div>
                <div style="color:var(--text-dim);margin-bottom:16px;font-size:13px">${item.desc || ''}</div>
                <button class="btn" onclick="buyItem('${itemId}')" ${GS.qp < item.price ? 'disabled style="opacity:0.5"' : ''}>
                    ${GS.qp < item.price ? 'QP‰∏çË∂≥' : 'Ë¥≠‰π∞'}
                </button>
            </div>
        `;

        openModal('itemModal');
    }

    function buyItem(itemId) {
        const item = GameData.shopItems[itemId];
        if (!item || GS.qp < item.price) {
            showToast('QP‰∏çË∂≥');
            return;
        }

        GS.qp -= item.price;

        const invCategory = item.category;
        if (!GS.inventory[invCategory]) {
            GS.inventory[invCategory] = {};
        }
        GS.inventory[invCategory][itemId] = (GS.inventory[invCategory][itemId] || 0) + 1;

        closeModal('itemModal');
        updateDisplay();
        renderInventory();
        saveState();
        showToast(`Ë¥≠‰π∞‰∫Ü ${item.emoji}${item.name}`);
    }

    // ==================== ËÉåÂåÖÁ≥ªÁªü ====================
    function renderInventory() {
        const tabs = document.getElementById('inventoryTabs');

        const categories = [
            { id: 'gift', name: 'üéÅ Á§ºÁâ©' },
            { id: 'clothing', name: 'üëó Ë°£Êüú' }
        ];

        if (GS.r18Mode) {
            categories.push({ id: 'r18item', name: 'üîû R18ÈÅìÂÖ∑' });
        }

        tabs.innerHTML = categories.map((cat, i) => `
            <button class="inventory-tab ${i === 0 ? 'active' : ''}" onclick="switchInventoryTab('${cat.id}')">${cat.name}</button>
        `).join('');

        switchInventoryTab('gift');
    }

    function switchInventoryTab(category) {
        document.querySelectorAll('.inventory-tab').forEach(t => t.classList.remove('active'));
        
        const tabs = document.querySelectorAll('.inventory-tab');
        tabs.forEach(t => {
            if ((category === 'gift' && t.textContent.includes('Á§ºÁâ©')) ||
                (category === 'clothing' && t.textContent.includes('Ë°£Êüú')) ||
                (category === 'r18item' && t.textContent.includes('R18'))) {
                t.classList.add('active');
            }
        });

        const grid = document.getElementById('inventoryGrid');
        
        if (!GS.inventory[category]) {
            GS.inventory[category] = {};
        }
        
        const items = Object.entries(GS.inventory[category]).filter(([_, count]) => count > 0);

        if (items.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-dim)">ÊöÇÊó†Áâ©ÂìÅ<br><br><small>ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Âêß~</small></div>';
            return;
        }

        grid.innerHTML = items.map(([id, count]) => {
            const item = GameData.shopItems[id];
            if (!item) return '';
            return `
                <div class="inventory-slot" onclick="showInventoryItem('${id}', '${category}')">
                    <div class="inventory-icon">${item.emoji}</div>
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-count">√ó${count}</div>
                </div>
            `;
        }).join('');
    }

    function showInventoryItem(itemId, category) {
        const item = GameData.shopItems[itemId];
        const count = GS.inventory[category]?.[itemId] || 0;
        if (!item) return;

        const isClothing = category === 'clothing';
        const isR18Item = category === 'r18item';

        document.getElementById('itemModalTitle').textContent = item.name;
        document.getElementById('itemModalBody').innerHTML = `
            <div style="text-align:center;padding:16px">
                <div style="font-size:50px;margin-bottom:12px">${item.emoji}</div>
                <div style="font-size:16px;font-weight:bold;margin-bottom:6px">${item.name}</div>
                <div style="color:var(--text-dim);margin-bottom:12px">Êã•ÊúâÔºö${count}‰∏™</div>
                ${item.desc ? `<div style="color:var(--lewd);margin-bottom:16px;font-size:12px">${item.desc}</div>` : ''}
                
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${isClothing ? `
                        <button class="btn" onclick="wearClothing('${itemId}')">
                            ${GS.currentOutfit === itemId ? '‚úì Â∑≤Á©øÁùÄ' : 'üëó Á©ø‰∏ä'}
                        </button>
                    ` : ''}
                    ${isR18Item ? `
                        <button class="btn" onclick="useSelfR18Item('${itemId}')">üíó Ëá™Â∑±‰ΩøÁî®Ôºà‰∏ãÊ¨°Ëß¶Âèë‰∫ã‰ª∂Ôºâ</button>
                    ` : ''}
                    <button class="btn" onclick="openGiftTarget('${itemId}', '${category}')" style="background:var(--secondary)">üéÅ Ëµ†ÈÄÅÁªô‰ªñ‰∫∫</button>
                </div>
            </div>
        `;

        openModal('itemModal');
    }

    function wearClothing(itemId) {
        if (GS.currentOutfit === itemId) {
            GS.currentOutfit = null;
            showToast('ËÑ±‰∏ã‰∫ÜÊúçË£Ö');
        } else {
            GS.currentOutfit = itemId;
            const item = GameData.shopItems[itemId];
            showToast(`Á©ø‰∏ä‰∫Ü ${item.emoji}${item.name}`);
        }
        closeModal('itemModal');
        saveState();
    }

    function useSelfR18Item(itemId) {
        const item = GameData.shopItems[itemId];
        if (!item || !GS.inventory.r18item?.[itemId]) return;

        GS.inventory.r18item[itemId]--;
        if (GS.inventory.r18item[itemId] <= 0) {
            delete GS.inventory.r18item[itemId];
        }

        GS.activeItemEffect = {
            itemId: itemId,
            itemName: item.name,
            itemEmoji: item.emoji
        };

        closeModal('itemModal');
        renderInventory();
        saveState();

        showToast(`‰ΩøÁî®‰∫Ü ${item.emoji}${item.name}Ôºå‰∏ãÊ¨°ÂâçÂæÄÂú∞ÁÇπÊó∂Â∞ÜËß¶ÂèëÁâπÊÆä‰∫ã‰ª∂`);
    }

    function openGiftTarget(itemId, category) {
        const item = GameData.shopItems[itemId];
        const chars = { ...GameData.characters, ...GS.customCharacters };

        document.getElementById('itemModalBody').innerHTML = `
            <div style="text-align:center;margin-bottom:16px">
                <div style="font-size:36px">${item.emoji}</div>
                <div style="font-weight:bold">${item.name}</div>
            </div>
            <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px">ÈÄâÊã©Ëµ†ÈÄÅÂØπË±°Ôºö</div>
            <div style="max-height:300px;overflow-y:auto">
                ${Object.values(chars).map(c => `
                    <div class="chat-item" onclick="giftToCharacter('${itemId}', '${category}', '${c.id}')" style="padding:8px">
                        <div class="chat-avatar" style="background:${c.color};width:36px;height:36px;font-size:18px">${c.emoji}</div>
                        <div class="chat-info">
                            <div class="chat-name">${c.name}</div>
                        </div>
                        <div style="color:var(--primary);font-size:12px">üíï${GS.affection[c.id] || 50}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // ==================== Ëµ†ÈÄÅÁ§ºÁâ©Á≥ªÁªüÔºàË∞ÉÁî®APIÁîüÊàêÂâßÊÉÖÔºâ ====================
    async function giftToCharacter(itemId, category, charId) {
        const item = GameData.shopItems[itemId];
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!item || !char) return;

        // Êâ£Èô§Áâ©ÂìÅ
        if (GS.inventory[category]?.[itemId]) {
            GS.inventory[category][itemId]--;
            if (GS.inventory[category][itemId] <= 0) {
                delete GS.inventory[category][itemId];
            }
        }

        closeModal('itemModal');
        renderInventory();

        // ÁâπÊÆäÂ§ÑÁêÜËø∑ÊÉÖÂâÇ
        if (itemId === 'aphrodisiac') {
            await handleAphrodisiacGift(char);
            return;
        }

        // ÊôÆÈÄöÁ§ºÁâ©Ë∞ÉÁî®APIÁîüÊàêÂâßÊÉÖ
        if (GS.api.key) {
            await generateGiftEvent(char, item);
        } else {
            // Êó†APIÊó∂‰ΩøÁî®ÁÆÄÂçïÂõûÂ§ç
            const affectionBonus = item.r18 ? 15 : 10;
            GS.affection[charId] = Math.min(100, (GS.affection[charId] || 50) + affectionBonus);
            
            const response = getPresetGiftResponse(char);
            showToast(`${char.emoji}${char.name}Ôºö"${response}" üíï+${affectionBonus}`);
            saveState();
        }
    }

    async function generateGiftEvent(char, item) {
        const isR18 = item.r18;
        
        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™${isR18 ? 'Â∏¶ÊúâÊößÊòßÊ∞îÊ∞õ' : 'Ê∏©È¶®'}ÁöÑËµ†Á§ºÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâÈÄÅÁªô${char.name}‰∏Ä‰ª∂Á§ºÁâ©
- Á§ºÁâ©Ôºö${item.name}Ôºà${item.desc || ''}Ôºâ
- ${char.name}ÁöÑÊÄßÊ†ºÔºö${char.prompt}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${char.name}Áî®Á¨¨‰∏â‰∫∫Áß∞Áß∞Âëº
4. ÊèèÂÜô${char.name}Êî∂Âà∞Á§ºÁâ©ÁöÑÂèçÂ∫î
5. ‰∏§‰∫∫‰πãÈó¥ÁöÑ‰∫íÂä®ÂØπËØù
6. ${isR18 ? 'ÂèØ‰ª•ÂåÖÂê´ÊößÊòßÁöÑËÇ¢‰ΩìÊé•Ëß¶ÊàñÊåëÈÄó' : 'Ê∏©È¶®ÁöÑÊÑüÊÉÖ‰∫§ÊµÅ'}
7. ‰øùÊåÅËßíËâ≤ÊÄßÊ†º‰∏ÄËá¥

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `üéÅ${char.emoji}`,
            title: `Ëµ†ÈÄÅ${item.name}`,
            subtitle: `Áªô${char.name}ÁöÑÁ§ºÁâ©`,
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: char.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const affectionBonus = item.r18 ? 15 : 10;
            const statChanges = { mood: 12 };
            if (isR18) {
                statChanges.lewd = 12;
            }

            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[char.id] = Math.min(100, (GS.affection[char.id] || 50) + affectionBonus);
            
            // ÂΩíÊ°£Âà∞ËØ•ËßíËâ≤ÁöÑËÆ∞ÂøÜ‰∏≠
            archiveEvent(char.id, story, isR18);
            
            advanceTimeAfterEvent(1);
            saveState();

        } catch (error) {
            console.error('Á§ºÁâ©‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    async function handleAphrodisiacGift(char) {
        const acceptChance = (GS.affection[char.id] || 50) / 100;
        const accepted = Math.random() < acceptChance + 0.3;

        if (!accepted) {
            showToast(`${char.emoji}${char.name}ÊãíÁªù‰∫Ü...`);
            GS.inventory.r18item = GS.inventory.r18item || {};
            GS.inventory.r18item.aphrodisiac = (GS.inventory.r18item.aphrodisiac || 0) + 1;
            renderInventory();
            saveState();
            return;
        }

        if (!GS.api.key) {
            showToast(`${char.emoji}${char.name}Êé•Âèó‰∫ÜËø∑ÊÉÖÂâÇ...`);
            GS.affection[char.id] = Math.min(100, (GS.affection[char.id] || 50) + 20);
            saveState();
            return;
        }

        const prompt = `Âàõ‰ΩúR18ÊÆµÂ≠ê„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- ${char.name}Âñù‰∏ã‰∫Ü${GS.playerName}ÁªôÁöÑËø∑ÊÉÖÂâÇ
- ${char.name}Ôºö${char.prompt}

„ÄêË¶ÅÊ±Ç„Äë
ËçØÊïàÂèë‰ΩúÂêé...

1. Â≠óÊï∞Ôºö2000-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Êåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${char.name}Áî®Á¨¨‰∏â‰∫∫Áß∞Áß∞Âëº
4. Áõ¥ÁôΩÁ≤ó‰øóÁöÑR18ÊèèÂÜô
5. ËØ¶ÁªÜÁöÑÊÑüÂÆòÊèèÂÜôÔºåÊèèÂÜôËçØÊïàÂèë‰Ωú„ÄÅÂ§±Êéß„ÄÅ‰∫≤ÂØÜËøáÁ®ã

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `üíó${char.emoji}`,
            title: 'Ëø∑ÊÉÖÂâÇÁîüÊïà',
            subtitle: char.name,
            story: '',
            isR18: true,
            canContinue: true,
            characterId: char.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, true);
            } else {
                story = await callAPI(prompt, [], 10000, true);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { lewd: 30, stamina: -25, mana: -20, mood: 20 };
            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[char.id] = Math.min(100, (GS.affection[char.id] || 50) + 25);
            archiveEvent(char.id, story, true);
            advanceTimeAfterEvent(2);
            saveState();

        } catch (error) {
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    function getPresetGiftResponse(char) {
        const responses = {
            mash: 'ÂâçËæà...Ë∞¢Ë∞¢‰Ω†ÔºÅÊàë‰ºöÁèçÊÉúÁöÑÔºÅ',
            gilgamesh: 'ÂìºÔºåÁÆó‰Ω†ÊúâÁúºÂÖâ„ÄÇÊú¨ÁéãÂãâÂº∫Êî∂‰∏ã„ÄÇ',
            merlin: 'ÂìéÂëÄÔΩûÂæ°‰∏ªÁúüÊáÇÊàëÂë¢ÔΩû',
            romani: 'Á´ãÈ¶ô...Ë∞¢Ë∞¢‰Ω†ËÆ∞ÂæóÊàëÂñúÊ¨¢Ëøô‰∏™„ÄÇ',
            emiya: '...Ë∞¢Ë∞¢„ÄÇÊàë‰ºöÂ•ΩÂ•Ω‰øùÁÆ°ÁöÑ„ÄÇ',
            goetia: 'ËøôÊòØ...ÁªôÊàëÁöÑÔºüÊúâÁßçÂ•áÊÄ™ÁöÑÊÑüËßâ„ÄÇ',
            edmond: '‰Ω†ÁöÑÂøÉÊÑèÔºåÊàëÊî∂Âà∞‰∫Ü„ÄÇ',
            karna: 'ÊÑüË∞¢‰Ω†ÁöÑÂøÉÊÑè„ÄÇ'
        };
        return responses[char.id] || 'Ë∞¢Ë∞¢‰Ω†ÁöÑÁ§ºÁâ©ÔºÅ';
    }

    // ==================== ËßíËâ≤Á≥ªÁªü ====================
    function renderCharacters() {
        const filters = document.getElementById('characterFilters');

        const categories = [
            { id: 'all', name: 'ÂÖ®ÈÉ®' },
            { id: 'classmate', name: 'ÂêåÂ≠¶' },
            { id: 'teacher', name: 'ËÄÅÂ∏à' },
            { id: 'rich', name: 'ÂØåË¥µ' },
            { id: 'worker', name: 'ÊâìÂ∑•' },
            { id: 'strange', name: 'Â•áÊÄ™' },
            { id: 'custom', name: 'Ëá™ÂÆö‰πâ' }
        ];

        filters.innerHTML = categories.map((cat, i) => `
            <button class="character-filter ${i === 0 ? 'active' : ''}" onclick="filterCharacters('${cat.id}')">${cat.name}</button>
        `).join('');

        filterCharacters('all');
    }

    function filterCharacters(category) {
        document.querySelectorAll('.character-filter').forEach(f => f.classList.remove('active'));
        event?.target?.classList.add('active');

        const list = document.getElementById('characterList');
        const allChars = { ...GameData.characters, ...GS.customCharacters };
        
        const chars = Object.values(allChars).filter(c => {
            if (category === 'all') return true;
            if (category === 'custom') return c.isCustom;
            return c.category === category;
        });

        list.innerHTML = chars.map(char => {
            const affection = GS.affection[char.id] || 50;
            return `
                <div class="character-card ${char.isCustom ? 'custom' : ''}" onclick="showCharacterDetail('${char.id}')">
                    <div class="character-avatar" style="border-color:${char.color};background:${char.color}22">${char.emoji}</div>
                    <div class="character-info">
                        <div class="character-name">${char.name} ${char.isCustom ? '‚ú®' : ''}</div>
                        <div class="character-role">${char.role}</div>
                        <div class="affection-bar">
                            <div class="affection-fill" style="width:${affection}%"></div>
                        </div>
                    </div>
                    <div class="character-actions">
                        <div class="character-affection">üíï${affection}</div>
                        ${char.home ? `<button class="char-action-btn" onclick="event.stopPropagation();quickVisit('${char.id}')">üè†</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    async function quickVisit(charId) {
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char || !char.home) {
            showToast('Ëøô‰Ωç‰ªéËÄÖÊöÇÊó†ÂÆ∂ÂèØÊãúËÆø');
            return;
        }

        if (!GS.api.key) {
            showToast('ÈúÄË¶ÅÈÖçÁΩÆAPI');
            return;
        }

        const loc = GameData.locations[char.home.location];
        const isR18 = GS.r18Mode && Math.random() < 0.4;

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™ÊãúËÆø‰ªéËÄÖÂÆ∂‰∏≠ÁöÑÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâÂéª${char.name}ÂÆ∂‰∏≠ÊãúËÆø
- ${char.name}Ôºö${char.prompt}
- ‰ΩèÊâÄÔºö${char.home.description || loc?.name || '‰ªéËÄÖÁöÑ‰ΩèÂ§Ñ'}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${char.name}Áî®Á¨¨‰∏â‰∫∫Áß∞ÊàñÂêçÂ≠óÁß∞Âëº
4. ÊèèÂÜôËøõÂÖ•‰ΩèÊâÄ„ÄÅ${char.name}ÁöÑÊãõÂæÖ„ÄÅ‰∏§‰∫∫ÁöÑ‰∫íÂä®
5. ${isR18 ? 'ÂèØ‰ª•ÂèëÂ±ïÊàêÊößÊòßÁöÑ‰∫≤ÂØÜÊé•Ëß¶' : 'Ê∏©È¶®ÁöÑÊó•Â∏∏‰∫§ÊµÅ'}
6. ‰ΩìÁé∞${char.name}ÁöÑÊÄßÊ†ºÁâπÁÇπÂíåÁîüÊ¥ª‰π†ÊÉØ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `üè†${char.emoji}`,
            title: `ÊãúËÆø${char.name}`,
            subtitle: char.home.description || '‰ªéËÄÖÁöÑ‰ΩèÂ§Ñ',
            story: '',
            isR18: isR18,
            canContinue: true,
            characterId: charId,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, isR18);
            } else {
                story = await callAPI(prompt, [], 10000, isR18);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { mood: 20, stamina: -10 };
            if (isR18) {
                statChanges.lewd = 15;
                statChanges.mana = -10;
            }

            showEventStats(statChanges, {});
            applyStatChanges(statChanges);

            GS.affection[charId] = Math.min(100, (GS.affection[charId] || 50) + 15);
            archiveEvent(charId, story, isR18);
            advanceTimeAfterEvent(2);
            saveState();

        } catch (error) {
            console.error('ÊãúËÆø‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    function showCharacterDetail(charId) {
        const char = GameData.characters[charId] || GS.customCharacters[charId];
        if (!char) return;

        const affection = GS.affection[charId] || 50;
        const memories = GS.eventMemories[charId] || [];

        document.getElementById('charModalTitle').textContent = char.name;
        document.getElementById('charModalBody').innerHTML = `
            <div style="text-align:center;padding:16px">
                <div style="font-size:50px;margin-bottom:12px">${char.emoji}</div>
                <div style="font-size:18px;font-weight:bold;margin-bottom:4px">${char.name} ${char.isCustom ? '‚ú®' : ''}</div>
                <div style="color:var(--text-dim);font-size:13px;margin-bottom:12px">${char.role}</div>
                <div style="display:flex;justify-content:center;gap:16px;margin-bottom:16px">
                    <div>üíï Â•ΩÊÑüÂ∫¶Ôºö${affection}</div>
                </div>
                <div class="affection-bar" style="margin-bottom:16px">
                    <div class="affection-fill" style="width:${affection}%"></div>
                </div>
            </div>
            
            <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px">üìñ ‰∫ã‰ª∂ËÆ∞ÂøÜ (${memories.length}Êù°)</div>
            <div style="max-height:180px;overflow-y:auto;margin-bottom:16px">
                ${memories.length > 0 ? memories.slice(-8).reverse().map(m => `
                    <div style="background:var(--bg-light);border-radius:8px;padding:10px;margin-bottom:8px;font-size:12px">
                        <div style="color:var(--text-dim);margin-bottom:4px">${m.date} ${m.period} @ ${m.location || 'Êú™Áü•'} ${m.isR18 ? 'üîû' : ''}</div>
                        <div>${m.story}</div>
                    </div>
                `).join('') : '<div style="text-align:center;color:var(--text-dim);padding:20px">ÊöÇÊó†ËÆ∞ÂøÜ</div>'}
            </div>
            
            <div style="display:flex;flex-direction:column;gap:10px">
                <button class="btn" onclick="openChatWith('${charId}');closeModal('characterModal');openPhone()">üí¨ ËÅäÂ§©</button>
                ${char.home ? `<button class="btn" style="background:var(--secondary)" onclick="closeModal('characterModal');quickVisit('${charId}')">üè† ÊãúËÆø</button>` : ''}
                ${char.isCustom ? `<button class="btn" style="background:var(--danger)" onclick="deleteCustomCharacter('${charId}')">üóëÔ∏è Âà†Èô§ËßíËâ≤</button>` : ''}
            </div>
        `;

        openModal('characterModal');
    }

    function deleteCustomCharacter(charId) {
        if (!confirm(`Á°ÆÂÆöÂà†Èô§Ëá™ÂÆö‰πâËßíËâ≤ÂêóÔºüÁõ∏ÂÖ≥ËÆ∞ÂøÜ‰πü‰ºöË¢´Ê∏ÖÈô§„ÄÇ`)) return;

        delete GS.customCharacters[charId];
        delete GameData.characters[charId];
        delete GS.affection[charId];
        delete GS.eventMemories[charId];
        delete GS.chatHistory[charId];

        closeModal('characterModal');
        renderCharacters();
        renderPhoneChatList();
        saveState();
        showToast('ËßíËâ≤Â∑≤Âà†Èô§');
    }

    // ==================== ÊäΩÂç°Á≥ªÁªüÔºàSSRËß¶ÂèëÂâßÊÉÖÔºâ ====================
    function doGacha(count) {
        const cost = count === 1 ? 3 : 30;
        if (GS.sq < cost) {
            showToast(`Âú£Êô∂Áü≥‰∏çË∂≥ÔºÅÈúÄË¶Å${cost}È¢ó`);
            return;
        }

        GS.sq -= cost;
        GS.pityCount += count;

        const results = [];
        for (let i = 0; i < count; i++) {
            results.push(rollGacha());
        }

        const resultDiv = document.getElementById('gachaResult');
        resultDiv.classList.add('active');
        resultDiv.innerHTML = `
            <div style="font-size:16px;font-weight:bold;margin-bottom:16px">üéâ ÊäΩÂç°ÁªìÊûú</div>
            <div class="gacha-items">
                ${results.map(r => `
                    <div class="gacha-item ${r.rarity.toLowerCase()}">
                        <div class="gacha-item-icon">${r.emoji || 'üéÅ'}</div>
                        <div class="gacha-item-name">${r.name.substring(0, 6)}</div>
                    </div>
                `).join('')}
            </div>
        `;

        // Â§ÑÁêÜÁªìÊûú
        let ssrResult = null;
        results.forEach(r => {
            if (r.type === 'currency') {
                GS.qp += r.amount;
            } else if (r.type === 'item') {
                const itemData = GameData.shopItems[r.id];
                if (itemData) {
                    const cat = itemData.category;
                    if (!GS.inventory[cat]) GS.inventory[cat] = {};
                    GS.inventory[cat][r.id] = (GS.inventory[cat][r.id] || 0) + 1;
                }
            } else if (r.type === 'clothing') {
                if (!GS.inventory.clothing) GS.inventory.clothing = {};
                GS.inventory.clothing[r.id] = (GS.inventory.clothing[r.id] || 0) + 1;
            } else if (r.type === 'costume' && r.rarity === 'SSR') {
                ssrResult = r;
            }
        });

        const hasSSR = results.some(r => r.rarity === 'SSR');
        if (hasSSR) {
            GS.pityCount = 0;
        }

        updateDisplay();
        renderInventory();
        saveState();

        // SSRÁâπÊÆäÈÄ†ÂûãËß¶ÂèëÂâßÊÉÖ
        if (ssrResult) {
            setTimeout(() => triggerSSRCostumeEvent(ssrResult), 2000);
        }
    }

    function rollGacha() {
        const pool = GameData.gachaPool;

        // ‰øùÂ∫ïÊ£ÄÊü•
        if (GS.pityCount >= 60) {
            GS.pityCount = 0;
            const ssr = pool.ssr[Math.floor(Math.random() * pool.ssr.length)];
            return { ...ssr, rarity: 'SSR', emoji: '‚≠ê' };
        }

        const rand = Math.random();

        if (rand < 0.03) {
            const item = pool.ssr[Math.floor(Math.random() * pool.ssr.length)];
            return { ...item, rarity: 'SSR', emoji: '‚≠ê' };
        } else if (rand < 0.15) {
            const item = pool.sr[Math.floor(Math.random() * pool.sr.length)];
            return { ...item, rarity: 'SR', emoji: item.emoji || 'üéÅ' };
        } else {
            const item = pool.r[Math.floor(Math.random() * pool.r.length)];
            return { ...item, rarity: 'R', emoji: item.emoji || 'üéÅ' };
        }
    }

    async function triggerSSRCostumeEvent(ssrData) {
        const char = GameData.characters[ssrData.character];
        if (!char || !GS.api.key) {
            showToast(`üéä Ëß£ÈîÅ‰∫Ü ${ssrData.name}ÔºÅ`);
            return;
        }

        const prompt = `Âàõ‰Ωú‰∏Ä‰∏™ÁâπÊÆäÁöÑËé∑ÂèñÊÆµÂ≠êÊïÖ‰∫ã„ÄÇ

„ÄêÂú∫ÊôØËÆæÂÆö„Äë
- ${GS.playerName}Âú®ÊäΩÂç°‰∏≠Ëé∑Âæó‰∫Ü${char.name}ÁöÑÁâπÊÆäÂΩ¢ÊÄÅÔºö${ssrData.name}
- ${char.name}ÁöÑÊÄßÊ†ºÔºö${char.prompt}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö1500-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Ê∞∏ËøúÊåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${char.name}Áî®Á¨¨‰∏â‰∫∫Áß∞Áß∞Âëº
4. ÊèèÂÜô${char.name}‰ª•Ëøô‰∏™ÁâπÊÆäÈÄ†ÂûãÂá∫Áé∞
5. ${char.name}ÂØπËøô‰∏™ÈÄ†ÂûãÁöÑÂèçÂ∫î
6. ‰∏§‰∫∫‰πãÈó¥ÁöÑ‰∫íÂä®
7. ${GS.r18Mode ? 'ÂèØ‰ª•ÂåÖÂê´ÊößÊòßÁöÑÊ∞õÂõ¥' : 'Ê∏©È¶®ÁöÑÊ∞îÊ∞õ'}
8. ‰øùÊåÅËßíËâ≤ÊÄßÊ†º

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: ssrData.emoji,
            title: `‚ú® SSRËé∑ÂæóÔºÅ`,
            subtitle: `${ssrData.name}`,
            story: '',
            isR18: false,
            isSSR: true,
            canContinue: true,
            characterId: char.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 10000, GS.r18Mode);
            } else {
                story = await callAPI(prompt, [], 10000, GS.r18Mode);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const statChanges = { mood: 25 };
            showEventStats(statChanges, { sq: 5 });
            applyStatChanges(statChanges);
            GS.sq += 5;

            GS.affection[char.id] = Math.min(100, (GS.affection[char.id] || 50) + 20);
            archiveEvent(char.id, story, false);
            advanceTimeAfterEvent(1);
            saveState();

        } catch (error) {
            console.error('SSR‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    // ==================== ÁâπÂºÇÁÇπÁ≥ªÁªüÔºàÂê´Ëá™ÂÆö‰πâÔºâ ====================
    function renderSingularities() {
        const grid = document.getElementById('singularityGrid');
        const customGrid = document.getElementById('customSingularityGrid');
        
        const all = [
            ...GameData.singularities.modern,
            ...GameData.singularities.fantasy,
            ...GameData.singularities.scifi
        ];

        if (GS.r18Mode) {
            all.push(...GameData.singularities.taboo);
        }

        grid.innerHTML = all.slice(0, 10).map(s => `
            <div class="singularity-card" onclick="enterSingularity('${s.id}')">
                <div class="singularity-icon">${s.emoji}</div>
                <div class="singularity-info">
                    <div class="singularity-name">${s.name}</div>
                    <div class="singularity-desc">${s.desc || 'ÁÇπÂáªËøõÂÖ•'}</div>
                </div>
            </div>
        `).join('');

        // Ê∏≤ÊüìËá™ÂÆö‰πâÁâπÂºÇÁÇπ
        if (GS.customSingularities.length > 0) {
            customGrid.innerHTML = GS.customSingularities.map((s, idx) => `
                <div class="singularity-card custom" onclick="enterCustomSingularity(${idx})">
                    <div class="singularity-icon">${s.emoji}</div>
                    <div class="singularity-info">
                        <div class="singularity-name">${s.name}</div>
                        <div class="singularity-desc">${s.characters.length}‰ΩçËßíËâ≤ÂèÇ‰∏é</div>
                    </div>
                    <button style="background:var(--danger);border:none;color:white;padding:4px 8px;border-radius:8px;font-size:10px" onclick="event.stopPropagation();deleteCustomSingularity(${idx})">√ó</button>
                </div>
            `).join('');
        } else {
            customGrid.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:20px">ÊöÇÊó†Ëá™ÂÆö‰πâÁâπÂºÇÁÇπ<br><small>ÁÇπÂáª‰∏äÊñπ"Ëá™ÂÆö‰πâ"ÂàõÂª∫</small></div>';
        }
    }

    function openCustomSingularityModal() {
        // Ê∏≤ÊüìËßíËâ≤ÈÄâÊã©
        const chars = { ...GameData.characters, ...GS.customCharacters };
        const charSelect = document.getElementById('singCharacterSelect');
        charSelect.innerHTML = Object.values(chars).map(c => `
            <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer">
                <input type="checkbox" class="sing-char-checkbox" value="${c.id}">
                <span>${c.emoji} ${c.name}</span>
            </label>
        `).join('');

        document.getElementById('newSingName').value = '';
        document.getElementById('newSingEmoji').value = '';
        document.getElementById('newSingPrompt').value = '';

        openModal('customSingularityModal');
    }

    function createCustomSingularity() {
        const name = document.getElementById('newSingName').value.trim();
        const emoji = document.getElementById('newSingEmoji').value.trim() || 'üåÄ';
        const prompt = document.getElementById('newSingPrompt').value.trim();
        
        const selectedChars = [];
        document.querySelectorAll('.sing-char-checkbox:checked').forEach(cb => {
            selectedChars.push(cb.value);
        });

        if (!name) {
            showToast('ËØ∑ËæìÂÖ•ÁâπÂºÇÁÇπÂêçÁß∞');
            return;
        }
        if (selectedChars.length === 0) {
            showToast('ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰ΩçËßíËâ≤');
            return;
        }
        if (!prompt) {
            showToast('ËØ∑ËæìÂÖ•ÁâπÂºÇÁÇπËÆæÂÆö');
            return;
        }

        GS.customSingularities.push({
            name: name,
            emoji: emoji,
            prompt: prompt,
            characters: selectedChars
        });

        closeModal('customSingularityModal');
        renderSingularities();
        saveState();
        showToast(`‚úÖ ÁâπÂºÇÁÇπ„Äå${name}„ÄçÂàõÂª∫ÊàêÂäüÔºÅ`);
    }

    function deleteCustomSingularity(idx) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™Ëá™ÂÆö‰πâÁâπÂºÇÁÇπÂêóÔºü')) return;
        GS.customSingularities.splice(idx, 1);
        renderSingularities();
        saveState();
        showToast('Â∑≤Âà†Èô§');
    }

    function enterRandomSingularity() {
        const allSingularities = [
            ...GameData.singularities.modern,
            ...GameData.singularities.fantasy,
            ...GameData.singularities.scifi
        ];

        if (GS.r18Mode) {
            allSingularities.push(...GameData.singularities.taboo);
        }

        const random = allSingularities[Math.floor(Math.random() * allSingularities.length)];
        enterSingularity(random.id);
    }

    async function enterSingularity(singularityId) {
        if (!GS.api.key) {
            showToast('ÈúÄË¶ÅÈÖçÁΩÆAPI');
            return;
        }

        const allSingularities = [
            ...GameData.singularities.modern,
            ...GameData.singularities.fantasy,
            ...GameData.singularities.scifi,
            ...GameData.singularities.taboo
        ];

        const singularity = allSingularities.find(s => s.id === singularityId);
        if (!singularity) return;

        const chars = Object.values(GameData.characters);
        const randomChar = chars[Math.floor(Math.random() * chars.length)];

        const prompt = `Âàõ‰ΩúR18ÁâπÂºÇÁÇπÊÆµÂ≠ê„ÄÇ

„ÄêÁâπÂºÇÁÇπËÆæÂÆö„Äë
- ÁâπÂºÇÁÇπÔºö${singularity.name}
- ÊèèËø∞Ôºö${singularity.desc || 'ÁâπÊÆäÂπ≥Ë°å‰∏ñÁïå'}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâÂàöËøõÂÖ•Ëøô‰∏™‰∏ñÁïå
- ÈÅáÂà∞Ôºö${randomChar.name}Ôºà${randomChar.prompt}Ôºâ

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö2000-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Êåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ${randomChar.name}Áî®Á¨¨‰∏â‰∫∫Áß∞Áß∞Âëº
4. ÊèèÂÜôËøô‰∏™ÁâπÂºÇÁÇπÁöÑÁã¨ÁâπËßÑÂàô
5. ‰∏é${randomChar.name}ÁöÑÁõ∏ÈÅáÂíå‰∫íÂä®
6. Áõ¥ÁôΩÁ≤ó‰øóÁöÑR18ÂÜÖÂÆπ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: `${singularity.emoji}${randomChar.emoji}`,
            title: `ÁâπÂºÇÁÇπÔºö${singularity.name}`,
            subtitle: randomChar.name,
            story: '',
            isR18: true,
            canContinue: true,
            characterId: randomChar.id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 6000, true);
            } else {
                story = await callAPI(prompt, [], 6000, true);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const rewards = {
                qp: 1000 + Math.floor(Math.random() * 2000),
                sq: 3 + Math.floor(Math.random() * 5)
            };

            showEventStats({ mood: 15, stamina: -20, lewd: 20 }, rewards);
            GS.qp += rewards.qp;
            GS.sq += rewards.sq;
            GS.affection[randomChar.id] = Math.min(100, (GS.affection[randomChar.id] || 50) + 12);

            archiveEvent(randomChar.id, story, true);
            advanceTimeAfterEvent(3);
            saveState();

        } catch (error) {
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    async function enterCustomSingularity(idx) {
        const singularity = GS.customSingularities[idx];
        if (!singularity || !GS.api.key) {
            showToast('ÈúÄË¶ÅÈÖçÁΩÆAPI');
            return;
        }

        // ‰ªéÈÄâÂÆöËßíËâ≤‰∏≠ÈöèÊú∫ÈÄâÊã©
        const selectedChars = singularity.characters.map(id => 
            GameData.characters[id] || GS.customCharacters[id]
        ).filter(c => c);

        if (selectedChars.length === 0) {
            showToast('Ê≤°ÊúâÂèØÁî®ËßíËâ≤');
            return;
        }

        const charNames = selectedChars.map(c => c.name).join('„ÄÅ');

        const prompt = `Âàõ‰ΩúR18ÁâπÂºÇÁÇπÊÆµÂ≠ê„ÄÇ

„ÄêËá™ÂÆö‰πâÁâπÂºÇÁÇπËÆæÂÆö„Äë
- ÁâπÂºÇÁÇπÔºö${singularity.name}
- ‰∏ñÁïåËßÑÂàôÔºö${singularity.prompt}
- ‰∏ªËßíÔºö${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
- ÂèÇ‰∏éËßíËâ≤Ôºö${charNames}
${selectedChars.map(c => `  ${c.name}Ôºö${c.prompt}`).join('\n')}

„ÄêÂàõ‰ΩúË¶ÅÊ±Ç„Äë
1. Â≠óÊï∞Ôºö2000-10000Â≠ó
2. Á¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºå"‰Ω†"Êåá‰ª£${GS.playerName}ÔºàÂ•≥ÊÄßÔºâ
3. ÊâÄÊúâ‰ªéËÄÖÁî®Á¨¨‰∏â‰∫∫Áß∞Áß∞Âëº
4. ÊåâÁÖßËÆæÂÆöÁöÑ‰∏ñÁïåËßÑÂàôÂ±ïÂºÄÂâßÊÉÖ
5. ‰∏éÈÄâÂÆöËßíËâ≤‰ª¨ÁöÑ‰∫íÂä®
6. Áõ¥ÁôΩÁ≤ó‰øóÁöÑR18ÂÜÖÂÆπ

Áõ¥Êé•ÂÜôÊïÖ‰∫ã„ÄÇ`;

        showEventModal({
            icon: singularity.emoji,
            title: `Ëá™ÂÆö‰πâÔºö${singularity.name}`,
            subtitle: charNames,
            story: '',
            isR18: true,
            canContinue: true,
            characterId: selectedChars[0].id,
            isLoading: true
        });

        try {
            let story;
            if (GS.streamMode) {
                story = await callAPIStream(prompt, text => {
                    document.getElementById('eventStory').textContent = text;
                }, 6000, true);
            } else {
                story = await callAPI(prompt, [], 6000, true);
            }

            GS.currentEventStory = story;
            document.getElementById('eventStory').textContent = story;
            document.getElementById('eventStory').classList.remove('loading');

            const rewards = {
                qp: 1500 + Math.floor(Math.random() * 2500),
                sq: 5 + Math.floor(Math.random() * 5)
            };

            showEventStats({ mood: 20, stamina: -25, lewd: 25 }, rewards);
            GS.qp += rewards.qp;
            GS.sq += rewards.sq;

            selectedChars.forEach(c => {
                GS.affection[c.id] = Math.min(100, (GS.affection[c.id] || 50) + 15);
            });

            archiveEvent(selectedChars[0].id, story, true);
            advanceTimeAfterEvent(3);
            saveState();

        } catch (error) {
            document.getElementById('eventStory').textContent = 'ÁîüÊàêÂ§±Ë¥•';
            document.getElementById('eventStory').classList.remove('loading');
        }
    }

    // ==================== Â≠òÊ°£Á≥ªÁªü ====================
    function renderSaveSlots() {
        const container = document.getElementById('saveSlots');

        while (GS.saves.length < 5) {
            GS.saves.push(null);
        }

        container.innerHTML = GS.saves.map((save, i) => {
            if (save) {
                return `
                    <div class="setting-item">
                        <div>
                            <div style="font-size:13px;font-weight:bold">${save.name}</div>
                            <div style="font-size:11px;color:var(--text-dim)">${save.date} |${save.month}Êúà${save.day}Êó• ${GameData.weekdays[save.weekday] || ''}</div>
                        </div>
                        <div style="display:flex;gap:6px">
                            <button class="btn" style="padding:6px 10px;font-size:11px;width:auto" onclick="loadSave(${i})">ËØªÂèñ</button>
                            <button class="btn" style="padding:6px 10px;font-size:11px;background:var(--danger);width:auto" onclick="deleteSave(${i})">Âà†Èô§</button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="setting-item" onclick="createSaveAt(${i})" style="cursor:pointer">
                        <div style="color:var(--text-dim)">üìÅ Á©∫Â≠òÊ°£‰Ωç ${i + 1}</div>
                        <div style="color:var(--text-dim);font-size:11px">ÁÇπÂáª‰øùÂ≠ò</div>
                    </div>
                `;
            }
        }).join('');
    }

    function createSave() {
        const emptySlot = GS.saves.findIndex(s => s === null);
        if (emptySlot >= 0) {
            createSaveAt(emptySlot);
        } else {
            showToast('Â≠òÊ°£ÊßΩÂ∑≤Êª°ÔºåËØ∑ÂÖàÂà†Èô§ÊóßÂ≠òÊ°£');
        }
    }

    function createSaveAt(index) {
        const name = prompt('ËæìÂÖ•Â≠òÊ°£ÂêçÁß∞Ôºö', `Â≠òÊ°£ ${index + 1} - ${GS.month}Êúà${GS.day}Êó•`);
        if (name === null) return;

        GS.saves[index] = {
            name: name || `Â≠òÊ°£ ${index + 1}`,
            date: new Date().toLocaleString('zh-CN'),
            day: GS.day,
            month: GS.month,
            weekday: GS.weekday,
            data: JSON.parse(JSON.stringify(GS))
        };

        renderSaveSlots();
        saveState();
        showToast('‚úÖ Â≠òÊ°£ÊàêÂäü');
    }

    function loadSave(index) {
        const save = GS.saves[index];
        if (!save?.data) return;

        if (!confirm('Á°ÆÂÆöËØªÂèñÊ≠§Â≠òÊ°£ÔºüÂΩìÂâçËøõÂ∫¶Â∞Ü‰∏¢Â§±„ÄÇ')) return;

        const savedSaves = GS.saves;
        const savedApi = GS.api;
        const savedWorldbook = GS.worldbook;
        
        GS = deepMerge(GS, save.data);
        GS.saves = savedSaves;
        GS.api = savedApi;
        GS.worldbook = savedWorldbook;

        // ÈáçÊñ∞ÂêàÂπ∂Ëá™ÂÆö‰πâËßíËâ≤
        Object.keys(GS.customCharacters).forEach(id => {
            GameData.characters[id] = GS.customCharacters[id];
        });

        renderAll();
        updateR18Display();
        saveState();
        showToast('‚úÖ ËØªÂèñÊàêÂäü');
    }

    function deleteSave(index) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Â≠òÊ°£Ôºü')) return;
        GS.saves[index] = null;
        renderSaveSlots();
        saveState();
        showToast('Â∑≤Âà†Èô§');
    }

    function resetGame() {
        if (!confirm('‚ö†Ô∏è Á°ÆÂÆöÈáçÁΩÆÊ∏∏ÊàèÔºüÊâÄÊúâËøõÂ∫¶Â∞Ü‰∏¢Â§±ÔºÅ')) return;
        if (!confirm('‚ö†Ô∏è‚ö†Ô∏è ÁúüÁöÑÁ°ÆÂÆöÂêóÔºüËøôÊòØ‰∏çÂèØÈÄÜÁöÑÊìç‰ΩúÔºÅ')) return;

        localStorage.removeItem('fgo_game_v4');
        localStorage.removeItem('fgo_lastDay');
        location.reload();
    }

    // ==================== ÂêØÂä®ÂáΩÊï∞ ====================
    document.addEventListener('DOMContentLoaded', init);

        // Ê≥®ÂÜå Service WorkerÔºàPWAÁ¶ªÁ∫øÊîØÊåÅÔºâ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/fgo-daily/sw.js', { scope: '/fgo-daily/' })
                    .then(reg => {
                        console.log('‚úÖ PWAÂ∑≤Ê≥®ÂÜå:', reg.scope);
                    })
                    .catch(err => {
                        console.error('‚ö†Ô∏è PWAÊ≥®ÂÜåÂ§±Ë¥•:', err);
                    });
            });
        }
    </script>

</body>
</html>


